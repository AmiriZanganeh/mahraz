<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مَهراز سیستم</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2c5aa0;
            --primary-light: #4a76c4;
            --primary-dark: #1a3d7a;
            --secondary: #6c757d;
            --light: #f8f9fa;
            --dark: #212529;
            --border: #dee2e6;
            --card-bg: #FFFFFF;
            --sidebar-bg: #343a40;
            --header-bg: #FFFFFF;
            --success: #28a745;
            --success-light: #34ce57;
            --success-dark: #218838;
            --danger: #dc3545;
            --danger-light: #e4606d;
            --danger-dark: #c82333;
            --warning: #ffc107;
            --warning-light: #ffce3a;
            --warning-dark: #e0a800;
            --info: #17a2b8;
            --info-light: #3ab4c8;
            --info-dark: #138496;
            --sidebar-width: 250px;
            --border-radius: 8px;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --transition: all 0.2s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Vazirmatn', 'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* صفحه ورود */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 40px 30px;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .brand {
            text-align: center;
            margin-bottom: 30px;
        }

        .brand-icon {
            width: 70px;
            height: 70px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            color: white;
            font-size: 1.8rem;
        }

        .brand-name {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .brand-tagline {
            color: var(--secondary);
            font-size: 0.9rem;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .input-field {
            width: 100%;
            padding: 12px 15px;
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            font-size: 1rem;
            color: var(--dark);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
        }

        .input-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary);
        }

        .input-with-icon {
            position: relative;
        }

        .input-with-icon .input-field {
            padding-left: 45px;
        }

        /* استایل جدید برای دکمه‌ها */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.3);
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            box-shadow: 0 4px 12px rgba(44, 90, 160, 0.3);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: var(--success-dark);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: var(--danger-dark);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        .btn-warning {
            background-color: var(--warning);
            color: #212529;
        }

        .btn-warning:hover {
            background-color: var(--warning-dark);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }

        .btn-info {
            background-color: var(--info);
            color: white;
        }

        .btn-info:hover {
            background-color: var(--info-dark);
            box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background-color: var(--primary);
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .btn-lg {
            padding: 16px 28px;
            font-size: 1.1rem;
        }

        .btn-block {
            width: 100%;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-loading {
            position: relative;
            color: transparent !important;
        }

        .btn-loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .login-btn {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin-top: 10px;
            transition: var(--transition);
        }

        .login-btn:hover {
            background: var(--primary-dark);
            box-shadow: 0 4px 12px rgba(44, 90, 160, 0.3);
        }

        .error-message {
            color: var(--danger);
            text-align: center;
            margin-top: 15px;
            font-size: 0.9rem;
            display: none;
            background: rgba(220, 53, 69, 0.05);
            padding: 10px;
            border-radius: var(--border-radius);
            border-right: 3px solid var(--danger);
        }

        /* صفحه اصلی */
        #main-app {
            display: none;
        }

        .app-layout {
            display: flex;
            min-height: 100vh;
        }

        /* نوار کناری */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            color: white;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .app-logo-icon {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .app-logo-text {
            font-size: 1.1rem;
            font-weight: 700;
            color: white;
        }

        .dashboard-btn {
            background: transparent;
            color: rgba(255, 255, 255, 0.8);
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 5px;
            border-radius: 4px;
            transition: var(--transition);
        }

        .dashboard-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .sidebar-nav {
            flex: 1;
            padding: 20px 0;
        }

        .nav-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.95rem;
            margin: 2px 0;
            transition: var(--transition);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-right: 3px solid var(--primary);
        }

        .nav-item:hover:not(.active) {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }

        /* محتوای اصلی */
        .main-content {
            flex: 1;
            padding: 0;
            overflow-y: auto;
            background: var(--light);
        }

        .content-header {
            background: var(--header-bg);
            padding: 20px 30px;
            border-bottom: 1px solid var(--border);
        }

        .page-title {
            font-size: 1.3rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            color: var(--dark);
        }

        .page-description {
            font-size: 0.85rem;
            color: var(--secondary);
        }

        .content-body {
            padding: 20px 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .content-body {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .card-title {
            font-size: 1.1rem;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .card-title i {
            color: var(--primary);
        }

        select, textarea, input {
            width: 100%;
            padding: 10px 12px;
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            color: var(--dark);
        }

        select:focus, textarea:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .transaction-list, .documents-list, .accounts-list, .parties-list, .journal-list, .invoices-list, .inventory-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            padding: 10px;
            background: var(--light);
        }

        .transaction-item, .document-item, .account-item, .party-item, .journal-item, .invoice-item, .inventory-item {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .transaction-item:hover, .document-item:hover, .account-item:hover, .party-item:hover, .journal-item:hover, .invoice-item:hover, .inventory-item:hover {
            background: white;
        }

        .transaction-item:last-child, .document-item:last-child, .account-item:last-child, .party-item:last-child, .journal-item:last-child, .invoice-item:last-child, .inventory-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .empty-state {
            text-align: center;
            padding: 20px;
            color: var(--secondary);
        }

        .empty-state i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #adb5bd;
        }

        .empty-state p {
            font-size: 0.85rem;
        }

        .hidden {
            display: none;
        }

        /* استایل مبلغ */
        .amount-input-container {
            position: relative;
        }

        .amount-input {
            padding-left: 35px !important;
        }

        .currency-symbol {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary);
            font-weight: 600;
        }

        /* استایل دکمه‌های اسناد */
        .document-actions {
            display: flex;
            gap: 5px;
        }

        .document-action-btn {
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
            border: none;
            cursor: pointer;
            transition: var(--transition);
        }

        .document-action-btn.view {
            background: var(--success);
            color: white;
        }

        .document-action-btn.view:hover {
            background: var(--success-dark);
        }

        .document-action-btn.delete {
            background: var(--danger);
            color: white;
        }

        .document-action-btn.delete:hover {
            background: var(--danger-dark);
        }

        .document-action-btn.print {
            background: var(--info);
            color: white;
        }

        .document-action-btn.print:hover {
            background: var(--info-dark);
        }

        .document-action-btn i {
            font-size: 0.8rem;
        }

        /* استایل‌های جدید برای طراحی خلاق */
        .document-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
        }

        .document-info {
            flex: 1;
        }

        .document-title {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--dark);
            margin-bottom: 4px;
        }

        .document-meta {
            display: flex;
            gap: 10px;
            font-size: 0.75rem;
            color: var(--secondary);
        }

        .document-meta-item {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .document-meta-item i {
            font-size: 0.7rem;
        }

        /* استایل‌های جدید برای فرم‌ها */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.85rem;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            color: var(--dark);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
        }

        /* استایل‌های جدید برای سند حسابداری */
        .accounting-document {
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
            border: 1px solid var(--border);
        }

        .document-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .document-title {
            font-size: 1.1rem;
            color: var(--primary);
            margin-bottom: 3px;
        }

        .document-date {
            color: var(--secondary);
            font-size: 0.8rem;
        }

        /* استایل‌های جدید برای جداول */
        .accounting-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
            font-size: 0.8rem;
        }

        .accounting-table th {
            background: var(--primary);
            color: white;
            padding: 8px;
            text-align: right;
            border: 1px solid var(--border);
        }

        .accounting-table td {
            padding: 6px;
            border: 1px solid var(--border);
            text-align: right;
        }

        .document-description {
            margin-top: 15px;
            padding: 10px;
            background: rgba(44, 90, 160, 0.05);
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
        }

        .description-title {
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--dark);
            font-size: 0.85rem;
        }

        .description-content {
            color: var(--secondary);
            line-height: 1.5;
            font-size: 0.8rem;
        }

        /* استایل‌های جدید برای بخش آمار */
        .account-stat {
            background: white;
            border-radius: var(--border-radius);
            padding: 12px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .account-stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            margin: 5px 0;
            color: var(--dark);
        }

        .account-stat-label {
            color: var(--secondary);
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .account-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        /* استایل‌های جدید برای تراز آزمایشی دوستون */
        .trial-balance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            border-radius: var(--border-radius);
            overflow: hidden;
            font-size: 0.8rem;
        }

        .trial-balance-table th {
            background: var(--primary);
            color: white;
            padding: 8px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .trial-balance-table td {
            padding: 6px;
            border: 1px solid var(--border);
            text-align: center;
        }

        /* استایل‌های جدید برای دفترکل */
        .ledger-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .ledger-table-container {
            width: 100%;
            overflow-x: auto;
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
        }

        .ledger-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
            font-size: 0.8rem;
        }

        .ledger-table th {
            background: var(--primary);
            color: white;
            padding: 8px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .ledger-table td {
            padding: 6px;
            border: 1px solid var(--border);
            text-align: center;
        }

        /* استایل‌های جدید برای دفتر روزنامه */
        .journal-table-container {
            width: 100%;
            overflow-x: auto;
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
        }

        .journal-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
            font-size: 0.75rem;
        }

        .journal-table th {
            background: var(--primary);
            color: white;
            padding: 6px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .journal-table td {
            padding: 5px;
            border: 1px solid var(--border);
            text-align: center;
        }

        /* استایل‌های جدید برای پشتیبان‌گیری */
        .backup-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        /* استایل‌های جدید برای انتخاب نوع فرم */
        .form-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        .form-type-btn {
            flex: 1;
            padding: 10px 15px;
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
            transition: var(--transition);
        }

        .form-type-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .form-type-btn:hover:not(.active) {
            background: rgba(44, 90, 160, 0.1);
            border-color: var(--primary);
        }

        /* استایل‌های جدید برای فرم سند دستی */
        .manual-document-form {
            display: none;
        }

        .manual-transaction-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: flex-end;
        }

        .manual-transaction-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .remove-transaction-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .remove-transaction-btn:hover {
            background: var(--danger-dark);
        }

        .add-transaction-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-weight: 600;
            margin-top: 5px;
            transition: var(--transition);
        }

        .add-transaction-btn:hover {
            background: var(--success-dark);
        }

        /* استایل‌های جدید برای داشبورد مدیریتی */
        .dashboard-container {
            padding: 15px;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .dashboard-stat {
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .dashboard-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 10px 0;
            color: var(--primary);
        }

        .dashboard-stat-label {
            color: var(--secondary);
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* استایل‌های جدید برای حقوق و دستمزد */
        .salary-base-form, .salary-monthly-form, .account-group-form, .fiscal-period-form, .company-info-form, .party-form, .inventory-form, .invoice-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .salary-base-form .form-group, .salary-monthly-form .form-group, .account-group-form .form-group, .fiscal-period-form .form-group, .company-info-form .form-group, .party-form .form-group, .inventory-form .form-group, .invoice-form .form-group {
            margin-bottom: 0;
        }

        .salary-employees-list, .parties-list, .inventory-list {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            padding: 10px;
            background: var(--light);
            margin-top: 10px;
        }

        .salary-employee-item, .party-item, .inventory-item {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .salary-employee-item:hover, .party-item:hover, .inventory-item:hover {
            background: white;
        }

        .salary-employee-item:last-child, .party-item:last-child, .inventory-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .salary-employee-details {
            flex: 1;
        }

        .salary-employee-name {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--dark);
            margin-bottom: 3px;
        }

        .salary-employee-info {
            display: flex;
            gap: 10px;
            font-size: 0.75rem;
            color: var(--secondary);
        }

        .salary-employee-actions {
            display: flex;
            gap: 5px;
        }

        /* استایل‌های جدید برای سود و زیان */
        .profit-loss-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            border-radius: var(--border-radius);
            overflow: hidden;
            font-size: 0.8rem;
        }

        .profit-loss-table th {
            background: var(--primary);
            color: white;
            padding: 8px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .profit-loss-table td {
            padding: 6px;
            border: 1px solid var(--border);
            text-align: center;
        }

        /* استایل‌های جدید برای ترازنامه */
        .balance-sheet-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            border-radius: var(--border-radius);
            overflow: hidden;
            font-size: 0.8rem;
        }

        .balance-sheet-table th {
            background: var(--primary);
            color: white;
            padding: 8px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .balance-sheet-table td {
            padding: 6px;
            border: 1px solid var(--border);
            text-align: center;
        }

        /* استایل‌های جدید برای بخش فاکتور */
        .invoice-items-container {
            margin-top: 15px;
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            padding: 10px;
            background: var(--light);
            max-height: 200px;
            overflow-y: auto;
        }

        .invoice-item-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 5px;
            background: white;
            border-radius: 4px;
        }

        .invoice-item-display:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .invoice-item-info {
            flex: 1;
        }

        .invoice-item-name {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--dark);
        }

        .invoice-item-details {
            display: flex;
            gap: 10px;
            font-size: 0.75rem;
            color: var(--secondary);
            margin-top: 3px;
        }

        .invoice-item-actions {
            display: flex;
            gap: 5px;
        }

        .invoice-preview {
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
            border: 1px solid var(--border);
            margin-top: 15px;
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .invoice-company-info {
            text-align: right;
        }

        .invoice-title {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        .invoice-table th {
            background: var(--primary);
            color: white;
            padding: 8px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .invoice-table td {
            padding: 6px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .invoice-total {
            text-align: left;
            font-weight: 700;
            font-size: 1rem;
            margin-top: 15px;
        }

        .invoice-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .invoice-signature {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        /* استایل‌های جدید برای دفتر معین */
        .subsidiary-ledger-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .subsidiary-ledger-table-container {
            width: 100%;
            overflow-x: auto;
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
        }
        
        .subsidiary-ledger-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
            font-size: 0.8rem;
        }
        
        .subsidiary-ledger-table th {
            background: var(--primary);
            color: white;
            padding: 8px;
            text-align: center;
            border: 1px solid var(--border);
        }
        
        .subsidiary-ledger-table td {
            padding: 6px;
            border: 1px solid var(--border);
            text-align: center;
        }

        /* ریسپانسیو */
        @media (max-width: 768px) {
            .app-layout {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
            }

            .sidebar-header {
                padding: 15px;
            }

            .app-logo-text {
                font-size: 1rem;
            }

            .sidebar-nav {
                display: flex;
                justify-content: space-around;
                padding: 10px 0;
                overflow-x: auto;
            }

            .nav-item {
                flex-direction: column;
                padding: 8px 10px;
                margin: 0 2px;
                text-align: center;
                min-width: 60px;
                gap: 5px;
            }

            .nav-item-text {
                font-size: 0.7rem;
            }

            .nav-item i {
                font-size: 1rem;
                margin-bottom: 0;
            }

            .main-content {
                padding: 0;
            }

            .content-header {
                padding: 15px;
            }

            .content-body {
                padding: 15px;
                grid-template-columns: 1fr;
            }

            .salary-base-form, .salary-monthly-form, .account-group-form, .fiscal-period-form, .company-info-form, .party-form, .inventory-form, .invoice-form {
                grid-template-columns: 1fr;
            }

            .manual-transaction-row {
                flex-direction: column;
                align-items: stretch;
            }

            .backup-actions {
                flex-direction: column;
            }

            .backup-actions .btn {
                width: 100%;
            }

            .dashboard-stats {
                grid-template-columns: 1fr;
            }

            .form-type-selector {
                flex-direction: column;
            }

            .invoice-header, .invoice-details, .invoice-footer {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* نمایش متن در حالت بزرگتر */
        @media (min-width: 769px) {
            .nav-item-text {
                display: block;
            }
        }

        /* اسکرول بار سفارشی */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #F1F1F1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        /* استایل‌های جدید برای بخش فاکتور */
        .invoice-tax-discount-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .invoice-total-section {
            margin-top: 15px;
            padding: 10px;
            background: rgba(44, 90, 160, 0.05);
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
        }
        
        .invoice-total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .invoice-total-label {
            font-weight: 600;
        }
        
        .invoice-total-value {
            font-weight: 700;
            font-size: 1rem;
        }
        
        .invoice-grand-total {
            border-top: 1px solid var(--border);
            padding-top: 8px;
            margin-top: 8px;
        }

        .footer {
            text-align: center;
            padding: 15px;
            background: var(--sidebar-bg);
            color: white;
            margin-top: 20px;
            font-size: 0.8rem;
        }

        .footer a {
            color: var(--primary-light);
            text-decoration: none;
            font-weight: 600;
        }

        .footer a:hover {
            text-decoration: underline;
        }
        
        /* استایل‌های جدید برای جداسازی بخش‌ها */
        .section-divider {
            height: 1px;
            background: var(--border);
            margin: 25px 0;
            position: relative;
        }
        
        .section-divider::after {
            content: "";
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 16px;
            height: 16px;
            background: var(--primary);
            border-radius: 50%;
        }
        
        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary-light);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title i {
            color: var(--primary);
        }
        
        /* استایل‌های جدید برای بخش فاکتور */
        .invoice-customer-info {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(44, 90, 160, 0.05);
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
        }
        
        .invoice-customer-info div {
            margin-bottom: 5px;
        }
        
        /* استایل‌های جدید برای بخش حساب‌ها */
        .account-group-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .account-group-form .form-group {
            margin-bottom: 0;
        }
        
        .account-group-form .form-group:nth-child(3) {
            margin-top: 10px;
        }
        
        /* استایل‌های جدید برای بخش فاکتورهای ذخیره شده */
        .saved-invoices-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            padding: 10px;
            background: var(--light);
        }
        
        .saved-invoice-item {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px;
            margin-bottom: 5px;
            background: white;
        }
        
        .saved-invoice-item:hover {
            background: rgba(44, 90, 160, 0.05);
        }
        
        .saved-invoice-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .saved-invoice-info {
            flex: 1;
        }
        
        .saved-invoice-title {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--dark);
            margin-bottom: 4px;
        }
        
        .saved-invoice-meta {
            display: flex;
            gap: 10px;
            font-size: 0.75rem;
            color: var(--secondary);
        }
        
        .saved-invoice-actions {
            display: flex;
            gap: 5px;
        }
        
        /* استایل‌های جدید برای فاصله‌گذاری بهتر */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group:last-child {
            margin-bottom: 0;
        }
        
        .form-section {
            margin-bottom: 20px;
        }
        
        .form-section:last-child {
            margin-bottom: 0;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .actions .btn {
            flex: 1;
        }

        /* استایل‌های جدید برای فرم اطلاعات شرکت و طرف حساب */
        .company-type-selector, .party-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .type-btn {
            flex: 1;
            padding: 10px 15px;
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
            transition: var(--transition);
        }
        
        .type-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .type-btn:hover:not(.active) {
            background: rgba(44, 90, 160, 0.1);
            border-color: var(--primary);
        }
        
        .company-info-form, .party-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .company-info-form .form-group, .party-form .form-group {
            margin-bottom: 0;
        }
        
        .company-info-form .form-group:nth-child(3), .party-form .form-group:nth-child(3) {
            grid-column: 1 / span 2;
        }
        
        .company-info-form .form-group:nth-child(4), .party-form .form-group:nth-child(4) {
            grid-column: 1 / span 2;
        }
        
        .company-info-form .form-group:nth-child(5), .party-form .form-group:nth-child(5) {
            grid-column: 1 / span 2;
        }
        
        .company-info-form .form-group:nth-child(6), .party-form .form-group:nth-child(6) {
            grid-column: 1 / span 2;
        }
        
        /* استایل‌های جدید برای فاکتور استاندارد */
        .invoice-standard-preview {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            border: 1px solid var(--border);
            margin-top: 15px;
        }
        
        .invoice-standard-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
        }
        
        .invoice-standard-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .invoice-standard-number {
            font-size: 1rem;
            color: var(--secondary);
        }
        
        .invoice-standard-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .invoice-standard-seller, .invoice-standard-buyer {
            flex: 1;
            padding: 15px;
            background: rgba(44, 90, 160, 0.05);
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
        }
        
        .invoice-standard-seller {
            margin-left: 10px;
        }
        
        .invoice-standard-buyer {
            margin-right: 10px;
        }
        
        .invoice-standard-section-title {
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary);
            border-bottom: 1px solid var(--border);
            padding-bottom: 5px;
        }
        
        .invoice-standard-info-row {
            display: flex;
            margin-bottom: 5px;
        }
        
        .invoice-standard-info-label {
            font-weight: 600;
            width: 120px;
        }
        
        .invoice-standard-info-value {
            flex: 1;
        }
        
        .invoice-standard-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 0.75rem;
        }
        
        .invoice-standard-table th {
            background: var(--primary);
            color: white;
            padding: 8px;
            text-align: center;
            border: 1px solid var(--border);
        }
        
        .invoice-standard-table td {
            padding: 6px;
            border: 1px solid var(--border);
            text-align: center;
        }
        
        .invoice-standard-totals {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .invoice-standard-total-section {
            padding: 10px;
            background: rgba(44, 90, 160, 0.05);
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
        }
        
        .invoice-standard-total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .invoice-standard-total-label {
            font-weight: 600;
        }
        
        .invoice-standard-total-value {
            font-weight: 700;
        }
        
        .invoice-standard-payment {
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(44, 90, 160, 0.05);
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
        }
        
        .invoice-standard-payment-title {
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .invoice-standard-payment-options {
            display: flex;
            gap: 20px;
        }
        
        .invoice-standard-payment-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .invoice-standard-payment-option input {
            width: auto;
        }
        
        .invoice-standard-signatures {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        .invoice-standard-signature {
            text-align: center;
            width: 45%;
        }
        
        .invoice-standard-signature-line {
            border-top: 1px solid var(--border);
            margin-top: 40px;
            padding-top: 5px;
        }
        
        /* استایل‌های جدید برای چک‌باکس */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .checkbox-container input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        /* استایل‌های جدید برای فاکتور به‌روز شده */
        .invoice-horizontal-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background: rgba(44, 90, 160, 0.05);
            border-radius: var(--border-radius);
            padding: 15px;
            border: 1px solid var(--border);
        }
        
        .invoice-seller-details, .invoice-buyer-details {
            flex: 1;
        }
        
        .invoice-seller-details {
            margin-left: 10px;
        }
        
        .invoice-buyer-details {
            margin-right: 10px;
        }
        
        .invoice-detail-row {
            display: flex;
            margin-bottom: 8px;
        }
        
        .invoice-detail-label {
            font-weight: 600;
            width: 120px;
        }
        
        .invoice-detail-value {
            flex: 1;
        }
        
        .invoice-summary-section {
            margin-top: 20px;
            background: rgba(44, 90, 160, 0.05);
            border-radius: var(--border-radius);
            padding: 15px;
            border: 1px solid var(--border);
        }
        
        .invoice-summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }
        
        .invoice-summary-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .invoice-summary-label {
            font-weight: 600;
        }
        
        .invoice-summary-value {
            font-weight: 700;
        }

        /* استایل‌های جدید برای فاکتور با فونت‌های کوچکتر */
        .invoice-small-font {
            font-size: 0.7rem;
        }
        
        .invoice-payment-options {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        
        .invoice-payment-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .invoice-payment-option input {
            width: auto;
        }
        
        .invoice-payment-checkbox {
            width: 16px;
            height: 16px;
            margin-left: 5px;
        }
        
        /* استایل‌های جدید برای بخش فاکتور */
        .invoice-section {
            margin-top: 20px;
        }
        
        .invoice-section .form-group {
            margin-bottom: 15px;
        }
        
        .invoice-section .invoice-item-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .invoice-section .invoice-item-row .form-group {
            margin-bottom: 0;
        }

        /* استایل‌های جدید برای بخش انبار */
        .inventory-update-notice {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid var(--warning);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            color: var(--dark);
            font-weight: 600;
        }
        
        .inventory-update-notice i {
            color: var(--warning);
            margin-bottom: 10px;
            font-size: 1.5rem;
        }
    </style>
</head>
<body>
    <!-- صفحه ورود -->
    <div class="auth-container" id="login-page">
        <div class="login-card">
            <div class="brand">
                <div class="brand-icon">
                    <i class="fas fa-calculator"></i>
                </div>
                <h1 class="brand-name">مَهراز سیستم</h1>
                <p class="brand-tagline">مَهراز، راز موفقیت مالی تو</p>
            </div>
            <form class="login-form" id="login-form">
                <div class="input-group">
                    <label for="password" class="input-label">رمز عبور</label>
                    <div class="input-with-icon">
                        <i class="fas fa-lock input-icon"></i>
                        <input type="password" id="password" class="input-field" placeholder="رمز عبور خود را وارد کنید" required>
                    </div>
                </div>
                
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i>
                    ورود به سیستم
                </button>
                
                <div class="error-message" id="error-message">
                    <i class="fas fa-exclamation-circle"></i>
                    رمز عبور اشتباه است!
                </div>
            </form>
        </div>
    </div>

    <!-- صفحه اصلی سیستم -->
    <div id="main-app">
        <div class="app-layout">
            <!-- نوار کناری -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="app-logo">
                        <div class="app-logo-icon">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <div class="app-logo-text">مَهراز سیستم</div>
                    </div>
                    <button class="dashboard-btn" id="dashboard-btn">
                        <i class="fas fa-user"></i>
                    </button>
                </div>
                
                <div class="sidebar-nav">
                    <div class="nav-item active" data-tab="transaction">
                        <i class="fas fa-plus-circle"></i>
                        <span class="nav-item-text">ثبت</span>
                    </div>
                    <div class="nav-item" data-tab="documents">
                        <i class="fas fa-file-invoice"></i>
                        <span class="nav-item-text">اسناد</span>
                    </div>
                    <div class="nav-item" data-tab="ledgers">
                        <i class="fas fa-book"></i>
                        <span class="nav-item-text">دفاتر</span>
                    </div>
                    <div class="nav-item" data-tab="reports">
                        <i class="fas fa-chart-bar"></i>
                        <span class="nav-item-text">گزارش</span>
                    </div>
                    <div class="nav-item" data-tab="salary">
                        <i class="fas fa-money-bill-wave"></i>
                        <span class="nav-item-text">حقوق</span>
                    </div>
                    <div class="nav-item" data-tab="inventory">
                        <i class="fas fa-warehouse"></i>
                        <span class="nav-item-text">انبار</span>
                    </div>
                    <div class="nav-item" data-tab="invoice">
                        <i class="fas fa-receipt"></i>
                        <span class="nav-item-text">فاکتور</span>
                    </div>
                    <div class="nav-item" data-tab="accounts">
                        <i class="fas fa-wallet"></i>
                        <span class="nav-item-text">حساب</span>
                    </div>
                </div>
            </div>
            
            <!-- محتوای اصلی -->
            <div class="main-content">
                <div class="content-header">
                    <h1 class="page-title" id="page-title">
                        <i class="fas fa-plus-circle"></i>
                        ثبت معامله جدید
                    </h1>
                    <p class="page-description" id="page-description">
                        در این بخش می‌توانید معاملات مالی خود را ثبت و مدیریت کنید
                    </p>
                </div>
                
                <div class="content-body">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title" id="form-title">
                                <i class="fas fa-edit"></i>
                                فرم ثبت معامله
                            </h2>
                        </div>
                        
                        <div id="transaction-tab" class="tab-content">
                            <div class="form-type-selector">
                                <button type="button" class="form-type-btn active" data-form="transaction-form">
                                    <i class="fas fa-exchange-alt"></i>
                                    فرم ثبت معامله
                                </button>
                                <button type="button" class="form-type-btn" data-form="manual-document-form">
                                    <i class="fas fa-file-alt"></i>
                                    سند دستی
                                </button>
                            </div>
                            
                            <form id="transaction-form" class="active-form">
                                <div class="form-group">
                                    <label for="transaction-date" class="form-label">تاریخ معامله</label>
                                    <input type="text" id="transaction-date" class="form-control" placeholder="مثال: ۱۴۰۴/۸/۱۵" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="transaction-type" class="form-label">نوع معامله</label>
                                    <select id="transaction-type" class="form-control" required>
                                        <option value="">انتخاب کنید</option>
                                        <option value="receipt">دریافت</option>
                                        <option value="payment">پرداخت</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="payment-type" class="form-label">نوع پرداخت</label>
                                    <select id="payment-type" class="form-control" required>
                                        <option value="">انتخاب کنید</option>
                                        <option value="cash">نقد</option>
                                        <option value="credit">نسیه</option>
                                        <option value="check">چک-سفته</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="party" class="form-label">طرف حساب</label>
                                    <select id="party" class="form-control">
                                        <option value="">انتخاب کنید</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="account" class="form-label">بابت</label>
                                    <select id="account" class="form-control" required>
                                        <option value="">انتخاب کنید</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="amount" class="form-label">مبلغ</label>
                                    <div class="amount-input-container">
                                        <span class="currency-symbol">﷼</span>
                                        <input type="text" id="amount" class="form-control amount-input" placeholder="0" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="description" class="form-label">شرح</label>
                                    <textarea id="description" class="form-control" rows="3" placeholder="شرح معامله" required></textarea>
                                </div>
                                
                                <button type="submit" class="btn btn-success btn-block">
                                    <i class="fas fa-file-alt"></i>
                                    ثبت سند
                                </button>
                            </form>
                            
                            <form id="manual-document-form" class="manual-document-form">
                                <div class="form-group">
                                    <label for="manual-document-date" class="form-label">تاریخ سند</label>
                                    <input type="text" id="manual-document-date" class="form-control" placeholder="مثال: ۱۴۰۴/۸/۱۵" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="manual-document-description" class="form-label">شرح سند</label>
                                    <textarea id="manual-document-description" class="form-control" rows="2" placeholder="شرح کلی سند" required></textarea>
                                </div>
                                
                                <div class="manual-transactions-container" id="manual-transactions-container">
                                    <div class="manual-transaction-row">
                                        <div class="form-group">
                                            <label class="form-label">حساب</label>
                                            <select class="form-control manual-account" required>
                                                <option value="">انتخاب کنید</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">بدهکار</label>
                                            <div class="amount-input-container">
                                                <span class="currency-symbol">﷼</span>
                                                <input type="text" class="form-control amount-input manual-debit" placeholder="0">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">بستانکار</label>
                                            <div class="amount-input-container">
                                                <span class="currency-symbol">﷼</span>
                                                <input type="text" class="form-control amount-input manual-credit" placeholder="0">
                                            </div>
                                        </div>
                                        <button type="button" class="remove-transaction-btn" disabled>
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <button type="button" id="add-transaction-btn" class="btn btn-success">
                                    <i class="fas fa-plus"></i>
                                    افزودن ردیف
                                </button>
                                
                                <div class="form-group" style="margin-top: 15px;">
                                    <button type="submit" class="btn btn-success btn-block">
                                        <i class="fas fa-file-alt"></i>
                                        ثبت سند دستی
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div id="documents-tab" class="tab-content hidden">
                            <div class="documents-list" id="documents-list">
                                <div class="empty-state">
                                    <i class="fas fa-file-invoice"></i>
                                    <p>هیچ سندی ذخیره نشده است</p>
                                </div>
                            </div>
                            
                            <div class="section-divider"></div>
                            
                            <div class="saved-invoices-section">
                                <h3 class="section-title">
                                    <i class="fas fa-file-invoice"></i>
                                    فاکتورهای ذخیره شده
                                </h3>
                                <div class="saved-invoices-list" id="saved-invoices-list">
                                    <div class="empty-state">
                                        <i class="fas fa-file-invoice"></i>
                                        <p>هیچ فاکتوری ذخیره نشده است</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="ledgers-tab" class="tab-content hidden">
                            <div class="journal-section">
                                <h3 class="section-title">
                                    <i class="fas fa-book"></i>
                                    دفتر روزنامه
                                </h3>
                                <div class="journal-table-container">
                                    <table class="journal-table">
                                        <thead>
                                            <tr>
                                                <th class="document-number-cell">شماره سند</th>
                                                <th class="date-cell">تاریخ</th>
                                                <th class="description-cell">شرح حساب</th>
                                                <th class="amount-cell">بدهکار</th>
                                                <th class="amount-cell">بستانکار</th>
                                            </tr>
                                        </thead>
                                        <tbody id="journal-body">
                                            <tr>
                                                <td colspan="5" class="empty-state">
                                                    <i class="fas fa-book"></i>
                                                    <p>هیچ سندی برای نمایش در دفتر روزنامه وجود ندارد</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="section-divider"></div>
                            
                            <div class="ledger-section">
                                <h3 class="section-title">
                                    <i class="fas fa-book"></i>
                                    دفترکل
                                </h3>
                                <div class="ledger-controls">
                                    <select id="ledger-account-select" class="form-control">
                                        <option value="">انتخاب حساب برای مشاهده دفترکل</option>
                                    </select>
                                </div>
                                <div class="ledger-table-container">
                                    <table class="ledger-table">
                                        <thead>
                                            <tr>
                                                <th class="date-cell">تاریخ</th>
                                                <th class="description-cell">شرح</th>
                                                <th class="amount-cell">بدهکار</th>
                                                <th class="amount-cell">بستانکار</th>
                                                <th class="balance-cell">مانده</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ledger-body">
                                            <tr>
                                                <td colspan="5" class="empty-state">
                                                    <i class="fas fa-book"></i>
                                                    <p>لطفاً یک حساب را برای مشاهده دفترکل انتخاب کنید</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="section-divider"></div>
                            
                            <div class="subsidiary-ledger-section">
                                <h3 class="section-title">
                                    <i class="fas fa-book"></i>
                                    دفتر معین
                                </h3>
                                <div class="subsidiary-ledger-controls">
                                    <select id="subsidiary-ledger-account-select" class="form-control">
                                        <option value="">انتخاب حساب برای مشاهده دفتر معین</option>
                                    </select>
                                </div>
                                <div class="subsidiary-ledger-table-container">
                                    <table class="subsidiary-ledger-table">
                                        <thead>
                                            <tr>
                                                <th class="date-cell">تاریخ</th>
                                                <th class="description-cell">شرح</th>
                                                <th class="amount-cell">بدهکار</th>
                                                <th class="amount-cell">بستانکار</th>
                                                <th class="balance-cell">مانده</th>
                                            </tr>
                                        </thead>
                                        <tbody id="subsidiary-ledger-body">
                                            <tr>
                                                <td colspan="5" class="empty-state">
                                                    <i class="fas fa-book"></i>
                                                    <p>لطفاً یک حساب را برای مشاهده دفتر معین انتخاب کنید</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div id="reports-tab" class="tab-content hidden">
                            <div class="profit-loss-section">
                                <h3 class="section-title">
                                    <i class="fas fa-chart-line"></i>
                                    صورت سود و زیان
                                </h3>
                                <table class="profit-loss-table">
                                    <thead>
                                        <tr>
                                            <th>شرح</th>
                                            <th>مبلغ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="profit-loss-body">
                                        <tr>
                                            <td colspan="2" class="empty-state">
                                                <i class="fas fa-chart-line"></i>
                                                <p>داده‌ای برای محاسبه سود و زیان وجود ندارد</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="section-divider"></div>
                            
                            <div class="trial-balance">
                                <h3 class="section-title">
                                    <i class="fas fa-chart-bar"></i>
                                    تراز آزمایشی دوستون
                                </h3>
                                <table class="trial-balance-table">
                                    <thead>
                                        <tr>
                                            <th>نام حساب</th>
                                            <th>بدهکار</th>
                                            <th>بستانکار</th>
                                        </tr>
                                    </thead>
                                    <tbody id="trial-balance-body">
                                        <tr>
                                            <td colspan="3" class="empty-state">
                                                <i class="fas fa-chart-bar"></i>
                                                <p>هیچ معامله‌ای برای محاسبه تراز آزمایشی وجود ندارد</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="section-divider"></div>
                            
                            <div class="balance-sheet-section">
                                <h3 class="section-title">
                                    <i class="fas fa-balance-scale"></i>
                                    ترازنامه
                                </h3>
                                <table class="balance-sheet-table">
                                    <thead>
                                        <tr>
                                            <th>دارایی‌ها</th>
                                            <th>مبلغ</th>
                                            <th>بدهی‌ها و سرمایه</th>
                                            <th>مبلغ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="balance-sheet-body">
                                        <tr>
                                            <td colspan="4" class="empty-state">
                                                <i class="fas fa-balance-scale"></i>
                                                <p>داده‌ای برای محاسبه ترازنامه وجود ندارد</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="salary-tab" class="tab-content hidden">
                            <div class="salary-monthly-info">
                                <h3 class="section-title">
                                    <i class="fas fa-calendar-alt"></i>
                                    اطلاعات تکمیلی ماهانه
                                </h3>
                                <div class="salary-monthly-form">
                                    <div class="form-group">
                                        <label for="monthly-employee" class="form-label">پرسنل</label>
                                        <select id="monthly-employee" class="form-control">
                                            <option value="">انتخاب کنید</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="salary-month" class="form-label">ماه</label>
                                        <select id="salary-month" class="form-control">
                                            <option value="">انتخاب کنید</option>
                                            <option value="1">فروردین</option>
                                            <option value="2">اردیبهشت</option>
                                            <option value="3">خرداد</option>
                                            <option value="4">تیر</option>
                                            <option value="5">مرداد</option>
                                            <option value="6">شهریور</option>
                                            <option value="7">مهر</option>
                                            <option value="8">آبان</option>
                                            <option value="9">آذر</option>
                                            <option value="10">دی</option>
                                            <option value="11">بهمن</option>
                                            <option value="12">اسفند</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="monthly-work-days" class="form-label">کارکرد روزانه</label>
                                        <input type="text" id="monthly-work-days" class="form-control" placeholder="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="monthly-work-hours" class="form-label">کارکرد ساعتی</label>
                                        <input type="text" id="monthly-work-hours" class="form-control" placeholder="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="monthly-overtime-hours" class="form-label">اضافه کاری (ساعت)</label>
                                        <input type="text" id="monthly-overtime-hours" class="form-control" placeholder="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="monthly-mission-days" class="form-label">ماموریت (روز)</label>
                                        <input type="text" id="monthly-mission-days" class="form-control" placeholder="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="monthly-other-benefits" class="form-label">سایر مزایا</label>
                                        <div class="amount-input-container">
                                            <span class="currency-symbol">﷼</span>
                                            <input type="text" id="monthly-other-benefits" class="form-control amount-input" placeholder="0">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="monthly-deductions" class="form-label">کسورات</label>
                                        <div class="amount-input-container">
                                            <span class="currency-symbol">﷼</span>
                                            <input type="text" id="monthly-deductions" class="form-control amount-input" placeholder="0">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="salary-actions">
                                    <button type="button" id="generate-salary-document" class="btn btn-success">
                                        <i class="fas fa-file-invoice-dollar"></i>
                                        سند محاسبه حقوق و دستمزد
                                    </button>
                                </div>
                            </div>
                            
                            <div class="section-divider"></div>
                            
                            <div class="salary-base-info">
                                <h3 class="section-title">
                                    <i class="fas fa-user-plus"></i>
                                    ایجاد اطلاعات پایه پرسنل
                                </h3>
                                <div class="salary-base-form">
                                    <div class="form-group">
                                        <label for="employee-name" class="form-label">نام و نام خانوادگی</label>
                                        <input type="text" id="employee-name" class="form-control" placeholder="نام و نام خانوادگی">
                                    </div>
                                    <div class="form-group">
                                        <label for="employee-national-id" class="form-label">کد ملی</label>
                                        <input type="text" id="employee-national-id" class="form-control" placeholder="کد ملی">
                                    </div>
                                    <div class="form-group">
                                        <label for="employee-hire-date" class="form-label">تاریخ استخدام</label>
                                        <input type="text" id="employee-hire-date" class="form-control" placeholder="مثال: ۱۴۰۴/۸/۱۵">
                                    </div>
                                    <div class="form-group">
                                        <label for="employee-daily-salary" class="form-label">حقوق پایه روزانه</label>
                                        <div class="amount-input-container">
                                            <span class="currency-symbol">﷼</span>
                                            <input type="text" id="employee-daily-salary" class="form-control amount-input" placeholder="0">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="employee-hourly-salary" class="form-label">حقوق پایه ساعتی</label>
                                        <div class="amount-input-container">
                                            <span class="currency-symbol">﷼</span>
                                            <input type="text" id="employee-hourly-salary" class="form-control amount-input" placeholder="0">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="employee-housing-allowance" class="form-label">حق مسکن</label>
                                        <div class="amount-input-container">
                                            <span class="currency-symbol">﷼</span>
                                            <input type="text" id="employee-housing-allowance" class="form-control amount-input" placeholder="0">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="employee-marriage-allowance" class="form-label">حق تاهل</label>
                                        <div class="amount-input-container">
                                            <span class="currency-symbol">﷼</span>
                                            <input type="text" id="employee-marriage-allowance" class="form-control amount-input" placeholder="0">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="employee-child-allowance" class="form-label">حق اولاد</label>
                                        <div class="amount-input-container">
                                            <span class="currency-symbol">﷼</span>
                                            <input type="text" id="employee-child-allowance" class="form-control amount-input" placeholder="0">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="employee-food-allowance" class="form-label">حق خوار و بار</label>
                                        <div class="amount-input-container">
                                            <span class="currency-symbol">﷼</span>
                                            <input type="text" id="employee-food-allowance" class="form-control amount-input" placeholder="0">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="employee-worker-bonus" class="form-label">بن کارگری</label>
                                        <div class="amount-input-container">
                                            <span class="currency-symbol">﷼</span>
                                            <input type="text" id="employee-worker-bonus" class="form-control amount-input" placeholder="0">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="employee-seniority-base" class="form-label">پایه سنوات</label>
                                        <div class="amount-input-container">
                                            <span class="currency-symbol">﷼</span>
                                            <input type="text" id="employee-seniority-base" class="form-control amount-input" placeholder="0">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="employee-insurance-worker" class="form-label">درصد بیمه سهم کارگر</label>
                                        <input type="text" id="employee-insurance-worker" class="form-control" placeholder="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="employee-insurance-employer" class="form-label">درصد بیمه سهم کارفرما</label>
                                        <input type="text" id="employee-insurance-employer" class="form-control" placeholder="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="employee-salary-tax" class="form-label">مالیات حقوق</label>
                                        <div class="amount-input-container">
                                            <span class="currency-symbol">﷼</span>
                                            <input type="text" id="employee-salary-tax" class="form-control amount-input" placeholder="0">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <button type="button" id="add-employee" class="btn btn-success">
                                            <i class="fas fa-user-plus"></i>
                                            افزودن پرسنل
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="salary-employees-list" id="salary-employees-list">
                                    <div class="empty-state">
                                        <i class="fas fa-users"></i>
                                        <p>هیچ پرسنلی ثبت نشده است</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="inventory-tab" class="tab-content hidden">
                            <div class="inventory-update-notice">
                                <i class="fas fa-tools"></i>
                                <p>در آپدیت های آینده این بخش تکمیل خواهد شد</p>
                            </div>
                        </div>
                        
                        <div id="invoice-tab" class="tab-content hidden">
                            <div class="invoice-section">
                                <h3 class="section-title">
                                    <i class="fas fa-receipt"></i>
                                    فاکتور فروش/خدمات
                                </h3>
                                
                                <!-- بخش افزودن مشخصات کالا/خدمات -->
                                <div class="inventory-section">
                                    <h3 class="section-title">
                                        <i class="fas fa-plus"></i>
                                        افزودن مشخصات کالا/خدمات
                                    </h3>
                                    <div class="inventory-form">
                                        <div class="form-group">
                                            <label for="product-code" class="form-label">کد کالا/خدمات</label>
                                            <input type="text" id="product-code" class="form-control" placeholder="کد کالا/خدمات">
                                        </div>
                                        <div class="form-group">
                                            <label for="product-name" class="form-label">نام کالا/خدمات</label>
                                            <input type="text" id="product-name" class="form-control" placeholder="نام کالا/خدمات">
                                        </div>
                                        <div class="form-group">
                                            <label for="product-price" class="form-label">بهای واحد</label>
                                            <div class="amount-input-container">
                                                <span class="currency-symbol">﷼</span>
                                                <input type="text" id="product-price" class="form-control amount-input" placeholder="0">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <button type="button" id="add-product" class="btn btn-success">
                                                <i class="fas fa-plus"></i>
                                                افزودن کالا/خدمات
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="inventory-list" id="inventory-list">
                                        <div class="empty-state">
                                            <i class="fas fa-boxes"></i>
                                            <p>هیچ کالا/خدماتی ثبت نشده است</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="section-divider"></div>
                                
                                <!-- بخش اصلی فاکتور -->
                                <div class="invoice-form">
                                    <div class="form-group">
                                        <label for="invoice-date" class="form-label">تاریخ فاکتور</label>
                                        <input type="text" id="invoice-date" class="form-control" placeholder="مثال: ۱۴۰۴/۸/۱۵">
                                    </div>
                                    <div class="form-group">
                                        <label for="invoice-party" class="form-label">خریدار</label>
                                        <select id="invoice-party" class="form-control">
                                            <option value="">انتخاب کنید</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="invoice-items">
                                    <h4>موارد فاکتور</h4>
                                    <div class="invoice-item-row">
                                        <div class="form-group">
                                            <label class="form-label">کد کالا/خدمات</label>
                                            <select class="form-control invoice-product">
                                                <option value="">انتخاب کنید</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">مقدار</label>
                                            <input type="text" class="form-control invoice-quantity" placeholder="0">
                                        </div>
                                    </div>
                                    
                                    <div class="invoice-tax-discount-row">
                                        <div class="form-group">
                                            <label for="invoice-discount" class="form-label">تخفیف (درصد)</label>
                                            <input type="text" id="invoice-discount" class="form-control" placeholder="0">
                                        </div>
                                        <div class="form-group">
                                            <label for="invoice-tax" class="form-label">مالیات بر ارزش افزوده (درصد)</label>
                                            <input type="text" id="invoice-tax" class="form-control" placeholder="9">
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">نحوه پرداخت</label>
                                        <div class="invoice-payment-options">
                                            <div class="invoice-payment-option">
                                                <input type="radio" id="payment-cash" name="payment-method" value="cash" class="invoice-payment-checkbox">
                                                <label for="payment-cash">نقدی</label>
                                            </div>
                                            <div class="invoice-payment-option">
                                                <input type="radio" id="payment-non-cash" name="payment-method" value="non-cash" class="invoice-payment-checkbox">
                                                <label for="payment-non-cash">غیر نقدی</label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button type="button" id="add-invoice-item" class="btn btn-success">
                                        <i class="fas fa-plus"></i>
                                        افزودن ردیف فاکتور
                                    </button>
                                </div>
                                
                                <div class="invoice-items-container" id="invoice-items-container">
                                    <div class="empty-state">
                                        <i class="fas fa-receipt"></i>
                                        <p>هیچ موردی به فاکتور اضافه نشده است</p>
                                    </div>
                                </div>
                                
                                <div class="invoice-standard-preview" id="invoice-standard-preview">
                                    <div class="empty-state">
                                        <i class="fas fa-receipt"></i>
                                        <p>پس از پر کردن فرم، پیش‌نمایش فاکتور در اینجا نمایش داده می‌شود</p>
                                    </div>
                                </div>
                                
                                <div class="actions">
                                    <button id="save-invoice" class="btn btn-success">
                                        <i class="fas fa-save"></i>
                                        ذخیره فاکتور
                                    </button>
                                    <button id="print-invoice" class="btn btn-info">
                                        <i class="fas fa-print"></i>
                                        چاپ فاکتور
                                    </button>
                                    <button id="reset-invoice" class="btn btn-warning">
                                        <i class="fas fa-undo"></i>
                                        بازگشت
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="accounts-tab" class="tab-content hidden">
                            <div class="parties-section">
                                <h3 class="section-title">
                                    <i class="fas fa-address-book"></i>
                                    مدیریت طرف‌های حساب
                                </h3>
                                <div class="party-type-selector">
                                    <button type="button" class="type-btn active" data-type="legal">
                                        <i class="fas fa-building"></i>
                                        حقوقی
                                    </button>
                                    <button type="button" class="type-btn" data-type="individual">
                                        <i class="fas fa-user"></i>
                                        حقیقی
                                    </button>
                                </div>
                                <div class="party-form">
                                    <div class="form-group">
                                        <label for="party-name" class="form-label">نام طرف حساب</label>
                                        <input type="text" id="party-name" class="form-control" placeholder="نام طرف حساب">
                                    </div>
                                    <div class="form-group">
                                        <label for="party-economic-code" class="form-label">شماره اقتصادی</label>
                                        <input type="text" id="party-economic-code" class="form-control" placeholder="شماره اقتصادی">
                                    </div>
                                    <div class="form-group" id="party-registration-code-group">
                                        <label for="party-registration-code" class="form-label">شماره ثبت</label>
                                        <input type="text" id="party-registration-code" class="form-control" placeholder="شماره ثبت">
                                    </div>
                                    <div class="form-group" id="party-national-code-group" style="display: none;">
                                        <label for="party-national-code" class="form-label">شماره ملی</label>
                                        <input type="text" id="party-national-code" class="form-control" placeholder="شماره ملی">
                                    </div>
                                    <div class="form-group">
                                        <label for="party-phone" class="form-label">شماره تماس</label>
                                        <input type="text" id="party-phone" class="form-control" placeholder="شماره تماس">
                                    </div>
                                    <div class="form-group">
                                        <label for="party-address" class="form-label">آدرس</label>
                                        <textarea id="party-address" class="form-control" rows="2" placeholder="آدرس"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="party-postal-code" class="form-label">کد پستی</label>
                                        <input type="text" id="party-postal-code" class="form-control" placeholder="کد پستی">
                                    </div>
                                    <div class="form-group">
                                        <button type="button" id="add-party" class="btn btn-success">
                                            <i class="fas fa-plus"></i>
                                            افزودن طرف حساب
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="parties-list" id="parties-list">
                                    <div class="empty-state">
                                        <i class="fas fa-address-book"></i>
                                        <p>هیچ طرف حسابی ثبت نشده است</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="section-divider"></div>
                            
                            <div class="account-management">
                                <h3 class="section-title">
                                    <i class="fas fa-plus"></i>
                                    افزودن حساب جدید
                                </h3>
                                <div class="account-group-form">
                                    <div class="form-group">
                                        <label for="new-account-name" class="form-label">نام حساب</label>
                                        <input type="text" id="new-account-name" class="form-control" placeholder="نام حساب جدید">
                                    </div>
                                    <div class="form-group">
                                        <label for="account-group" class="form-label">گروه حساب</label>
                                        <select id="account-group" class="form-control">
                                            <option value="asset">دارایی</option>
                                            <option value="liability">بدهی</option>
                                            <option value="equity">حقوق صاحبان سهام</option>
                                            <option value="income">درآمد</option>
                                            <option value="expense">هزینه</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <button type="button" id="add-account" class="btn btn-success">
                                            <i class="fas fa-plus"></i>
                                            افزودن حساب
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="accounts-list" id="accounts-list">
                                    <div class="empty-state">
                                        <i class="fas fa-wallet"></i>
                                        <p>هیچ حسابی ثبت نشده است</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="dashboard-tab" class="tab-content hidden">
                            <div class="dashboard-container">
                                <div class="company-info-section">
                                    <h3 class="section-title">
                                        <i class="fas fa-building"></i>
                                        اطلاعات شرکت
                                    </h3>
                                    <div class="company-type-selector">
                                        <button type="button" class="type-btn active" data-type="legal">
                                            <i class="fas fa-building"></i>
                                            حقوقی
                                        </button>
                                        <button type="button" class="type-btn" data-type="individual">
                                            <i class="fas fa-user"></i>
                                            حقیقی
                                        </button>
                                    </div>
                                    <div class="company-info-form">
                                        <div class="form-group">
                                            <label for="company-name" class="form-label">نام شرکت/شخص</label>
                                            <input type="text" id="company-name" class="form-control" placeholder="نام شرکت/شخص">
                                        </div>
                                        <div class="form-group">
                                            <label for="company-economic-code" class="form-label">شماره اقتصادی</label>
                                            <input type="text" id="company-economic-code" class="form-control" placeholder="شماره اقتصادی">
                                        </div>
                                        <div class="form-group" id="company-registration-code-group">
                                            <label for="company-registration-code" class="form-label">شماره ثبت</label>
                                            <input type="text" id="company-registration-code" class="form-control" placeholder="شماره ثبت">
                                        </div>
                                        <div class="form-group" id="company-national-code-group" style="display: none;">
                                            <label for="company-national-code" class="form-label">شماره ملی</label>
                                            <input type="text" id="company-national-code" class="form-control" placeholder="شماره ملی">
                                        </div>
                                        <div class="form-group">
                                            <label for="company-phone" class="form-label">شماره تماس</label>
                                            <input type="text" id="company-phone" class="form-control" placeholder="شماره تماس">
                                        </div>
                                        <div class="form-group">
                                            <label for="company-address" class="form-label">آدرس</label>
                                            <textarea id="company-address" class="form-control" rows="2" placeholder="آدرس"></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label for="company-postal-code" class="form-label">کد پستی</label>
                                            <input type="text" id="company-postal-code" class="form-control" placeholder="کد پستی">
                                        </div>
                                        <div class="form-group">
                                            <button type="button" id="save-company-info" class="btn btn-success">
                                                <i class="fas fa-save"></i>
                                                ذخیره اطلاعات شرکت
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="section-divider"></div>
                                
                                <div class="fiscal-period-section">
                                    <h3 class="section-title">
                                        <i class="fas fa-calendar-alt"></i>
                                        مدیریت دوره مالی
                                    </h3>
                                    <div class="fiscal-period-form">
                                        <div class="form-group">
                                            <label for="fiscal-period-start" class="form-label">تاریخ شروع دوره مالی</label>
                                            <input type="text" id="fiscal-period-start" class="form-control" placeholder="مثال: ۱۴۰۴/۸/۱۵">
                                        </div>
                                        <div class="form-group">
                                            <label for="fiscal-period-end" class="form-label">تاریخ پایان دوره مالی</label>
                                            <input type="text" id="fiscal-period-end" class="form-control" placeholder="مثال: ۱۴۰۴/۸/۱۵">
                                        </div>
                                        <div class="form-group">
                                            <button type="button" id="save-fiscal-period" class="btn btn-success">
                                                <i class="fas fa-save"></i>
                                                ذخیره دوره مالی
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="section-divider"></div>
                                    
                                    <div class="backup-section">
                                        <h3 class="section-title">
                                            <i class="fas fa-database"></i>
                                            پشتیبان‌گیری و بازیابی داده‌ها
                                        </h3>
                                        <div class="backup-actions">
                                            <button type="button" id="export-data" class="btn btn-info">
                                                <i class="fas fa-download"></i>
                                                Export JSON
                                            </button>
                                            <button type="button" id="import-data" class="btn btn-warning">
                                                <i class="fas fa-upload"></i>
                                                Import JSON
                                            </button>
                                            <button type="button" id="reset-data" class="btn btn-danger">
                                                <i class="fas fa-trash"></i>
                                                بازنشانی داده‌ها
                                            </button>
                                        </div>
                                        <input type="file" id="import-file" accept=".json" style="display: none;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-file-alt"></i>
                                سند حسابداری
                            </h2>
                        </div>
                        
                        <div class="document-preview" id="document-preview">
                            <div class="empty-state">
                                <i class="fas fa-file-alt"></i>
                                <p>پس از ثبت معامله، سند حسابداری در اینجا نمایش داده می‌شود</p>
                            </div>
                        </div>
                        
                        <div class="actions">
                            <button id="save-document" class="btn btn-success">
                                <i class="fas fa-save"></i>
                                ذخیره سند
                            </button>
                            <button id="clear-document" class="btn btn-outline">
                                <i class="fas fa-undo"></i>
                                بازگشت
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- فوتر -->
        <div class="footer">
            طراحی شده توسط <a href="https://amirizanganeh.github.io/accountant/" target="_blank">مهدی امیری</a>
        </div>
    </div>

    <!-- جاوااسکریپت اصلی سیستم -->
    <script>
        // اطلاعات ورود
        const VALID_PASSWORD = "1";
        
        // نام و نسخه پایگاه داده
        const DB_NAME = 'MahrazSystem';
        const DB_VERSION = 11; // افزایش نسخه برای تغییرات جدید
        
        // نام جداول
        const STORE_NAMES = {
            ACCOUNTS: 'accounts',
            PARTIES: 'parties',
            TRANSACTIONS: 'transactions',
            DOCUMENTS: 'documents',
            CURRENT_DOCUMENT: 'current_document',
            DOCUMENT_COUNTER: 'document_counter',
            EMPLOYEES: 'employees',
            EMPLOYEE_MONTHLY_DATA: 'employee_monthly_data',
            FISCAL_PERIOD: 'fiscal_period',
            SETTINGS: 'settings',
            COMPANY_INFO: 'company_info',
            INVENTORY: 'inventory',
            INVOICES: 'invoices',
            INVOICE_COUNTER: 'invoice_counter'
        };
        
        // آرایه برای ذخیره معاملات سند جاری
        let currentDocumentTransactions = [];
        
        // آرایه برای ذخیره حساب‌ها
        let accounts = [];
        
        // آرایه برای ذخیره اسناد
        let savedDocuments = [];
        let documentCounter = 1;
        
        // آرایه برای ذخیره پرسنل
        let employees = [];
        
        // آرایه برای ذخیره اطلاعات ماهانه پرسنل
        let employeeMonthlyData = [];
        
        // آرایه برای ذخیره طرف‌های حساب
        let parties = [];
        
        // آرایه برای ذخیره کالاها
        let inventory = [];
        
        // آرایه برای ذخیره فاکتورها
        let savedInvoices = [];
        let invoiceCounter = 1;
        
        // اطلاعات شرکت
        let companyInfo = {
            type: 'legal', // حقیقی یا حقوقی
            name: '',
            economicCode: '',
            registrationCode: '',
            nationalCode: '',
            phone: '',
            address: '',
            postalCode: ''
        };
        
        // اطلاعات دوره مالی
        let fiscalPeriod = {
            startDate: '',
            endDate: ''
        };
        
        // تنظیمات سیستم
        let settings = {
            vatPercentage: 9
        };
        
        // متغیر پایگاه داده
        let db;
        
        // عناصر DOM
        const loginPage = document.getElementById('login-page');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const errorMessage = document.getElementById('error-message');
        const dashboardBtn = document.getElementById('dashboard-btn');
        const pageTitle = document.getElementById('page-title');
        const pageDescription = document.getElementById('page-description');
        const formTitle = document.getElementById('form-title');
        
        const transactionForm = document.getElementById('transaction-form');
        const manualDocumentForm = document.getElementById('manual-document-form');
        const documentPreview = document.getElementById('document-preview');
        const saveDocumentBtn = document.getElementById('save-document');
        const clearDocumentBtn = document.getElementById('clear-document');
        const accountSelect = document.getElementById('account');
        const partySelect = document.getElementById('party');
        const navItems = document.querySelectorAll('.nav-item');
        const tabContents = document.querySelectorAll('.tab-content');
        const addAccountBtn = document.getElementById('add-account');
        const newAccountNameInput = document.getElementById('new-account-name');
        const accountGroupSelect = document.getElementById('account-group');
        const accountsList = document.getElementById('accounts-list');
        const documentsList = document.getElementById('documents-list');
        const trialBalanceBody = document.getElementById('trial-balance-body');
        const ledgerAccountSelect = document.getElementById('ledger-account-select');
        const ledgerBody = document.getElementById('ledger-body');
        const subsidiaryLedgerAccountSelect = document.getElementById('subsidiary-ledger-account-select');
        const subsidiaryLedgerBody = document.getElementById('subsidiary-ledger-body');
        const amountInput = document.getElementById('amount');
        const formTypeBtns = document.querySelectorAll('.form-type-btn');
        const manualTransactionsContainer = document.getElementById('manual-transactions-container');
        const addTransactionBtn = document.getElementById('add-transaction-btn');
        const journalBody = document.getElementById('journal-body');
        const exportDataBtn = document.getElementById('export-data');
        const importDataBtn = document.getElementById('import-data');
        const resetDataBtn = document.getElementById('reset-data');
        const importFileInput = document.getElementById('import-file');
        const employeeNameInput = document.getElementById('employee-name');
        const employeeNationalIdInput = document.getElementById('employee-national-id');
        const employeeHireDateInput = document.getElementById('employee-hire-date');
        const employeeDailySalaryInput = document.getElementById('employee-daily-salary');
        const employeeHourlySalaryInput = document.getElementById('employee-hourly-salary');
        const employeeHousingAllowanceInput = document.getElementById('employee-housing-allowance');
        const employeeMarriageAllowanceInput = document.getElementById('employee-marriage-allowance');
        const employeeChildAllowanceInput = document.getElementById('employee-child-allowance');
        const employeeFoodAllowanceInput = document.getElementById('employee-food-allowance');
        const employeeWorkerBonusInput = document.getElementById('employee-worker-bonus');
        const employeeSeniorityBaseInput = document.getElementById('employee-seniority-base');
        const employeeInsuranceWorkerInput = document.getElementById('employee-insurance-worker');
        const employeeInsuranceEmployerInput = document.getElementById('employee-insurance-employer');
        const employeeSalaryTaxInput = document.getElementById('employee-salary-tax');
        const addEmployeeBtn = document.getElementById('add-employee');
        const salaryEmployeesList = document.getElementById('salary-employees-list');
        const monthlyEmployeeSelect = document.getElementById('monthly-employee');
        const salaryMonthSelect = document.getElementById('salary-month');
        const monthlyWorkDaysInput = document.getElementById('monthly-work-days');
        const monthlyWorkHoursInput = document.getElementById('monthly-work-hours');
        const monthlyOvertimeHoursInput = document.getElementById('monthly-overtime-hours');
        const monthlyMissionDaysInput = document.getElementById('monthly-mission-days');
        const monthlyOtherBenefitsInput = document.getElementById('monthly-other-benefits');
        const monthlyDeductionsInput = document.getElementById('monthly-deductions');
        const generateSalaryDocumentBtn = document.getElementById('generate-salary-document');
        const fiscalPeriodStart = document.getElementById('fiscal-period-start');
        const fiscalPeriodEnd = document.getElementById('fiscal-period-end');
        const saveFiscalPeriodBtn = document.getElementById('save-fiscal-period');
        const profitLossBody = document.getElementById('profit-loss-body');
        const balanceSheetBody = document.getElementById('balance-sheet-body');
        
        // عناصر جدید
        const addPartyBtn = document.getElementById('add-party');
        const partyNameInput = document.getElementById('party-name');
        const partyEconomicCodeInput = document.getElementById('party-economic-code');
        const partyRegistrationCodeInput = document.getElementById('party-registration-code');
        const partyNationalCodeInput = document.getElementById('party-national-code');
        const partyPhoneInput = document.getElementById('party-phone');
        const partyAddressInput = document.getElementById('party-address');
        const partyPostalCodeInput = document.getElementById('party-postal-code');
        const partiesList = document.getElementById('parties-list');
        const companyNameInput = document.getElementById('company-name');
        const companyEconomicCodeInput = document.getElementById('company-economic-code');
        const companyRegistrationCodeInput = document.getElementById('company-registration-code');
        const companyNationalCodeInput = document.getElementById('company-national-code');
        const companyPhoneInput = document.getElementById('company-phone');
        const companyAddressInput = document.getElementById('company-address');
        const companyPostalCodeInput = document.getElementById('company-postal-code');
        const saveCompanyInfoBtn = document.getElementById('save-company-info');
        const addProductBtn = document.getElementById('add-product');
        const productCodeInput = document.getElementById('product-code');
        const productNameInput = document.getElementById('product-name');
        const productPriceInput = document.getElementById('product-price');
        const inventoryList = document.getElementById('inventory-list');
        const invoiceDateInput = document.getElementById('invoice-date');
        const invoicePartySelect = document.getElementById('invoice-party');
        const invoiceProductSelect = document.querySelector('.invoice-product');
        const invoiceQuantityInput = document.querySelector('.invoice-quantity');
        const addInvoiceItemBtn = document.getElementById('add-invoice-item');
        const invoiceStandardPreview = document.getElementById('invoice-standard-preview');
        const printInvoiceBtn = document.getElementById('print-invoice');
        const resetInvoiceBtn = document.getElementById('reset-invoice');
        const invoiceDiscountInput = document.getElementById('invoice-discount');
        const invoiceTaxInput = document.getElementById('invoice-tax');
        const saveInvoiceBtn = document.getElementById('save-invoice');
        const savedInvoicesList = document.getElementById('saved-invoices-list');
        
        // عناصر جدید برای بخش فاکتور
        const invoiceItemsContainer = document.getElementById('invoice-items-container');
        
        // عناصر جدید برای نوع شرکت و طرف حساب
        const companyTypeBtns = document.querySelectorAll('.company-type-selector .type-btn');
        const partyTypeBtns = document.querySelectorAll('.party-type-selector .type-btn');
        const companyRegistrationCodeGroup = document.getElementById('company-registration-code-group');
        const companyNationalCodeGroup = document.getElementById('company-national-code-group');
        const partyRegistrationCodeGroup = document.getElementById('party-registration-code-group');
        const partyNationalCodeGroup = document.getElementById('party-national-code-group');
        
        // آرایه برای ذخیره اقلام فاکتور
        let invoiceItems = [];
        
        // مدیریت ورود به سیستم
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const password = document.getElementById('password').value;
            
            if (password === VALID_PASSWORD) {
                // ورود موفق
                loginPage.style.display = 'none';
                mainApp.style.display = 'block';
                initializeApp();
            } else {
                // نمایش خطا
                errorMessage.style.display = 'block';
            }
        });
        
        // مدیریت رفتن به داشبورد
        dashboardBtn.addEventListener('click', function() {
            // غیرفعال کردن همه آیتم‌های ناوبری
            navItems.forEach(item => item.classList.remove('active'));
            tabContents.forEach(content => content.classList.add('hidden'));
            
            // فعال کردن تب داشبورد
            document.getElementById('dashboard-tab').classList.remove('hidden');
            
            // به‌روزرسانی عنوان صفحه
            updatePageTitle('dashboard');
        });
        
        // مدیریت تغییر نوع فرم
        formTypeBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const formType = this.getAttribute('data-form');
                
                // غیرفعال کردن همه دکمه‌ها
                formTypeBtns.forEach(b => b.classList.remove('active'));
                
                // فعال کردن دکمه انتخاب شده
                this.classList.add('active');
                
                // مخفی کردن همه فرم‌ها
                document.querySelectorAll('.active-form, .manual-document-form').forEach(form => {
                    form.style.display = 'none';
                });
                
                // نمایش فرم انتخاب شده
                document.getElementById(formType).style.display = 'block';
            });
        });
        
        // مدیریت تغییر نوع شرکت
        companyTypeBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const type = this.getAttribute('data-type');
                
                // غیرفعال کردن همه دکمه‌ها
                companyTypeBtns.forEach(b => b.classList.remove('active'));
                
                // فعال کردن دکمه انتخاب شده
                this.classList.add('active');
                
                // به‌روزرسانی نوع شرکت
                companyInfo.type = type;
                
                // نمایش/مخفی کردن فیلدهای مربوطه
                if (type === 'legal') {
                    companyRegistrationCodeGroup.style.display = 'block';
                    companyNationalCodeGroup.style.display = 'none';
                } else {
                    companyRegistrationCodeGroup.style.display = 'none';
                    companyNationalCodeGroup.style.display = 'block';
                }
            });
        });
        
        // مدیریت تغییر نوع طرف حساب
        partyTypeBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const type = this.getAttribute('data-type');
                
                // غیرفعال کردن همه دکمه‌ها
                partyTypeBtns.forEach(b => b.classList.remove('active'));
                
                // فعال کردن دکمه انتخاب شده
                this.classList.add('active');
                
                // نمایش/مخفی کردن فیلدهای مربوطه
                if (type === 'legal') {
                    partyRegistrationCodeGroup.style.display = 'block';
                    partyNationalCodeGroup.style.display = 'none';
                } else {
                    partyRegistrationCodeGroup.style.display = 'none';
                    partyNationalCodeGroup.style.display = 'block';
                }
            });
        });
        
        // مدیریت افزودن ردیف جدید در فرم سند دستی
        addTransactionBtn.addEventListener('click', function() {
            addManualTransactionRow();
        });
        
        // مدیریت پشتیبان‌گیری و بازیابی
        exportDataBtn.addEventListener('click', exportData);
        importDataBtn.addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', importData);
        resetDataBtn.addEventListener('click', resetData);
        
        // مدیریت حقوق و دستمزد
        addEmployeeBtn.addEventListener('click', addEmployee);
        generateSalaryDocumentBtn.addEventListener('click', generateSalaryDocument);
        
        // مدیریت دوره مالی
        saveFiscalPeriodBtn.addEventListener('click', saveFiscalPeriod);
        
        // مدیریت کلیک روی آیتم‌های ناوبری
        navItems.forEach(navItem => {
            navItem.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // غیرفعال کردن همه آیتم‌های ناوبری
                navItems.forEach(item => item.classList.remove('active'));
                tabContents.forEach(content => content.classList.add('hidden'));
                
                // فعال کردن آیتم انتخاب شده
                this.classList.add('active');
                document.getElementById(`${tabId}-tab`).classList.remove('hidden');
                
                // به‌روزرسانی عنوان صفحه
                updatePageTitle(tabId);
                
                // اگر تب گزارش انتخاب شده، گزارش‌ها را به‌روزرسانی کن
                if (tabId === 'reports') {
                    updateStatistics();
                }
                
                // اگر تب اسناد انتخاب شده، فاکتورها را به‌روزرسانی کن
                if (tabId === 'documents') {
                    updateSavedInvoicesList();
                }
                
                // اگر تب دفاتر انتخاب شده، دفاتر را به‌روزرسانی کن
                if (tabId === 'ledgers') {
                    updateJournal();
                    updateLedger(ledgerAccountSelect.value);
                    updateSubsidiaryLedger(subsidiaryLedgerAccountSelect.value);
                }
                
                // اگر تب انبار انتخاب شده، لیست کالاها را به‌روزرسانی کن
                if (tabId === 'inventory') {
                    updateInventoryList();
                }
                
                // اگر تب فاکتور انتخاب شده، لیست کالاها و فاکتورها را به‌روزرسانی کن
                if (tabId === 'invoice') {
                    updateInventoryList();
                    updateInvoicePartySelect();
                    updateInvoiceProductSelect();
                }
                
                // اگر تب حقوق انتخاب شده، لیست پرسنل را به‌روزرسانی کن
                if (tabId === 'salary') {
                    updateEmployeesList();
                    updateMonthlyEmployeeSelect();
                }
            });
        });
        
        // مدیریت افزودن طرف حساب
        addPartyBtn.addEventListener('click', addParty);
        
        // مدیریت ذخیره اطلاعات شرکت
        saveCompanyInfoBtn.addEventListener('click', saveCompanyInfo);
        
        // مدیریت افزودن کالا
        addProductBtn.addEventListener('click', addProduct);
        
        // مدیریت افزودن ردیف فاکتور
        addInvoiceItemBtn.addEventListener('click', addInvoiceItem);
        
        // مدیریت ذخیره فاکتور
        saveInvoiceBtn.addEventListener('click', saveInvoice);
        
        // مدیریت چاپ فاکتور
        printInvoiceBtn.addEventListener('click', printInvoice);
        
        // مدیریت بازگشت فاکتور
        resetInvoiceBtn.addEventListener('click', resetInvoice);
        
        // مدیریت تغییرات فاکتور برای محاسبه مالیات و تخفیف
        invoiceDiscountInput.addEventListener('input', updateInvoiceTotals);
        invoiceTaxInput.addEventListener('input', updateInvoiceTotals);
        
        // مدیریت تغییر حساب در دفتر معین
        subsidiaryLedgerAccountSelect.addEventListener('change', function() {
            updateSubsidiaryLedger(this.value);
        });
        
        // مقداردهی اولیه برنامه پس از ورود
        function initializeApp() {
            // باز کردن پایگاه داده
            openDatabase().then(() => {
                // بارگذاری داده‌ها از IndexedDB
                return Promise.all([
                    loadAccounts(),
                    loadDocuments(),
                    loadDocumentCounter(),
                    loadCurrentDocument(),
                    loadEmployees(),
                    loadEmployeeMonthlyData(),
                    loadFiscalPeriod(),
                    loadSettings(),
                    loadParties(),
                    loadCompanyInfo(),
                    loadInventory(),
                    loadInvoices(),
                    loadInvoiceCounter()
                ]);
            }).then(() => {
                // تنظیم تاریخ امروز
                const today = getTodayPersianDate();
                document.getElementById('transaction-date').value = today;
                document.getElementById('manual-document-date').value = today;
                document.getElementById('invoice-date').value = today;
                document.getElementById('employee-hire-date').value = today;
                
                // بارگذاری حساب‌ها در dropdown
                updateAccountSelect();
                updatePartySelect();
                
                // بارگذاری لیست حساب‌ها
                updateAccountsList();
                
                // بارگذاری اسناد ذخیره شده
                updateDocumentsList();
                
                // بارگذاری لیست پرسنل
                updateEmployeesList();
                updateMonthlyEmployeeSelect();
                
                // بارگذاری لیست طرف‌های حساب
                updatePartiesList();
                
                // بارگذاری اطلاعات شرکت
                updateCompanyInfo();
                
                // بارگذاری لیست کالاها
                updateInventoryList();
                
                // بارگذاری dropdownهای فاکتور
                updateInvoicePartySelect();
                updateInvoiceProductSelect();
                
                // بارگذاری dropdown دفتر معین
                updateSubsidiaryLedgerAccountSelect();
                
                // بارگذاری فاکتورهای ذخیره شده
                updateSavedInvoicesList();
                
                // نمایش سند جاری اگر معامله‌ای وجود دارد
                if (currentDocumentTransactions.length > 0) {
                    generateAccountingDocument();
                }
                
                // رویداد ثبت فرم معامله
                transactionForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // دریافت مقادیر از فرم
                    const date = document.getElementById('transaction-date').value;
                    const transactionType = document.getElementById('transaction-type').value;
                    const paymentType = document.getElementById('payment-type').value;
                    const partyId = document.getElementById('party').value;
                    const accountId = document.getElementById('account').value;
                    const amountText = document.getElementById('amount').value;
                    const description = document.getElementById('description').value;
                    
                    // اعتبارسنجی
                    if (!date || !transactionType || !paymentType || !accountId || !amountText || !description) {
                        alert('لطفاً تمام فیلدهای ضروری را پر کنید!');
                        return;
                    }
                    
                    // تبدیل مبلغ به عدد
                    const amount = parseAmount(amountText);
                    
                    if (isNaN(amount) || amount <= 0) {
                        alert('لطفاً یک مبلغ معتبر وارد کنید!');
                        return;
                    }
                    
                    // پیدا کردن نام حساب
                    const account = accounts.find(acc => acc.id == accountId);
                    if (!account) {
                        alert('حساب انتخاب شده معتبر نیست!');
                        return;
                    }
                    
                    // پیدا کردن نام طرف حساب
                    let partyName = '';
                    if (partyId) {
                        const party = parties.find(p => p.id == partyId);
                        if (party) {
                            partyName = party.name;
                        }
                    }
                    
                    // ایجاد شیء معامله
                    const transaction = {
                        id: Date.now(),
                        date: date,
                        transactionType,
                        paymentType,
                        partyId,
                        partyName,
                        accountId,
                        accountName: account.name,
                        amount: amount,
                        description
                    };
                    
                    // افزودن به آرایه معاملات سند جاری
                    currentDocumentTransactions.push(transaction);
                    
                    // ذخیره در IndexedDB
                    saveCurrentDocument();
                    
                    // پاک کردن فرم
                    transactionForm.reset();
                    
                    // تنظیم مجدد تاریخ به امروز
                    document.getElementById('transaction-date').value = getTodayPersianDate();
                    
                    // نمایش پیام موفقیت
                    showNotification('معامله با موفقیت ثبت شد!', 'success');
                    
                    // تولید خودکار سند حسابداری
                    generateAccountingDocument();
                });
                
                // رویداد ثبت فرم سند دستی
                manualDocumentForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const date = document.getElementById('manual-document-date').value;
                    const description = document.getElementById('manual-document-description').value;
                    
                    // اعتبارسنجی
                    if (!date || !description) {
                        alert('لطفاً تاریخ و شرح سند را وارد کنید!');
                        return;
                    }
                    
                    // جمع‌آوری اطلاعات ردیف‌ها
                    const transactionRows = document.querySelectorAll('.manual-transaction-row');
                    let totalDebit = 0;
                    let totalCredit = 0;
                    const transactions = [];
                    
                    for (let row of transactionRows) {
                        const accountSelect = row.querySelector('.manual-account');
                        const debitInput = row.querySelector('.manual-debit');
                        const creditInput = row.querySelector('.manual-credit');
                        
                        const accountId = accountSelect.value;
                        const debit = parseAmount(debitInput.value) || 0;
                        const credit = parseAmount(creditInput.value) || 0;
                        
                        // اعتبارسنجی ردیف
                        if (!accountId) {
                            alert('لطفاً تمام حساب‌ها را انتخاب کنید!');
                            return;
                        }
                        
                        if (debit === 0 && credit === 0) {
                            alert('لطفاً برای هر ردیف حداقل یک مبلغ وارد کنید!');
                            return;
                        }
                        
                        if (debit > 0 && credit > 0) {
                            alert('لطفاً برای هر ردیف فقط یکی از فیلدهای بدهکار یا بستانکار را پر کنید!');
                            return;
                        }
                        
                        // پیدا کردن نام حساب
                        const account = accounts.find(acc => acc.id == accountId);
                        if (!account) {
                            alert('حساب انتخاب شده معتبر نیست!');
                            return;
                        }
                        
                        totalDebit += debit;
                        totalCredit += credit;
                        
                        // ایجاد شیء معامله برای سند دستی
                        const transaction = {
                            id: Date.now(),
                            date: date,
                            accountId,
                            accountName: account.name,
                            debit: debit,
                            credit: credit,
                            description: description,
                            isManual: true // علامت برای شناسایی سند دستی
                        };
                        
                        transactions.push(transaction);
                    }
                    
                    // بررسی توازن بدهکار و بستانکار
                    if (totalDebit !== totalCredit) {
                        alert(`جمع بدهکار (${formatCurrency(totalDebit)}) با جمع بستانکار (${formatCurrency(totalCredit)}) برابر نیست!`);
                        return;
                    }
                    
                    // افزودن به آرایه معاملات سند جاری
                    currentDocumentTransactions = transactions;
                    
                    // ذخیره در IndexedDB
                    saveCurrentDocument();
                    
                    // پاک کردن فرم
                    manualDocumentForm.reset();
                    
                    // تنظیم مجدد تاریخ به امروز
                    document.getElementById('manual-document-date').value = getTodayPersianDate();
                    
                    // بازنشانی ردیف‌ها
                    resetManualTransactionRows();
                    
                    // نمایش پیام موفقیت
                    showNotification('سند دستی با موفقیت ثبت شد!', 'success');
                    
                    // تولید خودکار سند حسابداری
                    generateAccountingDocument();
                });
                
                // رویداد افزودن حساب جدید
                addAccountBtn.addEventListener('click', function() {
                    const accountName = newAccountNameInput.value.trim();
                    const accountGroup = accountGroupSelect.value;
                    
                    if (!accountName) {
                        showNotification('لطفاً نام حساب را وارد کنید!', 'error');
                        return;
                    }
                    
                    // ایجاد حساب جدید
                    const newAccount = {
                        id: Date.now(),
                        name: accountName,
                        group: accountGroup
                    };
                    
                    // افزودن به آرایه حساب‌ها
                    accounts.push(newAccount);
                    
                    // ذخیره در IndexedDB
                    saveAccount(newAccount);
                    
                    // به‌روزرسالی dropdown و لیست حساب‌ها
                    updateAccountSelect();
                    updateAccountsList();
                    updateSubsidiaryLedgerAccountSelect();
                    
                    // پاک کردن فیلد ورودی
                    newAccountNameInput.value = '';
                    
                    // نمایش پیام موفقیت
                    showNotification('حساب جدید با موفقیت افزوده شد!', 'success');
                });
                
                // رویداد ذخیره سند
                saveDocumentBtn.addEventListener('click', function() {
                    if (currentDocumentTransactions.length === 0) {
                        showNotification('هیچ معامله‌ای برای ذخیره سند وجود ندارد!', 'error');
                        return;
                    }
                    
                    saveAccountingDocument();
                });
                
                // رویداد پاک کردن سند جاری - بدون اعلان
                clearDocumentBtn.addEventListener('click', function() {
                    currentDocumentTransactions = [];
                    saveCurrentDocument();
                    documentPreview.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-file-alt"></i>
                            <p>پس از ثبت معامله، سند حسابداری در اینجا نمایش داده می‌شود</p>
                        </div>
                    `;
                });
                
                // رویداد تغییر حساب در دفترکل
                ledgerAccountSelect.addEventListener('change', function() {
                    updateLedger(this.value);
                });
                
            }).catch(error => {
                console.error('خطا در مقداردهی اولیه برنامه:', error);
                showNotification('خطا در بارگذاری داده‌ها!', 'error');
            });
        }
        
        // توابع IndexedDB
        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    reject(new Error('خطا در باز کردن پایگاه داده'));
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve();
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    
                    // ایجاد جداول در صورت عدم وجود
                    if (!db.objectStoreNames.contains(STORE_NAMES.ACCOUNTS)) {
                        const accountsStore = db.createObjectStore(STORE_NAMES.ACCOUNTS, { keyPath: 'id' });
                        accountsStore.createIndex('name', 'name', { unique: false });
                        accountsStore.createIndex('group', 'group', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains(STORE_NAMES.DOCUMENTS)) {
                        const documentsStore = db.createObjectStore(STORE_NAMES.DOCUMENTS, { keyPath: 'id' });
                        documentsStore.createIndex('number', 'number', { unique: true });
                    }
                    
                    if (!db.objectStoreNames.contains(STORE_NAMES.CURRENT_DOCUMENT)) {
                        db.createObjectStore(STORE_NAMES.CURRENT_DOCUMENT, { keyPath: 'id' });
                    }
                    
                    if (!db.objectStoreNames.contains(STORE_NAMES.DOCUMENT_COUNTER)) {
                        db.createObjectStore(STORE_NAMES.DOCUMENT_COUNTER, { keyPath: 'id' });
                    }
                    
                    if (!db.objectStoreNames.contains(STORE_NAMES.EMPLOYEES)) {
                        db.createObjectStore(STORE_NAMES.EMPLOYEES, { keyPath: 'id' });
                    }
                    
                    if (!db.objectStoreNames.contains(STORE_NAMES.EMPLOYEE_MONTHLY_DATA)) {
                        db.createObjectStore(STORE_NAMES.EMPLOYEE_MONTHLY_DATA, { keyPath: 'id' });
                    }
                    
                    if (!db.objectStoreNames.contains(STORE_NAMES.FISCAL_PERIOD)) {
                        db.createObjectStore(STORE_NAMES.FISCAL_PERIOD, { keyPath: 'id' });
                    }
                    
                    if (!db.objectStoreNames.contains(STORE_NAMES.SETTINGS)) {
                        db.createObjectStore(STORE_NAMES.SETTINGS, { keyPath: 'id' });
                    }
                    
                    if (!db.objectStoreNames.contains(STORE_NAMES.PARTIES)) {
                        db.createObjectStore(STORE_NAMES.PARTIES, { keyPath: 'id' });
                    }
                    
                    if (!db.objectStoreNames.contains(STORE_NAMES.COMPANY_INFO)) {
                        db.createObjectStore(STORE_NAMES.COMPANY_INFO, { keyPath: 'id' });
                    }
                    
                    if (!db.objectStoreNames.contains(STORE_NAMES.INVENTORY)) {
                        db.createObjectStore(STORE_NAMES.INVENTORY, { keyPath: 'id' });
                    }
                    
                    if (!db.objectStoreNames.contains(STORE_NAMES.INVOICES)) {
                        const invoicesStore = db.createObjectStore(STORE_NAMES.INVOICES, { keyPath: 'id' });
                        invoicesStore.createIndex('number', 'number', { unique: true });
                    }
                    
                    if (!db.objectStoreNames.contains(STORE_NAMES.INVOICE_COUNTER)) {
                        db.createObjectStore(STORE_NAMES.INVOICE_COUNTER, { keyPath: 'id' });
                    }
                };
            });
        }
        
        // بارگذاری حساب‌ها از IndexedDB
        function loadAccounts() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.ACCOUNTS], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.ACCOUNTS);
                const request = store.getAll();
                
                request.onsuccess = () => {
                    accounts = request.result;
                    
                    // اگر حساب‌ها خالی هستند، حساب‌های پیش‌فرض را اضافه کن
                    if (accounts.length === 0) {
                        const defaultAccounts = [
                            { id: 1, name: 'موجودی نقد-بانک', group: 'asset', isSystem: true },
                            { id: 2, name: 'حساب های دریافتنی', group: 'asset', isSystem: true },
                            { id: 3, name: 'حساب های پرداختنی', group: 'liability', isSystem: true },
                            { id: 4, name: 'اسناد دریافتنی', group: 'asset', isSystem: true },
                            { id: 5, name: 'اسناد پرداختنی', group: 'liability', isSystem: true },
                            { id: 8, name: 'هزینه', group: 'expense', isSystem: false },
                            { id: 9, name: 'درآمد', group: 'income', isSystem: false },
                            { id: 10, name: 'سرمایه', group: 'equity', isSystem: true }
                        ];
                        
                        const transaction = db.transaction([STORE_NAMES.ACCOUNTS], 'readwrite');
                        const store = transaction.objectStore(STORE_NAMES.ACCOUNTS);
                        
                        defaultAccounts.forEach(account => {
                            store.add(account);
                        });
                        
                        accounts = defaultAccounts;
                    }
                    
                    resolve();
                };
                
                request.onerror = () => {
                    reject(new Error('خطا در بارگذاری حساب‌ها'));
                };
            });
        }
        
        // بارگذاری اسناد از IndexedDB
        function loadDocuments() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.DOCUMENTS], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.DOCUMENTS);
                const request = store.getAll();
                
                request.onsuccess = () => {
                    savedDocuments = request.result;
                    resolve();
                };
                
                request.onerror = () => {
                    reject(new Error('خطا در بارگذاری اسناد'));
                };
            });
        }
        
        // بارگذاری شمارنده اسناد از IndexedDB
        function loadDocumentCounter() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.DOCUMENT_COUNTER], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.DOCUMENT_COUNTER);
                const request = store.get(1);
                
                request.onsuccess = () => {
                    if (request.result) {
                        documentCounter = request.result.value;
                    } else {
                        // اگر شمارنده وجود ندارد، مقدار پیش‌فرض را تنظیم کن
                        documentCounter = 1;
                        saveDocumentCounter();
                    }
                    resolve();
                };
                
                request.onerror = () => {
                    reject(new Error('خطا در بارگذاری شمارنده اسناد'));
                };
            });
        }
        
        // بارگذاری شمارنده فاکتورها از IndexedDB
        function loadInvoiceCounter() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.INVOICE_COUNTER], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.INVOICE_COUNTER);
                const request = store.get(1);
                
                request.onsuccess = () => {
                    if (request.result) {
                        invoiceCounter = request.result.value;
                    } else {
                        // اگر شمارنده وجود ندارد، مقدار پیش‌فرض را تنظیم کن
                        invoiceCounter = 1;
                        saveInvoiceCounter();
                    }
                    resolve();
                };
                
                request.onerror = () => {
                    reject(new Error('خطا در بارگذاری شمارنده فاکتورها'));
                };
            });
        }
        
        // بارگذاری سند جاری از IndexedDB
        function loadCurrentDocument() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.CURRENT_DOCUMENT], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.CURRENT_DOCUMENT);
                const request = store.get(1);
                
                request.onsuccess = () => {
                    if (request.result) {
                        currentDocumentTransactions = request.result.transactions || [];
                    } else {
                        currentDocumentTransactions = [];
                    }
                    resolve();
                };
                
                request.onerror = () => {
                    reject(new Error('خطا در بارگذاری سند جاری'));
                };
            });
        }
        
        // بارگذاری پرسنل از IndexedDB
        function loadEmployees() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.EMPLOYEES], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.EMPLOYEES);
                const request = store.getAll();
                
                request.onsuccess = () => {
                    employees = request.result;
                    resolve();
                };
                
                request.onerror = () => {
                    reject(new Error('خطا در بارگذاری پرسنل'));
                };
            });
        }
        
        // بارگذاری اطلاعات ماهانه پرسنل از IndexedDB
        function loadEmployeeMonthlyData() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.EMPLOYEE_MONTHLY_DATA], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.EMPLOYEE_MONTHLY_DATA);
                const request = store.getAll();
                
                request.onsuccess = () => {
                    employeeMonthlyData = request.result;
                    resolve();
                };
                
                request.onerror = () => {
                    reject(new Error('خطا در بارگذاری اطلاعات ماهانه پرسنل'));
                };
            });
        }
        
        // بارگذاری دوره مالی از IndexedDB
        function loadFiscalPeriod() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.FISCAL_PERIOD], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.FISCAL_PERIOD);
                const request = store.get(1);
                
                request.onsuccess = () => {
                    if (request.result) {
                        fiscalPeriod = request.result;
                        fiscalPeriodStart.value = fiscalPeriod.startDate || '';
                        fiscalPeriodEnd.value = fiscalPeriod.endDate || '';
                    }
                    resolve();
                };
                
                request.onerror = () => {
                    reject(new Error('خطا در بارگذاری دوره مالی'));
                };
            });
        }
        
        // بارگذاری تنظیمات از IndexedDB
        function loadSettings() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.SETTINGS], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.SETTINGS);
                const request = store.get(1);
                
                request.onsuccess = () => {
                    if (request.result) {
                        settings = request.result;
                    }
                    resolve();
                };
                
                request.onerror = () => {
                    reject(new Error('خطا در بارگذاری تنظیمات'));
                };
            });
        }
        
        // بارگذاری طرف‌های حساب از IndexedDB
        function loadParties() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.PARTIES], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.PARTIES);
                const request = store.getAll();
                
                request.onsuccess = () => {
                    parties = request.result;
                    resolve();
                };
                
                request.onerror = () => {
                    reject(new Error('خطا در بارگذاری طرف‌های حساب'));
                };
            });
        }
        
        // بارگذاری اطلاعات شرکت از IndexedDB
        function loadCompanyInfo() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.COMPANY_INFO], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.COMPANY_INFO);
                const request = store.get(1);
                
                request.onsuccess = () => {
                    if (request.result) {
                        companyInfo = request.result;
                    }
                    resolve();
                };
                
                request.onerror = () => {
                    reject(new Error('خطا در بارگذاری اطلاعات شرکت'));
                };
            });
        }
        
        // بارگذاری کالاها از IndexedDB
        function loadInventory() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.INVENTORY], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.INVENTORY);
                const request = store.getAll();
                
                request.onsuccess = () => {
                    inventory = request.result;
                    resolve();
                };
                
                request.onerror = () => {
                    reject(new Error('خطا در بارگذاری کالاها'));
                };
            });
        }
        
        // بارگذاری فاکتورها از IndexedDB
        function loadInvoices() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.INVOICES], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.INVOICES);
                const request = store.getAll();
                
                request.onsuccess = () => {
                    savedInvoices = request.result;
                    resolve();
                };
                
                request.onerror = () => {
                    reject(new Error('خطا در بارگذاری فاکتورها'));
                };
            });
        }
        
        // ذخیره حساب در IndexedDB
        function saveAccount(account) {
            const transaction = db.transaction([STORE_NAMES.ACCOUNTS], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.ACCOUNTS);
            store.put(account);
        }
        
        // ذخیره سند در IndexedDB
        function saveDocument(document) {
            const transaction = db.transaction([STORE_NAMES.DOCUMENTS], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.DOCUMENTS);
            store.put(document);
        }
        
        // ذخیره شمارنده اسناد در IndexedDB
        function saveDocumentCounter() {
            const transaction = db.transaction([STORE_NAMES.DOCUMENT_COUNTER], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.DOCUMENT_COUNTER);
            store.put({ id: 1, value: documentCounter });
        }
        
        // ذخیره شمارنده فاکتورها در IndexedDB
        function saveInvoiceCounter() {
            const transaction = db.transaction([STORE_NAMES.INVOICE_COUNTER], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.INVOICE_COUNTER);
            store.put({ id: 1, value: invoiceCounter });
        }
        
        // ذخیره سند جاری در IndexedDB
        function saveCurrentDocument() {
            const transaction = db.transaction([STORE_NAMES.CURRENT_DOCUMENT], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.CURRENT_DOCUMENT);
            store.put({ id: 1, transactions: currentDocumentTransactions });
        }
        
        // ذخیره پرسنل در IndexedDB
        function saveEmployee(employee) {
            const transaction = db.transaction([STORE_NAMES.EMPLOYEES], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.EMPLOYEES);
            store.put(employee);
        }
        
        // ذخیره اطلاعات ماهانه پرسنل در IndexedDB
        function saveEmployeeMonthlyData(monthlyData) {
            const transaction = db.transaction([STORE_NAMES.EMPLOYEE_MONTHLY_DATA], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.EMPLOYEE_MONTHLY_DATA);
            store.put(monthlyData);
        }
        
        // ذخیره دوره مالی در IndexedDB
        function saveFiscalPeriodToDB() {
            const transaction = db.transaction([STORE_NAMES.FISCAL_PERIOD], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.FISCAL_PERIOD);
            store.put({ id: 1, ...fiscalPeriod });
        }
        
        // ذخیره تنظیمات در IndexedDB
        function saveSettingsToDB() {
            const transaction = db.transaction([STORE_NAMES.SETTINGS], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.SETTINGS);
            store.put({ id: 1, ...settings });
        }
        
        // ذخیره طرف حساب در IndexedDB
        function saveParty(party) {
            const transaction = db.transaction([STORE_NAMES.PARTIES], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.PARTIES);
            store.put(party);
        }
        
        // ذخیره اطلاعات شرکت در IndexedDB
        function saveCompanyInfoToDB() {
            const transaction = db.transaction([STORE_NAMES.COMPANY_INFO], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.COMPANY_INFO);
            store.put({ id: 1, ...companyInfo });
        }
        
        // ذخیره کالا در IndexedDB
        function saveProduct(product) {
            const transaction = db.transaction([STORE_NAMES.INVENTORY], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.INVENTORY);
            store.put(product);
        }
        
        // ذخیره فاکتور در IndexedDB
        function saveInvoiceToDB(invoice) {
            const transaction = db.transaction([STORE_NAMES.INVOICES], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.INVOICES);
            store.put(invoice);
        }
        
        // حذف حساب از IndexedDB
        function deleteAccountFromDB(accountId) {
            const transaction = db.transaction([STORE_NAMES.ACCOUNTS], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.ACCOUNTS);
            store.delete(accountId);
        }
        
        // حذف سند از IndexedDB
        function deleteDocumentFromDB(documentId) {
            const transaction = db.transaction([STORE_NAMES.DOCUMENTS], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.DOCUMENTS);
            store.delete(documentId);
        }
        
        // حذف پرسنل از IndexedDB
        function deleteEmployeeFromDB(employeeId) {
            const transaction = db.transaction([STORE_NAMES.EMPLOYEES], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.EMPLOYEES);
            store.delete(employeeId);
        }
        
        // حذف اطلاعات ماهانه پرسنل از IndexedDB
        function deleteEmployeeMonthlyDataFromDB(monthlyDataId) {
            const transaction = db.transaction([STORE_NAMES.EMPLOYEE_MONTHLY_DATA], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.EMPLOYEE_MONTHLY_DATA);
            store.delete(monthlyDataId);
        }
        
        // حذف طرف حساب از IndexedDB
        function deletePartyFromDB(partyId) {
            const transaction = db.transaction([STORE_NAMES.PARTIES], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.PARTIES);
            store.delete(partyId);
        }
        
        // حذف کالا از IndexedDB
        function deleteProductFromDB(productId) {
            const transaction = db.transaction([STORE_NAMES.INVENTORY], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.INVENTORY);
            store.delete(productId);
        }
        
        // حذف فاکتور از IndexedDB
        function deleteInvoiceFromDB(invoiceId) {
            const transaction = db.transaction([STORE_NAMES.INVOICES], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.INVOICES);
            store.delete(invoiceId);
        }
        
        // تابع تبدیل مبلغ به عدد
        function parseAmount(amountText) {
            // حذف کاراکترهای غیرعددی به جز نقطه و کاما
            let cleaned = amountText.replace(/[^\d.,]/g, '');
            
            // اگر کاما به عنوان جداکننده هزارگان استفاده شده، حذف شود
            cleaned = cleaned.replace(/,/g, '');
            
            // تبدیل به عدد
            return parseFloat(cleaned);
        }
        
        // تابع دریافت تاریخ امروز به صورت شمسی
        function getTodayPersianDate() {
            const today = new Date();
            const persianDate = today.toLocaleDateString('fa-IR');
            return persianDate;
        }
        
        // تابع تبدیل اعداد به فارسی
        function toPersianNumbers(number) {
            const persianDigits = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            return number.toString().replace(/\d/g, digit => persianDigits[parseInt(digit)]);
        }
        
        // تابع به‌روزرسانی عنوان صفحه
        function updatePageTitle(tabId) {
            const titles = {
                'transaction': {
                    title: 'ثبت معامله جدید',
                    description: 'در این بخش می‌توانید معاملات مالی خود را ثبت و مدیریت کنید',
                    formTitle: 'فرم ثبت معامله'
                },
                'documents': {
                    title: 'اسناد ذخیره شده',
                    description: 'در این بخش می‌توانید اسناد حسابداری ذخیره شده را مشاهده کنید',
                    formTitle: 'لیست اسناد'
                },
                'ledgers': {
                    title: 'دفاتر حسابداری',
                    description: 'در این بخش می‌توانید دفتر روزنامه، دفترکل و دفتر معین را مشاهده کنید',
                    formTitle: 'دفاتر حسابداری'
                },
                'reports': {
                    title: 'گزارشات مالی',
                    description: 'در این بخش می‌توانید گزارشات مالی شامل سود و زیان، تراز آزمایشی و ترازنامه را مشاهده کنید',
                    formTitle: 'گزارشات مالی'
                },
                'salary': {
                    title: 'حقوق و دستمزد',
                    description: 'در این بخش می‌توانید حقوق پرسنل را مدیریت کنید',
                    formTitle: 'مدیریت حقوق'
                },
                'inventory': {
                    title: 'انبار',
                    description: 'در این بخش می‌توانید کالاها را مدیریت کنید',
                    formTitle: 'مدیریت انبار'
                },
                'invoice': {
                    title: 'فاکتور فروش/خدمات',
                    description: 'در این بخش می‌توانید فاکتور صادر کنید',
                    formTitle: 'فاکتور فروش/خدمات'
                },
                'accounts': {
                    title: 'مدیریت حساب‌ها',
                    description: 'در این بخش می‌توانید حساب‌های مالی خود را مدیریت کنید',
                    formTitle: 'لیست حساب‌ها'
                },
                'dashboard': {
                    title: 'داشبورد مدیریتی',
                    description: 'نمایش کلی وضعیت مالی و مدیریت سیستم',
                    formTitle: 'داشبورد'
                }
            };
            
            const titleInfo = titles[tabId];
            pageTitle.innerHTML = `<i class="fas fa-${getTabIcon(tabId)}"></i> ${titleInfo.title}`;
            pageDescription.textContent = titleInfo.description;
            formTitle.innerHTML = `<i class="fas fa-${getTabIcon(tabId)}"></i> ${titleInfo.formTitle}`;
        }
        
        // تابع دریافت آیکون مربوط به تب
        function getTabIcon(tabId) {
            const icons = {
                'transaction': 'edit',
                'documents': 'file-invoice',
                'ledgers': 'book',
                'reports': 'chart-bar',
                'salary': 'money-bill-wave',
                'inventory': 'warehouse',
                'invoice': 'receipt',
                'accounts': 'wallet',
                'dashboard': 'user'
            };
            return icons[tabId];
        }
        
        // تابع دریافت متن نوع پرداخت
        function getPaymentTypeText(paymentType) {
            const types = {
                'cash': 'نقد',
                'credit': 'نسیه',
                'check': 'چک-سفته'
            };
            return types[paymentType] || paymentType;
        }
        
        // تابع دریافت متن گروه حساب
        function getAccountGroupText(group) {
            const groups = {
                'asset': 'دارایی',
                'liability': 'بدهی',
                'equity': 'حقوق صاحبان سهام',
                'income': 'درآمد',
                'expense': 'هزینه'
            };
            return groups[group] || group;
        }
        
        // تابع به‌روزرسانی dropdown حساب‌ها
        function updateAccountSelect() {
            let html = '<option value="">انتخاب کنید</option>';
            accounts.forEach(account => {
                // فقط حساب‌های غیرسیستمی را نمایش بده
                if (!account.isSystem) {
                    html += `<option value="${account.id}">${account.name}</option>`;
                }
            });
            
            accountSelect.innerHTML = html;
            
            // به‌روزرسانی dropdown حساب‌ها در دفترکل
            let ledgerHtml = '<option value="">انتخاب حساب برای مشاهده دفترکل</option>';
            accounts.forEach(account => {
                // فقط حساب‌هایی که مانده دارند را نمایش بده
                if (hasAccountBalance(account.id)) {
                    ledgerHtml += `<option value="${account.id}">${account.name}</option>`;
                }
            });
            
            ledgerAccountSelect.innerHTML = ledgerHtml;
            
            // به‌روزرسانی dropdown حساب‌ها در فرم سند دستی - نمایش همه حساب‌ها
            const manualAccountSelects = document.querySelectorAll('.manual-account');
            let manualHtml = '<option value="">انتخاب کنید</option>';
            accounts.forEach(account => {
                manualHtml += `<option value="${account.id}">${account.name}</option>`;
            });
            
            manualAccountSelects.forEach(select => {
                select.innerHTML = manualHtml;
            });
        }
        
        // تابع بررسی مانده حساب
        function hasAccountBalance(accountId) {
            let balance = 0;
            
            // بررسی اسناد ذخیره شده
            savedDocuments.forEach(document => {
                document.transactions.forEach(transaction => {
                    // اگر سند دستی است، محاسبه مستقیم بدهکار و بستانکار
                    if (transaction.isManual) {
                        if (transaction.accountId == accountId) {
                            balance += (transaction.debit || 0) - (transaction.credit || 0);
                        }
                    } else {
                        // منطق جدید: حساب انتخاب شده در فرم برعکس نوع معامله و نوع پرداخت ثبت می‌شود
                        
                        if (transaction.transactionType === 'receipt') {
                            // دریافت: حساب انتخاب شده بستانکار می‌شود
                            let debitAccount = '';
                            
                            // تعیین حساب بدهکار بر اساس نوع پرداخت
                            switch(transaction.paymentType) {
                                case 'cash':
                                    debitAccount = 'موجودی نقد-بانک';
                                    break;
                                case 'credit':
                                    debitAccount = 'حساب های دریافتنی';
                                    break;
                                case 'check':
                                    debitAccount = 'اسناد دریافتنی';
                                    break;
                            }
                            
                            // پیدا کردن حساب بدهکار
                            const debitAcc = accounts.find(acc => acc.name === debitAccount);
                            if (debitAcc && debitAcc.id == accountId) {
                                balance += transaction.amount;
                            }
                            
                            // حساب انتخاب شده بستانکار می‌شود
                            if (transaction.accountId == accountId) {
                                balance -= transaction.amount;
                            }
                        } else if (transaction.transactionType === 'payment') {
                            // پرداخت: حساب انتخاب شده بدهکار می‌شود
                            let creditAccount = '';
                            
                            // تعیین حساب بستانکار بر اساس نوع پرداخت
                            switch(transaction.paymentType) {
                                case 'cash':
                                    creditAccount = 'موجودی نقد-بانک';
                                    break;
                                case 'credit':
                                    creditAccount = 'حساب های پرداختنی';
                                    break;
                                case 'check':
                                    creditAccount = 'اسناد پرداختنی';
                                    break;
                            }
                            
                            // حساب انتخاب شده بدهکار می‌شود
                            if (transaction.accountId == accountId) {
                                balance += transaction.amount;
                            }
                            
                            // پیدا کردن حساب بستانکار
                            const creditAcc = accounts.find(acc => acc.name === creditAccount);
                            if (creditAcc && creditAcc.id == accountId) {
                                balance -= transaction.amount;
                            }
                        }
                    }
                });
            });
            
            // بررسی سند جاری
            currentDocumentTransactions.forEach(transaction => {
                // اگر سند دستی است، محاسبه مستقیم بدهکار و بستانکار
                if (transaction.isManual) {
                    if (transaction.accountId == accountId) {
                        balance += (transaction.debit || 0) - (transaction.credit || 0);
                    }
                } else {
                    // منطق جدید: حساب انتخاب شده در فرم برعکس نوع معامله و نوع پرداخت ثبت می‌شود
                    
                    if (transaction.transactionType === 'receipt') {
                        // دریافت: حساب انتخاب شده بستانکار می‌شود
                        let debitAccount = '';
                        
                        // تعیین حساب بدهکار بر اساس نوع پرداخت
                        switch(transaction.paymentType) {
                            case 'cash':
                                debitAccount = 'موجودی نقد-بانک';
                                break;
                            case 'credit':
                                debitAccount = 'حساب های دریافتنی';
                                break;
                            case 'check':
                                debitAccount = 'اسناد دریافتنی';
                                break;
                        }
                        
                        // پیدا کردن حساب بدهکار
                        const debitAcc = accounts.find(acc => acc.name === debitAccount);
                        if (debitAcc && debitAcc.id == accountId) {
                            balance += transaction.amount;
                        }
                        
                        // حساب انتخاب شده بستانکار می‌شود
                        if (transaction.accountId == accountId) {
                            balance -= transaction.amount;
                        }
                    } else if (transaction.transactionType === 'payment') {
                        // پرداخت: حساب انتخاب شده بدهکار می‌شود
                        let creditAccount = '';
                        
                        // تعیین حساب بستانکار بر اساس نوع پرداخت
                        switch(transaction.paymentType) {
                            case 'cash':
                                creditAccount = 'موجودی نقد-بانک';
                                break;
                            case 'credit':
                                creditAccount = 'حساب های پرداختنی';
                                break;
                            case 'check':
                                creditAccount = 'اسناد پرداختنی';
                                break;
                        }
                        
                        // حساب انتخاب شده بدهکار می‌شود
                        if (transaction.accountId == accountId) {
                            balance += transaction.amount;
                        }
                        
                        // پیدا کردن حساب بستانکار
                        const creditAcc = accounts.find(acc => acc.name === creditAccount);
                        if (creditAcc && creditAcc.id == accountId) {
                            balance -= transaction.amount;
                        }
                    }
                }
            });
            
            return balance !== 0;
        }
        
        // تابع به‌روزرسانی dropdown طرف حساب‌ها
        function updatePartySelect() {
            let html = '<option value="">انتخاب کنید</option>';
            parties.forEach(party => {
                html += `<option value="${party.id}">${party.name}</option>`;
            });
            
            partySelect.innerHTML = html;
        }
        
        // تابع به‌روزرسانی dropdown دفتر معین
        function updateSubsidiaryLedgerAccountSelect() {
            let html = '<option value="">انتخاب حساب برای مشاهده دفتر معین</option>';
            
            // اضافه کردن حساب‌های مربوط به طرف حساب‌ها
            parties.forEach(party => {
                html += `<option value="receivable-${party.id}">حساب های دریافتنی-${party.name}</option>`;
                html += `<option value="payable-${party.id}">حساب های پرداختنی-${party.name}</option>`;
                html += `<option value="notes-receivable-${party.id}">اسناد دریافتنی-${party.name}</option>`;
                html += `<option value="notes-payable-${party.id}">اسناد پرداختنی-${party.name}</option>`;
            });
            
            // حذف حساب‌های حقوق پرداختنی برای هر پرسنل (طبق درخواست)
            
            subsidiaryLedgerAccountSelect.innerHTML = html;
        }
        
        // تابع به‌روزرسانی لیست حساب‌ها
        function updateAccountsList() {
            // فقط حساب‌های غیرسیستمی را نمایش بده
            const userAccounts = accounts.filter(account => !account.isSystem);
            
            if (userAccounts.length === 0) {
                accountsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-wallet"></i>
                        <p>هیچ حسابی ثبت نشده است</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            userAccounts.forEach(account => {
                html += `
                    <div class="account-item">
                        <div>
                            <div>${account.name}</div>
                            <small class="text-muted">${getAccountGroupText(account.group)}</small>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="deleteAccount(${account.id})">
                            <i class="fas fa-trash"></i>
                            حذف
                        </button>
                    </div>
                `;
            });
            
            accountsList.innerHTML = html;
        }
        
        // تابع به‌روزرسانی لیست اسناد
        function updateDocumentsList() {
            if (savedDocuments.length === 0) {
                documentsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-file-invoice"></i>
                        <p>هیچ سندی ذخیره نشده است</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            savedDocuments.forEach(document => {
                // ایجاد شرح از معاملات
                let descriptionText = document.transactions[0]?.description || '';
                
                html += `
                    <div class="document-item">
                        <div class="document-info">
                            <div class="document-title">سند شماره ${toPersianNumbers(document.number)}</div>
                            <div class="document-meta">
                                <div class="document-meta-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>${document.date}</span>
                                </div>
                                <div class="document-meta-item">
                                    <i class="fas fa-money-bill-wave"></i>
                                    <span>${formatCurrency(document.totalAmount)}</span>
                                </div>
                            </div>
                            <div class="document-description-preview">
                                ${descriptionText}
                            </div>
                        </div>
                        <div class="document-actions">
                            <button class="document-action-btn view" onclick="viewDocument(${document.id})">
                                <i class="fas fa-eye"></i>
                                مشاهده
                            </button>
                            <button class="document-action-btn delete" onclick="deleteDocument(${document.id})">
                                <i class="fas fa-trash"></i>
                                حذف
                            </button>
                        </div>
                    </div>
                `;
            });
            
            documentsList.innerHTML = html;
        }
        
        // تابع به‌روزرسانی لیست پرسنل
        function updateEmployeesList() {
            if (employees.length === 0) {
                salaryEmployeesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>هیچ پرسنلی ثبت نشده است</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            employees.forEach(employee => {
                const totalSalary = (employee.dailySalary || 0) + (employee.hourlySalary || 0) + 
                                  (employee.housingAllowance || 0) + (employee.marriageAllowance || 0) + 
                                  (employee.childAllowance || 0) + (employee.foodAllowance || 0) + 
                                  (employee.workerBonus || 0) + (employee.seniorityBase || 0);
                
                html += `
                    <div class="salary-employee-item">
                        <div class="salary-employee-details">
                            <div class="salary-employee-name">${employee.name}</div>
                            <div class="salary-employee-info">
                                <span>کد ملی: ${employee.nationalId}</span>
                                <span>تاریخ استخدام: ${employee.hireDate}</span>
                                <span>حقوق پایه روزانه: ${formatCurrency(employee.dailySalary)}</span>
                            </div>
                        </div>
                        <div class="salary-employee-actions">
                            <button class="btn btn-danger btn-sm" onclick="deleteEmployee(${employee.id})">
                                <i class="fas fa-trash"></i>
                                حذف
                            </button>
                        </div>
                    </div>
                `;
            });
            
            salaryEmployeesList.innerHTML = html;
        }
        
        // تابع به‌روزرسانی dropdown پرسنل برای اطلاعات ماهانه
        function updateMonthlyEmployeeSelect() {
            let html = '<option value="">انتخاب کنید</option>';
            employees.forEach(employee => {
                html += `<option value="${employee.id}">${employee.name}</option>`;
            });
            
            monthlyEmployeeSelect.innerHTML = html;
        }
        
        // تابع به‌روزرسانی لیست طرف‌های حساب
        function updatePartiesList() {
            if (parties.length === 0) {
                partiesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-address-book"></i>
                        <p>هیچ طرف حسابی ثبت نشده است</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            parties.forEach(party => {
                html += `
                    <div class="party-item">
                        <div>
                            <div>${party.name}</div>
                            <small class="text-muted">شماره تماس: ${party.phone} | آدرس: ${party.address}</small>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="deleteParty(${party.id})">
                            <i class="fas fa-trash"></i>
                            حذف
                        </button>
                    </div>
                `;
            });
            
            partiesList.innerHTML = html;
        }
        
        // تابع به‌روزرسانی اطلاعات شرکت
        function updateCompanyInfo() {
            // تنظیم نوع شرکت
            if (companyInfo.type === 'legal') {
                companyTypeBtns[0].classList.add('active');
                companyTypeBtns[1].classList.remove('active');
                companyRegistrationCodeGroup.style.display = 'block';
                companyNationalCodeGroup.style.display = 'none';
            } else {
                companyTypeBtns[0].classList.remove('active');
                companyTypeBtns[1].classList.add('active');
                companyRegistrationCodeGroup.style.display = 'none';
                companyNationalCodeGroup.style.display = 'block';
            }
            
            companyNameInput.value = companyInfo.name || '';
            companyEconomicCodeInput.value = companyInfo.economicCode || '';
            companyRegistrationCodeInput.value = companyInfo.registrationCode || '';
            companyNationalCodeInput.value = companyInfo.nationalCode || '';
            companyPhoneInput.value = companyInfo.phone || '';
            companyAddressInput.value = companyInfo.address || '';
            companyPostalCodeInput.value = companyInfo.postalCode || '';
        }
        
        // تابع به‌روزرسانی لیست کالاها
        function updateInventoryList() {
            if (inventory.length === 0) {
                inventoryList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-boxes"></i>
                        <p>هیچ کالا/خدماتی ثبت نشده است</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            inventory.forEach(product => {
                html += `
                    <div class="inventory-item">
                        <div>
                            <div>${product.name}</div>
                            <small class="text-muted">کد کالا/خدمات: ${product.code} | بهای واحد: ${formatCurrency(product.price)}</small>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="deleteProduct(${product.id})">
                            <i class="fas fa-trash"></i>
                            حذف
                        </button>
                    </div>
                `;
            });
            
            inventoryList.innerHTML = html;
        }
        
        // تابع به‌روزرسانی dropdown طرف‌های حساب در فاکتور
        function updateInvoicePartySelect() {
            let html = '<option value="">انتخاب کنید</option>';
            parties.forEach(party => {
                html += `<option value="${party.id}">${party.name}</option>`;
            });
            
            invoicePartySelect.innerHTML = html;
        }
        
        // تابع به‌روزرسانی dropdown کالاها در فاکتور
        function updateInvoiceProductSelect() {
            let html = '<option value="">انتخاب کنید</option>';
            inventory.forEach(product => {
                html += `<option value="${product.id}" data-code="${product.code}" data-name="${product.name}" data-price="${product.price}">${product.code} - ${product.name}</option>`;
            });
            
            invoiceProductSelect.innerHTML = html;
        }
        
        // تابع به‌روزرسانی لیست فاکتورهای ذخیره شده
        function updateSavedInvoicesList() {
            if (savedInvoices.length === 0) {
                savedInvoicesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-file-invoice"></i>
                        <p>هیچ فاکتوری ذخیره شده است</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            savedInvoices.forEach(invoice => {
                html += `
                    <div class="saved-invoice-item">
                        <div class="saved-invoice-info">
                            <div class="saved-invoice-title">فاکتور شماره ${invoice.number}</div>
                            <div class="saved-invoice-meta">
                                <div class="saved-invoice-meta-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>${invoice.date}</span>
                                </div>
                                <div class="saved-invoice-meta-item">
                                    <i class="fas fa-user"></i>
                                    <span>${invoice.partyName}</span>
                                </div>
                                <div class="saved-invoice-meta-item">
                                    <i class="fas fa-money-bill-wave"></i>
                                    <span>${formatCurrency(invoice.grandTotal)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="saved-invoice-actions">
                            <button class="document-action-btn print" onclick="printSavedInvoice(${invoice.id})">
                                <i class="fas fa-print"></i>
                                چاپ
                            </button>
                            <button class="document-action-btn delete" onclick="deleteInvoice(${invoice.id})">
                                <i class="fas fa-trash"></i>
                                حذف
                            </button>
                        </div>
                    </div>
                `;
            });
            
            savedInvoicesList.innerHTML = html;
        }
        
        // تابع به‌روزرسانی دفتر روزنامه - بهبود یافته
        function updateJournal() {
            if (savedDocuments.length === 0) {
                journalBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <i class="fas fa-book"></i>
                            <p>هیچ سندی برای نمایش در دفتر روزنامه وجود ندارد</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            // مرتب‌سازی اسناد بر اساس تاریخ
            const sortedDocuments = [...savedDocuments].sort((a, b) => {
                return new Date(b.date) - new Date(a.date);
            });
            
            sortedDocuments.forEach(document => {
                // برای هر سند، ردیف‌های مربوط به آن را اضافه کن
                document.transactions.forEach((transaction, index) => {
                    // فقط اولین ردیف تاریخ را نمایش بده
                    const showDate = index === 0;
                    // فقط اولین ردیف شماره سند را نمایش بده
                    const showDocumentNumber = index === 0;
                    
                    // اگر سند دستی است، نمایش مستقیم بدهکار و بستانکار
                    if (transaction.isManual) {
                        html += `
                            <tr>
                                <td class="document-number-cell">${showDocumentNumber ? toPersianNumbers(document.number) : ''}</td>
                                <td class="date-cell">${showDate ? document.date : ''}</td>
                                <td class="description-cell">${transaction.accountName}</td>
                                <td class="amount-cell">${transaction.debit > 0 ? formatCurrency(transaction.debit) : '-'}</td>
                                <td class="amount-cell">${transaction.credit > 0 ? formatCurrency(transaction.credit) : '-'}</td>
                            </tr>
                        `;
                    } else {
                        // منطق جدید: حساب انتخاب شده در فرم برعکس نوع معامله و نوع پرداخت ثبت می‌شود
                        
                        if (transaction.transactionType === 'receipt') {
                            // دریافت: حساب انتخاب شده بستانکار می‌شود
                            let debitAccount = '';
                            
                            // تعیین حساب بدهکار بر اساس نوع پرداخت
                            switch(transaction.paymentType) {
                                case 'cash':
                                    debitAccount = 'موجودی نقد-بانک';
                                    break;
                                case 'credit':
                                    debitAccount = transaction.partyName ? `حساب های دریافتنی-${transaction.partyName}` : 'حساب های دریافتنی';
                                    break;
                                case 'check':
                                    debitAccount = transaction.partyName ? `اسناد دریافتنی-${transaction.partyName}` : 'اسناد دریافتنی';
                                    break;
                            }
                            
                            html += `
                                <tr>
                                    <td class="document-number-cell">${showDocumentNumber ? toPersianNumbers(document.number) : ''}</td>
                                    <td class="date-cell">${showDate ? document.date : ''}</td>
                                    <td class="description-cell">${debitAccount}</td>
                                    <td class="amount-cell">${formatCurrency(transaction.amount)}</td>
                                    <td class="amount-cell">-</td>
                                </tr>
                                <tr>
                                    <td class="document-number-cell"></td>
                                    <td class="date-cell"></td>
                                    <td class="description-cell">${transaction.accountName}</td>
                                    <td class="amount-cell">-</td>
                                    <td class="amount-cell">${formatCurrency(transaction.amount)}</td>
                                </tr>
                            `;
                        } else if (transaction.transactionType === 'payment') {
                            // پرداخت: حساب انتخاب شده بدهکار می‌شود
                            let creditAccount = '';
                            
                            // تعیین حساب بستانکار بر اساس نوع پرداخت
                            switch(transaction.paymentType) {
                                case 'cash':
                                    creditAccount = 'موجودی نقد-بانک';
                                    break;
                                case 'credit':
                                    creditAccount = transaction.partyName ? `حساب های پرداختنی-${transaction.partyName}` : 'حساب های پرداختنی';
                                    break;
                                case 'check':
                                    creditAccount = transaction.partyName ? `اسناد پرداختنی-${transaction.partyName}` : 'اسناد پرداختنی';
                                    break;
                            }
                            
                            html += `
                                <tr>
                                    <td class="document-number-cell">${showDocumentNumber ? toPersianNumbers(document.number) : ''}</td>
                                    <td class="date-cell">${showDate ? document.date : ''}</td>
                                    <td class="description-cell">${transaction.accountName}</td>
                                    <td class="amount-cell">${formatCurrency(transaction.amount)}</td>
                                    <td class="amount-cell">-</td>
                                </tr>
                                <tr>
                                    <td class="document-number-cell"></td>
                                    <td class="date-cell"></td>
                                    <td class="description-cell">${creditAccount}</td>
                                    <td class="amount-cell">-</td>
                                    <td class="amount-cell">${formatCurrency(transaction.amount)}</td>
                                </tr>
                            `;
                        }
                    }
                });
                
                // اضافه کردن ردیف شرح سند
                html += `
                    <tr style="background-color: rgba(0,0,0,0.03);">
                        <td class="document-number-cell"></td>
                        <td class="date-cell"></td>
                        <td class="description-cell" style="text-align: right; font-style: italic;">${document.transactions[0]?.description || ''}</td>
                        <td class="amount-cell"></td>
                        <td class="amount-cell"></td>
                    </tr>
                `;
            });
            
            journalBody.innerHTML = html;
        }
        
        // تابع به‌روزرسانی آمار
        function updateStatistics() {
            updateProfitLoss();
            updateTrialBalance();
            updateBalanceSheet();
        }
        
        // تابع به‌روزرسانی صورت سود و زیان
        function updateProfitLoss() {
            // محاسبه درآمدها و هزینه‌ها
            let totalIncome = 0;
            let totalExpense = 0;
            
            // بررسی اسناد ذخیره شده
            savedDocuments.forEach(document => {
                document.transactions.forEach(transaction => {
                    // اگر سند دستی است، محاسبه مستقیم بدهکار و بستانکار
                    if (transaction.isManual) {
                        const account = accounts.find(acc => acc.id == transaction.accountId);
                        if (account) {
                            if (account.group === 'income') {
                                totalIncome += transaction.credit || 0;
                            } else if (account.group === 'expense') {
                                totalExpense += transaction.debit || 0;
                            }
                        }
                    } else {
                        // منطق جدید: حساب انتخاب شده در فرم برعکس نوع معامله و نوع پرداخت ثبت می‌شود
                        
                        if (transaction.transactionType === 'receipt') {
                            // دریافت: حساب انتخاب شده بستانکار می‌شود
                            const account = accounts.find(acc => acc.id == transaction.accountId);
                            if (account && account.group === 'income') {
                                totalIncome += transaction.amount;
                            }
                        } else if (transaction.transactionType === 'payment') {
                            // پرداخت: حساب انتخاب شده بدهکار می‌شود
                            const account = accounts.find(acc => acc.id == transaction.accountId);
                            if (account && account.group === 'expense') {
                                totalExpense += transaction.amount;
                            }
                        }
                    }
                });
            });
            
            // محاسبه از سند جاری
            currentDocumentTransactions.forEach(transaction => {
                // اگر سند دستی است، محاسبه مستقیم بدهکار و بستانکار
                if (transaction.isManual) {
                    const account = accounts.find(acc => acc.id == transaction.accountId);
                    if (account) {
                        if (account.group === 'income') {
                            totalIncome += transaction.credit || 0;
                        } else if (account.group === 'expense') {
                            totalExpense += transaction.debit || 0;
                        }
                    }
                } else {
                    // منطق جدید: حساب انتخاب شده در فرم برعکس نوع معامله و نوع پرداخت ثبت می‌شود
                    
                    if (transaction.transactionType === 'receipt') {
                        // دریافت: حساب انتخاب شده بستانکار می‌شود
                        const account = accounts.find(acc => acc.id == transaction.accountId);
                        if (account && account.group === 'income') {
                            totalIncome += transaction.amount;
                        }
                    } else if (transaction.transactionType === 'payment') {
                        // پرداخت: حساب انتخاب شده بدهکار می‌شود
                        const account = accounts.find(acc => acc.id == transaction.accountId);
                        if (account && account.group === 'expense') {
                            totalExpense += transaction.amount;
                        }
                    }
                }
            });
            
            const netProfit = totalIncome - totalExpense;
            
            let html = '';
            
            if (totalIncome === 0 && totalExpense === 0) {
                html = `
                    <tr>
                        <td colspan="2" class="empty-state">
                            <i class="fas fa-chart-line"></i>
                            <p>داده‌ای برای محاسبه سود و زیان وجود ندارد</p>
                        </td>
                    </tr>
                `;
            } else {
                html = `
                    <tr>
                        <td>جمع درآمدها</td>
                        <td class="positive">${formatCurrency(totalIncome)}</td>
                    </tr>
                    <tr>
                        <td>جمع هزینه‌ها</td>
                        <td class="negative">${formatCurrency(totalExpense)}</td>
                    </tr>
                    <tr style="background-color: rgba(0,0,0,0.05); font-weight: bold;">
                        <td>سود (زیان) خالص</td>
                        <td class="${netProfit >= 0 ? 'positive' : 'negative'}">${formatCurrency(Math.abs(netProfit))}</td>
                    </tr>
                `;
            }
            
            profitLossBody.innerHTML = html;
        }
        
        // تابع به‌روزرسانی تراز آزمایشی - بهبود یافته برای نمایش اسناد دستی
        function updateTrialBalance() {
            if (savedDocuments.length === 0 && currentDocumentTransactions.length === 0) {
                trialBalanceBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="empty-state">
                            <i class="fas fa-chart-bar"></i>
                            <p>هیچ معامله‌ای برای محاسبه تراز آزمایشی وجود ندارد</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // محاسبه مانده هر حساب
            const accountBalances = {};
            
            // مقداردهی اولیه
            accounts.forEach(account => {
                accountBalances[account.id] = {
                    name: account.name,
                    group: account.group,
                    debit: 0,
                    credit: 0
                };
            });
            
            // محاسبه از اسناد ذخیره شده
            savedDocuments.forEach(document => {
                document.transactions.forEach(transaction => {
                    // اگر سند دستی است، محاسبه مستقیم بدهکار و بستانکار
                    if (transaction.isManual) {
                        accountBalances[transaction.accountId].debit += transaction.debit || 0;
                        accountBalances[transaction.accountId].credit += transaction.credit || 0;
                    } else {
                        // منطق جدید: حساب انتخاب شده در فرم برعکس نوع معامله و نوع پرداخت ثبت می‌شود
                        
                        if (transaction.transactionType === 'receipt') {
                            // دریافت: حساب انتخاب شده بستانکار می‌شود
                            let debitAccount = '';
                            
                            // تعیین حساب بدهکار بر اساس نوع پرداخت
                            switch(transaction.paymentType) {
                                case 'cash':
                                    debitAccount = 'موجودی نقد-بانک';
                                    break;
                                case 'credit':
                                    debitAccount = 'حساب های دریافتنی';
                                    break;
                                case 'check':
                                    debitAccount = 'اسناد دریافتنی';
                                    break;
                            }
                            
                            // پیدا کردن حساب بدهکار
                            const debitAcc = accounts.find(acc => acc.name === debitAccount);
                            if (debitAcc) {
                                accountBalances[debitAcc.id].debit += transaction.amount;
                            }
                            
                            // حساب انتخاب شده بستانکار می‌شود
                            accountBalances[transaction.accountId].credit += transaction.amount;
                        } else if (transaction.transactionType === 'payment') {
                            // پرداخت: حساب انتخاب شده بدهکار می‌شود
                            let creditAccount = '';
                            
                            // تعیین حساب بستانکار بر اساس نوع پرداخت
                            switch(transaction.paymentType) {
                                case 'cash':
                                    creditAccount = 'موجودی نقد-بانک';
                                    break;
                                case 'credit':
                                    creditAccount = 'حساب های پرداختنی';
                                    break;
                                case 'check':
                                    creditAccount = 'اسناد پرداختنی';
                                    break;
                            }
                            
                            // حساب انتخاب شده بدهکار می‌شود
                            accountBalances[transaction.accountId].debit += transaction.amount;
                            
                            // پیدا کردن حساب بستانکار
                            const creditAcc = accounts.find(acc => acc.name === creditAccount);
                            if (creditAcc) {
                                accountBalances[creditAcc.id].credit += transaction.amount;
                            }
                        }
                    }
                });
            });
            
            // محاسبه از سند جاری
            currentDocumentTransactions.forEach(transaction => {
                // اگر سند دستی است، محاسبه مستقیم بدهکار و بستانکار
                if (transaction.isManual) {
                    accountBalances[transaction.accountId].debit += transaction.debit || 0;
                    accountBalances[transaction.accountId].credit += transaction.credit || 0;
                } else {
                    // منطق جدید: حساب انتخاب شده در فرم برعکس نوع معامله و نوع پرداخت ثبت می‌شود
                    
                    if (transaction.transactionType === 'receipt') {
                        // دریافت: حساب انتخاب شده بستانکار می‌شود
                        let debitAccount = '';
                        
                        // تعیین حساب بدهکار بر اساس نوع پرداخت
                        switch(transaction.paymentType) {
                            case 'cash':
                                debitAccount = 'موجودی نقد-بانک';
                                break;
                            case 'credit':
                                debitAccount = 'حساب های دریافتنی';
                                break;
                            case 'check':
                                debitAccount = 'اسناد دریافتنی';
                                break;
                        }
                        
                        // پیدا کردن حساب بدهکار
                        const debitAcc = accounts.find(acc => acc.name === debitAccount);
                        if (debitAcc) {
                            accountBalances[debitAcc.id].debit += transaction.amount;
                        }
                        
                        // حساب انتخاب شده بستانکار می‌شود
                        accountBalances[transaction.accountId].credit += transaction.amount;
                    } else if (transaction.transactionType === 'payment') {
                        // پرداخت: حساب انتخاب شده بدهکار می‌شود
                        let creditAccount = '';
                        
                        // تعیین حساب بستانکار بر اساس نوع پرداخت
                        switch(transaction.paymentType) {
                            case 'cash':
                                creditAccount = 'موجودی نقد-بانک';
                                break;
                            case 'credit':
                                creditAccount = 'حساب های پرداختنی';
                                break;
                            case 'check':
                                creditAccount = 'اسناد پرداختنی';
                                break;
                        }
                        
                        // حساب انتخاب شده بدهکار می‌شود
                        accountBalances[transaction.accountId].debit += transaction.amount;
                        
                        // پیدا کردن حساب بستانکار
                        const creditAcc = accounts.find(acc => acc.name === creditAccount);
                        if (creditAcc) {
                            accountBalances[creditAcc.id].credit += transaction.amount;
                        }
                    }
                }
            });
            
            let html = '';
            let totalDebit = 0;
            let totalCredit = 0;
            
            // نمایش حساب‌هایی که مانده دارند
            Object.values(accountBalances).forEach(account => {
                if (account.debit > 0 || account.credit > 0) {
                    totalDebit += account.debit;
                    totalCredit += account.credit;
                    
                    html += `
                        <tr>
                            <td class="account-name">${account.name}</td>
                            <td class="debit">${account.debit > 0 ? formatCurrency(account.debit) : '-'}</td>
                            <td class="credit">${account.credit > 0 ? formatCurrency(account.credit) : '-'}</td>
                        </tr>
                    `;
                }
            });
            
            // اضافه کردن ردیف جمع کل
            html += `
                <tr style="background-color: rgba(44, 90, 160, 0.1); font-weight: bold;">
                    <td class="account-name">جمع کل</td>
                    <td class="debit">${formatCurrency(totalDebit)}</td>
                    <td class="credit">${formatCurrency(totalCredit)}</td>
                </tr>
            `;
            
            trialBalanceBody.innerHTML = html;
        }
        
        // تابع به‌روزرسانی دفترکل - بهبود یافته برای نمایش اسناد دستی
        function updateLedger(accountId) {
            if (!accountId) {
                ledgerBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <i class="fas fa-book"></i>
                            <p>لطفاً یک حساب را برای مشاهده دفترکل انتخاب کنید</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const account = accounts.find(acc => acc.id == accountId);
            if (!account) {
                ledgerBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>حساب انتخاب شده معتبر نیست</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // جمع‌آوری تمام معاملات مربوط به این حساب
            const ledgerEntries = [];
            let balance = 0;
            
            // بررسی اسناد ذخیره شده
            savedDocuments.forEach(document => {
                document.transactions.forEach(transaction => {
                    // بررسی معاملات مربوط به حساب انتخاب شده
                    if (transaction.accountId == accountId) {
                        let debit = 0;
                        let credit = 0;
                        
                        // اگر سند دستی است، محاسبه مستقیم بدهکار و بستانکار
                        if (transaction.isManual) {
                            debit = transaction.debit || 0;
                            credit = transaction.credit || 0;
                            balance += debit - credit;
                        } else {
                            if (transaction.transactionType === 'receipt') {
                                credit = transaction.amount;
                                balance -= transaction.amount;
                            } else if (transaction.transactionType === 'payment') {
                                debit = transaction.amount;
                                balance += transaction.amount;
                            }
                        }
                        
                        ledgerEntries.push({
                            date: document.date,
                            description: transaction.description,
                            debit: debit,
                            credit: credit,
                            balance: balance
                        });
                    }
                    
                    // بررسی معاملات مربوط به حساب‌های مرتبط (برای اسناد غیردستی)
                    if (!transaction.isManual) {
                        let relatedAccount = '';
                        if (transaction.transactionType === 'receipt') {
                            // دریافت: حساب انتخاب شده بستانکار می‌شود
                            let debitAccount = '';
                            
                            // تعیین حساب بدهکار بر اساس نوع پرداخت
                            switch(transaction.paymentType) {
                                case 'cash':
                                    debitAccount = 'موجودی نقد-بانک';
                                    break;
                                case 'credit':
                                    debitAccount = 'حساب های دریافتنی';
                                    break;
                                case 'check':
                                    debitAccount = 'اسناد دریافتنی';
                                    break;
                            }
                            
                            if (debitAccount === account.name) {
                                debit = transaction.amount;
                                credit = 0;
                                balance += transaction.amount;
                                
                                ledgerEntries.push({
                                    date: document.date,
                                    description: transaction.description,
                                    debit: debit,
                                    credit: credit,
                                    balance: balance
                                });
                            }
                        } else if (transaction.transactionType === 'payment') {
                            // پرداخت: حساب انتخاب شده بدهکار می‌شود
                            let creditAccount = '';
                            
                            // تعیین حساب بستانکار بر اساس نوع پرداخت
                            switch(transaction.paymentType) {
                                case 'cash':
                                    creditAccount = 'موجودی نقد-بانک';
                                    break;
                                case 'credit':
                                    creditAccount = 'حساب های پرداختنی';
                                    break;
                                case 'check':
                                    creditAccount = 'اسناد پرداختنی';
                                    break;
                            }
                            
                            if (creditAccount === account.name) {
                                debit = 0;
                                credit = transaction.amount;
                                balance -= transaction.amount;
                                
                                ledgerEntries.push({
                                    date: document.date,
                                    description: transaction.description,
                                    debit: debit,
                                    credit: credit,
                                    balance: balance
                                });
                            }
                        }
                    }
                });
            });
            
            // بررسی سند جاری
            currentDocumentTransactions.forEach(transaction => {
                // بررسی معاملات مربوط به حساب انتخاب شده
                if (transaction.accountId == accountId) {
                    let debit = 0;
                    let credit = 0;
                    
                    // اگر سند دستی است، محاسبه مستقیم بدهکار و بستانکار
                    if (transaction.isManual) {
                        debit = transaction.debit || 0;
                        credit = transaction.credit || 0;
                        balance += debit - credit;
                    } else {
                        if (transaction.transactionType === 'receipt') {
                            credit = transaction.amount;
                            balance -= transaction.amount;
                        } else if (transaction.transactionType === 'payment') {
                            debit = transaction.amount;
                            balance += transaction.amount;
                        }
                    }
                    
                    ledgerEntries.push({
                        date: transaction.date,
                        description: transaction.description,
                        debit: debit,
                        credit: credit,
                        balance: balance
                    });
                }
                
                // بررسی معاملات مربوط به حساب‌های مرتبط (برای اسناد غیردستی)
                if (!transaction.isManual) {
                    let relatedAccount = '';
                    if (transaction.transactionType === 'receipt') {
                        // دریافت: حساب انتخاب شده بستانکار می‌شود
                        let debitAccount = '';
                        
                        // تعیین حساب بدهکار بر اساس نوع پرداخت
                        switch(transaction.paymentType) {
                            case 'cash':
                                debitAccount = 'موجودی نقد-بانک';
                                break;
                            case 'credit':
                                debitAccount = 'حساب های دریافتنی';
                                break;
                            case 'check':
                                debitAccount = 'اسناد دریافتنی';
                                break;
                        }
                        
                        if (debitAccount === account.name) {
                            debit = transaction.amount;
                            credit = 0;
                            balance += transaction.amount;
                            
                            ledgerEntries.push({
                                date: transaction.date,
                                description: transaction.description,
                                debit: debit,
                                credit: credit,
                                balance: balance
                            });
                        }
                    } else if (transaction.transactionType === 'payment') {
                        // پرداخت: حساب انتخاب شده بدهکار می‌شود
                        let creditAccount = '';
                        
                        // تعیین حساب بستانکار بر اساس نوع پرداخت
                        switch(transaction.paymentType) {
                            case 'cash':
                                creditAccount = 'موجودی نقد-بانک';
                                break;
                            case 'credit':
                                creditAccount = 'حساب های پرداختنی';
                                break;
                            case 'check':
                                creditAccount = 'اسناد پرداختنی';
                                break;
                        }
                        
                        if (creditAccount === account.name) {
                            debit = 0;
                            credit = transaction.amount;
                            balance -= transaction.amount;
                            
                            ledgerEntries.push({
                                date: transaction.date,
                                description: transaction.description,
                                debit: debit,
                                credit: credit,
                                balance: balance
                            });
                        }
                    }
                }
            });
            
            // مرتب‌سازی بر اساس تاریخ
            ledgerEntries.sort((a, b) => {
                return new Date(b.date) - new Date(a.date);
            });
            
            if (ledgerEntries.length === 0) {
                ledgerBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <i class="fas fa-book"></i>
                            <p>هیچ معامله‌ای برای حساب "${account.name}" ثبت نشده است</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            ledgerEntries.forEach(entry => {
                const balanceType = entry.balance >= 0 ? 'بد' : 'بس';
                
                html += `
                    <tr>
                        <td class="date-cell">${entry.date}</td>
                        <td class="description-cell">${entry.description}</td>
                        <td class="amount-cell">${entry.debit > 0 ? formatCurrency(entry.debit) : '-'}</td>
                        <td class="amount-cell">${entry.credit > 0 ? formatCurrency(entry.credit) : '-'}</td>
                        <td class="balance-cell">
                            <div class="balance-with-type">
                                <div class="balance-value">${formatCurrency(Math.abs(entry.balance))}</div>
                                <div class="balance-type">${balanceType}</div>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            ledgerBody.innerHTML = html;
        }
        
        // تابع به‌روزرسانی دفتر معین
        function updateSubsidiaryLedger(accountId) {
            if (!accountId) {
                subsidiaryLedgerBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <i class="fas fa-book"></i>
                            <p>لطفاً یک حساب را برای مشاهده دفتر معین انتخاب کنید</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // استخراج نوع حساب و شناسه طرف حساب
            const parts = accountId.split('-');
            const accountType = parts[0];
            const partyId = parts[1];
            
            if (!accountType || !partyId) {
                subsidiaryLedgerBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>حساب انتخاب شده معتبر نیست</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const party = parties.find(p => p.id == partyId);
            if (!party) {
                subsidiaryLedgerBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>طرف حساب انتخاب شده معتبر نیست</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // تعیین نام حساب بر اساس نوع
            let accountName = '';
            switch(accountType) {
                case 'receivable':
                    accountName = `حساب های دریافتنی-${party.name}`;
                    break;
                case 'payable':
                    accountName = `حساب های پرداختنی-${party.name}`;
                    break;
                case 'notes-receivable':
                    accountName = `اسناد دریافتنی-${party.name}`;
                    break;
                case 'notes-payable':
                    accountName = `اسناد پرداختنی-${party.name}`;
                    break;
            }
            
            // جمع‌آوری تمام معاملات مربوط به این حساب
            const ledgerEntries = [];
            let balance = 0;
            
            // بررسی اسناد ذخیره شده
            savedDocuments.forEach(document => {
                document.transactions.forEach(transaction => {
                    // بررسی معاملات مربوط به حساب انتخاب شده
                    if (!transaction.isManual && transaction.partyId == partyId) {
                        let debit = 0;
                        let credit = 0;
                        
                        if (transaction.transactionType === 'receipt') {
                            // دریافت: حساب انتخاب شده بستانکار می‌شود
                            let debitAccount = '';
                            
                            // تعیین حساب بدهکار بر اساس نوع پرداخت
                            switch(transaction.paymentType) {
                                case 'cash':
                                    debitAccount = 'موجودی نقد-بانک';
                                    break;
                                case 'credit':
                                    debitAccount = `حساب های دریافتنی-${party.name}`;
                                    break;
                                case 'check':
                                    debitAccount = `اسناد دریافتنی-${party.name}`;
                                    break;
                            }
                            
                            if (debitAccount === accountName) {
                                debit = transaction.amount;
                                credit = 0;
                                balance += transaction.amount;
                                
                                ledgerEntries.push({
                                    date: document.date,
                                    description: transaction.description,
                                    debit: debit,
                                    credit: credit,
                                    balance: balance
                                });
                            }
                        } else if (transaction.transactionType === 'payment') {
                            // پرداخت: حساب انتخاب شده بدهکار می‌شود
                            let creditAccount = '';
                            
                            // تعیین حساب بستانکار بر اساس نوع پرداخت
                            switch(transaction.paymentType) {
                                case 'cash':
                                    creditAccount = 'موجودی نقد-بانک';
                                    break;
                                case 'credit':
                                    creditAccount = `حساب های پرداختنی-${party.name}`;
                                    break;
                                case 'check':
                                    creditAccount = `اسناد پرداختنی-${party.name}`;
                                    break;
                            }
                            
                            if (creditAccount === accountName) {
                                debit = 0;
                                credit = transaction.amount;
                                balance -= transaction.amount;
                                
                                ledgerEntries.push({
                                    date: document.date,
                                    description: transaction.description,
                                    debit: debit,
                                    credit: credit,
                                    balance: balance
                                });
                            }
                        }
                    }
                });
            });
            
            // بررسی سند جاری
            currentDocumentTransactions.forEach(transaction => {
                // بررسی معاملات مربوط به حساب انتخاب شده
                if (!transaction.isManual && transaction.partyId == partyId) {
                    let debit = 0;
                    let credit = 0;
                    
                    if (transaction.transactionType === 'receipt') {
                        // دریافت: حساب انتخاب شده بستانکار می‌شود
                        let debitAccount = '';
                        
                        // تعیین حساب بدهکار بر اساس نوع پرداخت
                        switch(transaction.paymentType) {
                            case 'cash':
                                debitAccount = 'موجودی نقد-بانک';
                                break;
                            case 'credit':
                                debitAccount = `حساب های دریافتنی-${party.name}`;
                                break;
                            case 'check':
                                debitAccount = `اسناد دریافتنی-${party.name}`;
                                break;
                        }
                        
                        if (debitAccount === accountName) {
                            debit = transaction.amount;
                            credit = 0;
                            balance += transaction.amount;
                            
                            ledgerEntries.push({
                                date: transaction.date,
                                description: transaction.description,
                                debit: debit,
                                credit: credit,
                                balance: balance
                            });
                        }
                    } else if (transaction.transactionType === 'payment') {
                        // پرداخت: حساب انتخاب شده بدهکار می‌شود
                        let creditAccount = '';
                        
                        // تعیین حساب بستانکار بر اساس نوع پرداخت
                        switch(transaction.paymentType) {
                            case 'cash':
                                creditAccount = 'موجودی نقد-بانک';
                                break;
                            case 'credit':
                                creditAccount = `حساب های پرداختنی-${party.name}`;
                                break;
                            case 'check':
                                creditAccount = `اسناد پرداختنی-${party.name}`;
                                break;
                        }
                        
                        if (creditAccount === accountName) {
                            debit = 0;
                            credit = transaction.amount;
                            balance -= transaction.amount;
                            
                            ledgerEntries.push({
                                date: transaction.date,
                                description: transaction.description,
                                debit: debit,
                                credit: credit,
                                balance: balance
                            });
                        }
                    }
                }
            });
            
            // مرتب‌سازی بر اساس تاریخ
            ledgerEntries.sort((a, b) => {
                return new Date(b.date) - new Date(a.date);
            });
            
            if (ledgerEntries.length === 0) {
                subsidiaryLedgerBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <i class="fas fa-book"></i>
                            <p>هیچ معامله‌ای برای حساب "${accountName}" ثبت نشده است</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            ledgerEntries.forEach(entry => {
                const balanceType = entry.balance >= 0 ? 'بد' : 'بس';
                
                html += `
                    <tr>
                        <td class="date-cell">${entry.date}</td>
                        <td class="description-cell">${entry.description}</td>
                        <td class="amount-cell">${entry.debit > 0 ? formatCurrency(entry.debit) : '-'}</td>
                        <td class="amount-cell">${entry.credit > 0 ? formatCurrency(entry.credit) : '-'}</td>
                        <td class="balance-cell">
                            <div class="balance-with-type">
                                <div class="balance-value">${formatCurrency(Math.abs(entry.balance))}</div>
                                <div class="balance-type">${balanceType}</div>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            subsidiaryLedgerBody.innerHTML = html;
        }
        
        // تابع به‌روزرسانی ترازنامه
        function updateBalanceSheet() {
            // محاسبه جمع دارایی‌ها و بدهی‌ها
            let totalAssets = 0;
            let totalLiabilities = 0;
            let totalEquity = 0;
            
            // محاسبه مانده هر حساب
            const accountBalances = {};
            
            // مقداردهی اولیه
            accounts.forEach(account => {
                accountBalances[account.id] = {
                    name: account.name,
                    group: account.group,
                    debit: 0,
                    credit: 0
                };
            });
            
            // محاسبه از اسناد ذخیره شده
            savedDocuments.forEach(document => {
                document.transactions.forEach(transaction => {
                    // اگر سند دستی است، محاسبه مستقیم بدهکار و بستانکار
                    if (transaction.isManual) {
                        accountBalances[transaction.accountId].debit += transaction.debit || 0;
                        accountBalances[transaction.accountId].credit += transaction.credit || 0;
                    } else {
                        // منطق جدید: حساب انتخاب شده در فرم برعکس نوع معامله و نوع پرداخت ثبت می‌شود
                        
                        if (transaction.transactionType === 'receipt') {
                            // دریافت: حساب انتخاب شده بستانکار می‌شود
                            let debitAccount = '';
                            
                            // تعیین حساب بدهکار بر اساس نوع پرداخت
                            switch(transaction.paymentType) {
                                case 'cash':
                                    debitAccount = 'موجودی نقد-بانک';
                                    break;
                                case 'credit':
                                    debitAccount = 'حساب های دریافتنی';
                                    break;
                                case 'check':
                                    debitAccount = 'اسناد دریافتنی';
                                    break;
                            }
                            
                            // پیدا کردن حساب بدهکار
                            const debitAcc = accounts.find(acc => acc.name === debitAccount);
                            if (debitAcc) {
                                accountBalances[debitAcc.id].debit += transaction.amount;
                            }
                            
                            // حساب انتخاب شده بستانکار می‌شود
                            accountBalances[transaction.accountId].credit += transaction.amount;
                        } else if (transaction.transactionType === 'payment') {
                            // پرداخت: حساب انتخاب شده بدهکار می‌شود
                            let creditAccount = '';
                            
                            // تعیین حساب بستانکار بر اساس نوع پرداخت
                            switch(transaction.paymentType) {
                                case 'cash':
                                    creditAccount = 'موجودی نقد-بانک';
                                    break;
                                case 'credit':
                                    creditAccount = 'حساب های پرداختنی';
                                    break;
                                case 'check':
                                    creditAccount = 'اسناد پرداختنی';
                                    break;
                            }
                            
                            // حساب انتخاب شده بدهکار می‌شود
                            accountBalances[transaction.accountId].debit += transaction.amount;
                            
                            // پیدا کردن حساب بستانکار
                            const creditAcc = accounts.find(acc => acc.name === creditAccount);
                            if (creditAcc) {
                                accountBalances[creditAcc.id].credit += transaction.amount;
                            }
                        }
                    }
                });
            });
            
            // محاسبه از سند جاری
            currentDocumentTransactions.forEach(transaction => {
                // اگر سند دستی است، محاسبه مستقیم بدهکار و بستانکار
                if (transaction.isManual) {
                    accountBalances[transaction.accountId].debit += transaction.debit || 0;
                    accountBalances[transaction.accountId].credit += transaction.credit || 0;
                } else {
                    // منطق جدید: حساب انتخاب شده در فرم برعکس نوع معامله و نوع پرداخت ثبت می‌شود
                    
                    if (transaction.transactionType === 'receipt') {
                        // دریافت: حساب انتخاب شده بستانکار می‌شود
                        let debitAccount = '';
                        
                        // تعیین حساب بدهکار بر اساس نوع پرداخت
                        switch(transaction.paymentType) {
                            case 'cash':
                                debitAccount = 'موجودی نقد-بانک';
                                break;
                            case 'credit':
                                debitAccount = 'حساب های دریافتنی';
                                break;
                            case 'check':
                                debitAccount = 'اسناد دریافتنی';
                                break;
                        }
                        
                        // پیدا کردن حساب بدهکار
                        const debitAcc = accounts.find(acc => acc.name === debitAccount);
                        if (debitAcc) {
                            accountBalances[debitAcc.id].debit += transaction.amount;
                        }
                        
                        // حساب انتخاب شده بستانکار می‌شود
                        accountBalances[transaction.accountId].credit += transaction.amount;
                    } else if (transaction.transactionType === 'payment') {
                        // پرداخت: حساب انتخاب شده بدهکار می‌شود
                        let creditAccount = '';
                        
                        // تعیین حساب بستانکار بر اساس نوع پرداخت
                        switch(transaction.paymentType) {
                            case 'cash':
                                creditAccount = 'موجودی نقد-بانک';
                                break;
                            case 'credit':
                                creditAccount = 'حساب های پرداختنی';
                                break;
                            case 'check':
                                creditAccount = 'اسناد پرداختنی';
                                break;
                        }
                        
                        // حساب انتخاب شده بدهکار می‌شود
                        accountBalances[transaction.accountId].debit += transaction.amount;
                        
                        // پیدا کردن حساب بستانکار
                        const creditAcc = accounts.find(acc => acc.name === creditAccount);
                        if (creditAcc) {
                            accountBalances[creditAcc.id].credit += transaction.amount;
                        }
                    }
                }
            });
            
            // محاسبه مانده هر حساب
            const accountNetBalances = {};
            Object.keys(accountBalances).forEach(accountId => {
                const account = accountBalances[accountId];
                const netBalance = account.debit - account.credit;
                accountNetBalances[accountId] = netBalance;
            });
            
            // محاسبه جمع دارایی‌ها، بدهی‌ها و سرمایه
            accounts.forEach(account => {
                const netBalance = accountNetBalances[account.id] || 0;
                
                if (account.group === 'asset') {
                    totalAssets += netBalance > 0 ? netBalance : 0;
                } else if (account.group === 'liability') {
                    totalLiabilities += netBalance < 0 ? Math.abs(netBalance) : 0;
                } else if (account.group === 'equity') {
                    totalEquity += netBalance < 0 ? Math.abs(netBalance) : 0;
                }
            });
            
            // محاسبه سود و زیان خالص
            let totalIncome = 0;
            let totalExpense = 0;
            
            accounts.forEach(account => {
                const netBalance = accountNetBalances[account.id] || 0;
                
                if (account.group === 'income') {
                    totalIncome += netBalance < 0 ? Math.abs(netBalance) : 0;
                } else if (account.group === 'expense') {
                    totalExpense += netBalance > 0 ? netBalance : 0;
                }
            });
            
            const netProfit = totalIncome - totalExpense;
            totalEquity += netProfit; // اضافه کردن سود خالص به سرمایه
            
            let html = '';
            
            if (totalAssets === 0 && totalLiabilities === 0 && totalEquity === 0) {
                html = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <i class="fas fa-balance-scale"></i>
                            <p>داده‌ای برای محاسبه ترازنامه وجود ندارد</p>
                        </td>
                    </tr>
                `;
            } else {
                // نمایش دارایی‌ها
                html += `
                    <tr>
                        <td><strong>دارایی‌ها</strong></td>
                        <td></td>
                        <td><strong>بدهی‌ها و سرمایه</strong></td>
                        <td></td>
                    </tr>
                `;
                
                // نمایش حساب‌های دارایی
                accounts.forEach(account => {
                    if (account.group === 'asset') {
                        const netBalance = accountNetBalances[account.id] || 0;
                        if (netBalance > 0) {
                            html += `
                                <tr>
                                    <td>${account.name}</td>
                                    <td>${formatCurrency(netBalance)}</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                            `;
                        }
                    }
                });
                
                // نمایش جمع دارایی‌ها
                html += `
                    <tr class="total-row">
                        <td><strong>جمع دارایی‌ها</strong></td>
                        <td><strong>${formatCurrency(totalAssets)}</strong></td>
                        <td></td>
                        <td></td>
                    </tr>
                `;
                
                // نمایش حساب‌های بدهی
                accounts.forEach(account => {
                    if (account.group === 'liability') {
                        const netBalance = accountNetBalances[account.id] || 0;
                        if (netBalance < 0) {
                            html += `
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td>${account.name}</td>
                                    <td>${formatCurrency(Math.abs(netBalance))}</td>
                                </tr>
                            `;
                        }
                    }
                });
                
                // نمایش حساب‌های سرمایه
                accounts.forEach(account => {
                    if (account.group === 'equity') {
                        const netBalance = accountNetBalances[account.id] || 0;
                        if (netBalance < 0) {
                            html += `
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td>${account.name}</td>
                                    <td>${formatCurrency(Math.abs(netBalance))}</td>
                                </tr>
                            `;
                        }
                    }
                });
                
                // نمایش سود/زیان خالص
                html += `
                    <tr>
                        <td></td>
                        <td></td>
                        <td>سود (زیان) خالص</td>
                        <td>${formatCurrency(Math.abs(netProfit))}</td>
                    </tr>
                `;
                
                // نمایش جمع بدهی‌ها و سرمایه
                html += `
                    <tr class="total-row">
                        <td></td>
                        <td></td>
                        <td><strong>جمع بدهی‌ها و سرمایه</strong></td>
                        <td><strong>${formatCurrency(totalLiabilities + totalEquity)}</strong></td>
                    </tr>
                `;
            }
            
            balanceSheetBody.innerHTML = html;
        }
        
        // تابع حذف حساب
        function deleteAccount(accountId) {
            if (confirm('آیا از حذف این حساب اطمینان دارید؟')) {
                // بررسی استفاده از حساب در معاملات
                let accountInUse = false;
                
                // بررسی در اسناد ذخیره شده
                savedDocuments.forEach(document => {
                    if (document.transactions.some(transaction => transaction.accountId == accountId)) {
                        accountInUse = true;
                    }
                });
                
                // بررسی در سند جاری
                if (currentDocumentTransactions.some(transaction => transaction.accountId == accountId)) {
                    accountInUse = true;
                }
                
                if (accountInUse) {
                    showNotification('این حساب در معاملات استفاده شده و قابل حذف نیست!', 'error');
                    return;
                }
                
                // حذف حساب از آرایه
                accounts = accounts.filter(account => account.id !== accountId);
                
                // حذف از IndexedDB
                deleteAccountFromDB(accountId);
                
                // به‌روزرسانی dropdown و لیست حساب‌ها
                updateAccountSelect();
                updateAccountsList();
                updateSubsidiaryLedgerAccountSelect();
                
                // نمایش پیام موفقیت
                showNotification('حساب با موفقیت حذف شد!', 'success');
            }
        }
        
        // تابع حذف پرسنل
        function deleteEmployee(employeeId) {
            if (confirm('آیا از حذف این پرسنل اطمینان دارید؟')) {
                // حذف پرسنل از آرایه
                employees = employees.filter(employee => employee.id !== employeeId);
                
                // حذف اطلاعات ماهانه مربوط به این پرسنل
                employeeMonthlyData = employeeMonthlyData.filter(data => data.employeeId !== employeeId);
                
                // حذف از IndexedDB
                deleteEmployeeFromDB(employeeId);
                
                // حذف اطلاعات ماهانه از IndexedDB
                employeeMonthlyData.forEach(data => {
                    if (data.employeeId === employeeId) {
                        deleteEmployeeMonthlyDataFromDB(data.id);
                    }
                });
                
                // به‌روزرسانی لیست پرسنل
                updateEmployeesList();
                updateMonthlyEmployeeSelect();
                
                // نمایش پیام موفقیت
                showNotification('پرسنل با موفقیت حذف شد!', 'success');
            }
        }
        
        // تابع حذف طرف حساب
        function deleteParty(partyId) {
            if (confirm('آیا از حذف این طرف حساب اطمینان دارید؟')) {
                // حذف طرف حساب از آرایه
                parties = parties.filter(party => party.id !== partyId);
                
                // حذف از IndexedDB
                deletePartyFromDB(partyId);
                
                // به‌روزرسانی لیست طرف‌های حساب
                updatePartiesList();
                updateInvoicePartySelect();
                updatePartySelect();
                updateSubsidiaryLedgerAccountSelect();
                
                // نمایش پیام موفقیت
                showNotification('طرف حساب با موفقیت حذف شد!', 'success');
            }
        }
        
        // تابع حذف کالا
        function deleteProduct(productId) {
            if (confirm('آیا از حذف این کالا اطمینان دارید؟')) {
                // حذف کالا از آرایه
                inventory = inventory.filter(product => product.id !== productId);
                
                // حذف از IndexedDB
                deleteProductFromDB(productId);
                
                // به‌روزرسانی لیست کالاها
                updateInventoryList();
                updateInvoiceProductSelect();
                
                // نمایش پیام موفقیت
                showNotification('کالا با موفقیت حذف شد!', 'success');
            }
        }
        
        // تابع حذف فاکتور
        function deleteInvoice(invoiceId) {
            if (confirm('آیا از حذف این فاکتور اطمینان دارید؟')) {
                // حذف فاکتور از آرایه
                savedInvoices = savedInvoices.filter(invoice => invoice.id !== invoiceId);
                
                // حذف از IndexedDB
                deleteInvoiceFromDB(invoiceId);
                
                // به‌روزرسانی لیست فاکتورها
                updateSavedInvoicesList();
                
                // نمایش پیام موفقیت
                showNotification('فاکتور با موفقیت حذف شد!', 'success');
            }
        }
        
        // تابع تولید سند حسابداری با منطق جدید
        function generateAccountingDocument() {
            let documentDate = getTodayPersianDate();
            
            // محاسبه جمع مبالغ برای شرح
            let totalAmount = 0;
            let descriptionText = '';
            
            currentDocumentTransactions.forEach(transaction => {
                totalAmount += transaction.amount || transaction.debit || transaction.credit || 0;
                
                // فقط شرح را نمایش بده (بدون پرانتز)
                descriptionText = transaction.description;
            });
            
            let html = `
                <div class="accounting-document">
                    <div class="document-header">
                        <div class="document-title">سند حسابداری</div>
                        <div class="document-date">تاریخ: ${documentDate}</div>
                    </div>
                    <table class="accounting-table">
                        <thead>
                            <tr>
                                <th>شرح حساب</th>
                                <th>بدهکار (ریال)</th>
                                <th>بستانکار (ریال)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            currentDocumentTransactions.forEach(transaction => {
                // اگر سند دستی است، نمایش مستقیم بدهکار و بستانکار
                if (transaction.isManual) {
                    html += `
                        <tr>
                            <td>${transaction.accountName}</td>
                            <td class="debit">${transaction.debit > 0 ? formatCurrency(transaction.debit) : '-'}</td>
                            <td class="credit">${transaction.credit > 0 ? formatCurrency(transaction.credit) : '-'}</td>
                        </tr>
                    `;
                } else {
                    // منطق جدید: حساب انتخاب شده در فرم برعکس نوع معامله و نوع پرداخت ثبت می‌شود
                    
                    if (transaction.transactionType === 'receipt') {
                        // دریافت: حساب انتخاب شده بستانکار می‌شود
                        let debitAccount = '';
                        
                        // تعیین حساب بدهکار بر اساس نوع پرداخت
                        switch(transaction.paymentType) {
                            case 'cash':
                                debitAccount = 'موجودی نقد-بانک';
                                break;
                            case 'credit':
                                debitAccount = transaction.partyName ? `حساب های دریافتنی-${transaction.partyName}` : 'حساب های دریافتنی';
                                break;
                            case 'check':
                                debitAccount = transaction.partyName ? `اسناد دریافتنی-${transaction.partyName}` : 'اسناد دریافتنی';
                                break;
                        }
                        
                        html += `
                            <tr>
                                <td>${debitAccount}</td>
                                <td class="debit">${formatCurrency(transaction.amount)}</td>
                                <td>-</td>
                            </tr>
                            <tr>
                                <td>${transaction.accountName}</td>
                                <td>-</td>
                                <td class="credit">${formatCurrency(transaction.amount)}</td>
                            </tr>
                        `;
                    } else if (transaction.transactionType === 'payment') {
                        // پرداخت: حساب انتخاب شده بدهکار می‌شود
                        let creditAccount = '';
                        
                        // تعیین حساب بستانکار بر اساس نوع پرداخت
                        switch(transaction.paymentType) {
                            case 'cash':
                                creditAccount = 'موجودی نقد-بانک';
                                break;
                            case 'credit':
                                creditAccount = transaction.partyName ? `حساب های پرداختنی-${transaction.partyName}` : 'حساب های پرداختنی';
                                break;
                            case 'check':
                                creditAccount = transaction.partyName ? `اسناد پرداختنی-${transaction.partyName}` : 'اسناد پرداختنی';
                                break;
                        }
                        
                        html += `
                            <tr>
                                <td>${transaction.accountName}</td>
                                <td class="debit">${formatCurrency(transaction.amount)}</td>
                                <td>-</td>
                            </tr>
                            <tr>
                                <td>${creditAccount}</td>
                                <td>-</td>
                                <td class="credit">${formatCurrency(transaction.amount)}</td>
                            </tr>
                        `;
                    }
                }
            });
            
            html += `
                        </tbody>
                    </table>
                    <div class="document-description">
                        <div class="description-title">شرح سند:</div>
                        <div class="description-content">${descriptionText}</div>
                    </div>
                </div>
            `;
            
            documentPreview.innerHTML = html;
        }
        
        // تابع ذخیره سند
        function saveAccountingDocument() {
            const documentDate = getTodayPersianDate();
            
            // محاسبه جمع مبلغ کل
            let totalAmount = 0;
            currentDocumentTransactions.forEach(transaction => {
                totalAmount += transaction.amount || transaction.debit || transaction.credit || 0;
            });
            
            // ایجاد سند جدید
            const newDocument = {
                id: Date.now(),
                number: documentCounter++,
                date: documentDate,
                totalAmount: totalAmount,
                transactions: [...currentDocumentTransactions] // کپی از معاملات سند جاری
            };
            
            // افزودن به آرایه اسناد
            savedDocuments.push(newDocument);
            
            // ذخیره در IndexedDB
            saveDocument(newDocument);
            saveDocumentCounter();
            
            // پاک کردن سند جاری
            currentDocumentTransactions = [];
            saveCurrentDocument();
            
            // به‌روزرسانی لیست اسناد
            updateDocumentsList();
            
            // به‌روزرسانی دفتر روزنامه
            updateJournal();
            
            // پاک کردن پیش‌نمایش
            documentPreview.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-file-alt"></i>
                    <p>پس از ثبت معامله، سند حسابداری در اینجا نمایش داده می‌شود</p>
                </div>
            `;
            
            // نمایش پیام موفقیت
            showNotification(`سند شماره ${toPersianNumbers(newDocument.number)} با موفقیت ذخیره شد!`, 'success');
        }
        
        // تابع مشاهده سند
        function viewDocument(documentId) {
            const document = savedDocuments.find(doc => doc.id === documentId);
            
            if (!document) {
                showNotification('سند مورد نظر یافت نشد!', 'error');
                return;
            }
            
            // ایجاد شرح از معاملات
            let descriptionText = document.transactions[0]?.description || '';
            
            // نمایش سند در پیش‌نمایش
            let html = `
                <div class="accounting-document">
                    <div class="document-header">
                        <div class="document-title" style="font-size: 1.1rem;">سند حسابداری شماره ${toPersianNumbers(document.number)}</div>
                        <div class="document-date">تاریخ: ${document.date}</div>
                    </div>
                    <table class="accounting-table">
                        <thead>
                            <tr>
                                <th>شرح حساب</th>
                                <th>بدهکار (ریال)</th>
                                <th>بستانکار (ریال)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            document.transactions.forEach(transaction => {
                // اگر سند دستی است، نمایش مستقیم بدهکار و بستانکار
                if (transaction.isManual) {
                    html += `
                        <tr>
                            <td>${transaction.accountName}</td>
                            <td class="debit">${transaction.debit > 0 ? formatCurrency(transaction.debit) : '-'}</td>
                            <td class="credit">${transaction.credit > 0 ? formatCurrency(transaction.credit) : '-'}</td>
                        </tr>
                    `;
                } else {
                    // منطق جدید: حساب انتخاب شده در فرم برعکس نوع معامله و نوع پرداخت ثبت می‌شود
                    
                    if (transaction.transactionType === 'receipt') {
                        // دریافت: حساب انتخاب شده بستانکار می‌شود
                        let debitAccount = '';
                        
                        // تعیین حساب بدهکار بر اساس نوع پرداخت
                        switch(transaction.paymentType) {
                            case 'cash':
                                debitAccount = 'موجودی نقد-بانک';
                                break;
                            case 'credit':
                                debitAccount = transaction.partyName ? `حساب های دریافتنی-${transaction.partyName}` : 'حساب های دریافتنی';
                                break;
                            case 'check':
                                debitAccount = transaction.partyName ? `اسناد دریافتنی-${transaction.partyName}` : 'اسناد دریافتنی';
                                break;
                        }
                        
                        html += `
                            <tr>
                                <td>${debitAccount}</td>
                                <td class="debit">${formatCurrency(transaction.amount)}</td>
                                <td>-</td>
                            </tr>
                            <tr>
                                <td>${transaction.accountName}</td>
                                <td>-</td>
                                <td class="credit">${formatCurrency(transaction.amount)}</td>
                            </tr>
                        `;
                    } else if (transaction.transactionType === 'payment') {
                        // پرداخت: حساب انتخاب شده بدهکار می‌شود
                        let creditAccount = '';
                        
                        // تعیین حساب بستانکار بر اساس نوع پرداخت
                        switch(transaction.paymentType) {
                            case 'cash':
                                creditAccount = 'موجودی نقد-بانک';
                                break;
                            case 'credit':
                                creditAccount = transaction.partyName ? `حساب های پرداختنی-${transaction.partyName}` : 'حساب های پرداختنی';
                                break;
                            case 'check':
                                creditAccount = transaction.partyName ? `اسناد پرداختنی-${transaction.partyName}` : 'اسناد پرداختنی';
                                break;
                        }
                        
                        html += `
                            <tr>
                                <td>${transaction.accountName}</td>
                                <td class="debit">${formatCurrency(transaction.amount)}</td>
                                <td>-</td>
                            </tr>
                            <tr>
                                <td>${creditAccount}</td>
                                <td>-</td>
                                <td class="credit">${formatCurrency(transaction.amount)}</td>
                            </tr>
                        `;
                    }
                }
            });
            
            html += `
                        </tbody>
                    </table>
                    <div class="document-description">
                        <div class="description-title">شرح سند:</div>
                        <div class="description-content">${descriptionText}</div>
                    </div>
                </div>
            `;
            
            documentPreview.innerHTML = html;
        }
        
        // تابع حذف سند
        function deleteDocument(documentId) {
            if (confirm('آیا از حذف این سند اطمینان دارید؟')) {
                // حذف سند از آرایه
                savedDocuments = savedDocuments.filter(doc => doc.id !== documentId);
                
                // حذف از IndexedDB
                deleteDocumentFromDB(documentId);
                
                // به‌روزرسانی لیست اسناد
                updateDocumentsList();
                
                // به‌روزرسانی دفتر روزنامه
                updateJournal();
                
                // نمایش پیام موفقیت
                showNotification('سند با موفقیت حذف شد!', 'success');
            }
        }
        
        // تابع فرمت ارز به فارسی
        function formatCurrency(amount) {
            const formatted = amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return toPersianNumbers(formatted);
        }
        
        // تابع نمایش نوتیفیکیشن
        function showNotification(message, type) {
            // ایجاد المان نوتیفیکیشن
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 30px;
                left: 30px;
                right: 30px;
                background: ${type === 'success' ? 'var(--success)' : 'var(--danger)'};
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                z-index: 1000;
                display: flex;
                align-items: center;
                gap: 10px;
                font-weight: 600;
                font-size: 1rem;
            `;
            
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            // حذف نوتیفیکیشن بعد از 3 ثانیه
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }
        
        // تابع افزودن ردیف جدید در فرم سند دستی
        function addManualTransactionRow() {
            const row = document.createElement('div');
            row.className = 'manual-transaction-row';
            
            row.innerHTML = `
                <div class="form-group">
                    <label class="form-label">حساب</label>
                    <select class="form-control manual-account" required>
                        <option value="">انتخاب کنید</option>
                        ${accounts.map(acc => `<option value="${acc.id}">${acc.name}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">بدهکار</label>
                    <div class="amount-input-container">
                        <span class="currency-symbol">﷼</span>
                        <input type="text" class="form-control amount-input manual-debit" placeholder="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">بستانکار</label>
                    <div class="amount-input-container">
                        <span class="currency-symbol">﷼</span>
                        <input type="text" class="form-control amount-input manual-credit" placeholder="0">
                    </div>
                </div>
                <button type="button" class="remove-transaction-btn">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            
            // رویداد حذف ردیف
            const removeBtn = row.querySelector('.remove-transaction-btn');
            removeBtn.addEventListener('click', function() {
                row.remove();
                updateRemoveButtons();
            });
            
            manualTransactionsContainer.appendChild(row);
            updateRemoveButtons();
        }
        
        // تابع به‌روزرسانی وضعیت دکمه‌های حذف
        function updateRemoveButtons() {
            const rows = document.querySelectorAll('.manual-transaction-row');
            const removeButtons = document.querySelectorAll('.remove-transaction-btn');
            
            // اگر فقط یک ردیف وجود دارد، دکمه حذف آن را غیرفعال کن
            if (rows.length === 1) {
                removeButtons[0].disabled = true;
            } else {
                removeButtons.forEach(btn => {
                    btn.disabled = false;
                });
            }
        }
        
        // تابع بازنشانی ردیف‌های فرم سند دستی
        function resetManualTransactionRows() {
            manualTransactionsContainer.innerHTML = '';
            addManualTransactionRow();
        }
        
        // تابع صادر کردن داده‌ها به JSON
        function exportData() {
            const data = {
                accounts: accounts,
                documents: savedDocuments,
                documentCounter: documentCounter,
                employees: employees,
                employeeMonthlyData: employeeMonthlyData,
                fiscalPeriod: fiscalPeriod,
                settings: settings,
                parties: parties,
                companyInfo: companyInfo,
                inventory: inventory,
                invoices: savedInvoices,
                invoiceCounter: invoiceCounter
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `MahrazSystem-backup-${dateStr}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showNotification('داده‌ها با موفقیت صادر شدند!', 'success');
        }
        
        // تابع وارد کردن داده‌ها از JSON
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('آیا از وارد کردن داده‌های جدید اطمینان دارید؟ داده‌های فعلی جایگزین خواهند شد.')) {
                        // ذخیره داده‌های جدید
                        accounts = data.accounts || [];
                        savedDocuments = data.documents || [];
                        documentCounter = data.documentCounter || 1;
                        employees = data.employees || [];
                        employeeMonthlyData = data.employeeMonthlyData || [];
                        fiscalPeriod = data.fiscalPeriod || { startDate: '', endDate: '' };
                        settings = data.settings || { vatPercentage: 9 };
                        parties = data.parties || [];
                        companyInfo = data.companyInfo || { 
                            type: 'legal',
                            name: '',
                            economicCode: '',
                            registrationCode: '',
                            nationalCode: '',
                            phone: '',
                            address: '',
                            postalCode: ''
                        };
                        inventory = data.inventory || [];
                        savedInvoices = data.invoices || [];
                        invoiceCounter = data.invoiceCounter || 1;
                        
                        // ذخیره در IndexedDB
                        const promises = [];
                        
                        // پاک کردن داده‌های قدیمی
                        promises.push(clearStore(STORE_NAMES.ACCOUNTS));
                        promises.push(clearStore(STORE_NAMES.DOCUMENTS));
                        promises.push(clearStore(STORE_NAMES.DOCUMENT_COUNTER));
                        promises.push(clearStore(STORE_NAMES.EMPLOYEES));
                        promises.push(clearStore(STORE_NAMES.EMPLOYEE_MONTHLY_DATA));
                        promises.push(clearStore(STORE_NAMES.FISCAL_PERIOD));
                        promises.push(clearStore(STORE_NAMES.SETTINGS));
                        promises.push(clearStore(STORE_NAMES.PARTIES));
                        promises.push(clearStore(STORE_NAMES.COMPANY_INFO));
                        promises.push(clearStore(STORE_NAMES.INVENTORY));
                        promises.push(clearStore(STORE_NAMES.INVOICES));
                        promises.push(clearStore(STORE_NAMES.INVOICE_COUNTER));
                        
                        Promise.all(promises).then(() => {
                            // ذخیره داده‌های جدید
                            const savePromises = [];
                            
                            accounts.forEach(account => {
                                savePromises.push(saveAccount(account));
                            });
                            
                            savedDocuments.forEach(document => {
                                savePromises.push(saveDocument(document));
                            });
                            
                            savePromises.push(saveDocumentCounter());
                            
                            employees.forEach(employee => {
                                savePromises.push(saveEmployee(employee));
                            });
                            
                            employeeMonthlyData.forEach(monthlyData => {
                                savePromises.push(saveEmployeeMonthlyData(monthlyData));
                            });
                            
                            savePromises.push(saveFiscalPeriodToDB());
                            savePromises.push(saveSettingsToDB());
                            
                            parties.forEach(party => {
                                savePromises.push(saveParty(party));
                            });
                            
                            savePromises.push(saveCompanyInfoToDB());
                            
                            inventory.forEach(product => {
                                savePromises.push(saveProduct(product));
                            });
                            
                            savedInvoices.forEach(invoice => {
                                savePromises.push(saveInvoiceToDB(invoice));
                            });
                            
                            savePromises.push(saveInvoiceCounter());
                            
                            Promise.all(savePromises).then(() => {
                                // به‌روزرسانی رابط کاربری
                                updateAccountSelect();
                                updateAccountsList();
                                updateDocumentsList();
                                updateEmployeesList();
                                updateMonthlyEmployeeSelect();
                                updatePartiesList();
                                updateCompanyInfo();
                                updateInventoryList();
                                updateInvoicePartySelect();
                                updateInvoiceProductSelect();
                                updatePartySelect();
                                updateSubsidiaryLedgerAccountSelect();
                                updateJournal();
                                updateSavedInvoicesList();
                                
                                // به‌روزرسانی تنظیمات
                                fiscalPeriodStart.value = fiscalPeriod.startDate || '';
                                fiscalPeriodEnd.value = fiscalPeriod.endDate || '';
                                
                                showNotification('داده‌ها با موفقیت وارد شدند!', 'success');
                            });
                        });
                    }
                } catch (error) {
                    console.error('خطا در وارد کردن داده‌ها:', error);
                    showNotification('خطا در وارد کردن فایل! لطفاً از صحت فایل اطمینان حاصل کنید.', 'error');
                }
            };
            reader.readAsText(file);
            
            // پاک کردن مقدار فایل برای امکان انتخاب مجدد همان فایل
            event.target.value = '';
        }
        
        // تابع پاک کردن یک store از IndexedDB
        function clearStore(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.clear();
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(new Error(`خطا در پاک کردن ${storeName}`));
            });
        }
        
        // تابع بازنشانی داده‌ها
        function resetData() {
            if (confirm('آیا از بازنشانی تمام داده‌ها اطمینان دارید؟ این عمل غیرقابل بازگشت است!')) {
                // پاک کردن تمام داده‌ها
                accounts = [];
                savedDocuments = [];
                documentCounter = 1;
                currentDocumentTransactions = [];
                employees = [];
                employeeMonthlyData = [];
                fiscalPeriod = { startDate: '', endDate: '' };
                settings = { vatPercentage: 9 };
                parties = [];
                companyInfo = { 
                    type: 'legal',
                    name: '',
                    economicCode: '',
                    registrationCode: '',
                    nationalCode: '',
                    phone: '',
                    address: '',
                    postalCode: ''
                };
                inventory = [];
                savedInvoices = [];
                invoiceCounter = 1;
                
                // پاک کردن IndexedDB
                const promises = [
                    clearStore(STORE_NAMES.ACCOUNTS),
                    clearStore(STORE_NAMES.DOCUMENTS),
                    clearStore(STORE_NAMES.CURRENT_DOCUMENT),
                    clearStore(STORE_NAMES.DOCUMENT_COUNTER),
                    clearStore(STORE_NAMES.EMPLOYEES),
                    clearStore(STORE_NAMES.EMPLOYEE_MONTHLY_DATA),
                    clearStore(STORE_NAMES.FISCAL_PERIOD),
                    clearStore(STORE_NAMES.SETTINGS),
                    clearStore(STORE_NAMES.PARTIES),
                    clearStore(STORE_NAMES.COMPANY_INFO),
                    clearStore(STORE_NAMES.INVENTORY),
                    clearStore(STORE_NAMES.INVOICES),
                    clearStore(STORE_NAMES.INVOICE_COUNTER)
                ];
                
                Promise.all(promises).then(() => {
                    // بارگذاری مجدد حساب‌های پیش‌فرض
                    loadAccounts().then(() => {
                        // به‌روزرسانی رابط کاربری
                        updateAccountSelect();
                        updateAccountsList();
                        updateDocumentsList();
                        updateEmployeesList();
                        updateMonthlyEmployeeSelect();
                        updatePartiesList();
                        updateCompanyInfo();
                        updateInventoryList();
                        updateInvoicePartySelect();
                        updateInvoiceProductSelect();
                        updatePartySelect();
                        updateSubsidiaryLedgerAccountSelect();
                        updateJournal();
                        updateSavedInvoicesList();
                        
                        // به‌روزرسانی تنظیمات
                        fiscalPeriodStart.value = '';
                        fiscalPeriodEnd.value = '';
                        
                        // پاک کردن پیش‌نمایش
                        documentPreview.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-file-alt"></i>
                                <p>پس از ثبت معامله، سند حسابداری در اینجا نمایش داده می‌شود</p>
                        </div>
                        `;
                        
                        showNotification('تمامی داده‌ها با موفقیت بازنشانی شدند!', 'success');
                    });
                });
            }
        }
        
        // تابع افزودن پرسنل
        function addEmployee() {
            const name = employeeNameInput.value.trim();
            const nationalId = employeeNationalIdInput.value.trim();
            const hireDate = employeeHireDateInput.value.trim();
            const dailySalary = parseAmount(employeeDailySalaryInput.value) || 0;
            const hourlySalary = parseAmount(employeeHourlySalaryInput.value) || 0;
            const housingAllowance = parseAmount(employeeHousingAllowanceInput.value) || 0;
            const marriageAllowance = parseAmount(employeeMarriageAllowanceInput.value) || 0;
            const childAllowance = parseAmount(employeeChildAllowanceInput.value) || 0;
            const foodAllowance = parseAmount(employeeFoodAllowanceInput.value) || 0;
            const workerBonus = parseAmount(employeeWorkerBonusInput.value) || 0;
            const seniorityBase = parseAmount(employeeSeniorityBaseInput.value) || 0;
            const insuranceWorker = parseAmount(employeeInsuranceWorkerInput.value) || 0;
            const insuranceEmployer = parseAmount(employeeInsuranceEmployerInput.value) || 0;
            const salaryTax = parseAmount(employeeSalaryTaxInput.value) || 0;
            
            if (!name || !nationalId || !hireDate) {
                showNotification('لطفاً نام، کد ملی و تاریخ استخدام را وارد کنید!', 'error');
                return;
            }
            
            // ایجاد پرسنل جدید
            const newEmployee = {
                id: Date.now(),
                name: name,
                nationalId: nationalId,
                hireDate: hireDate,
                dailySalary: dailySalary,
                hourlySalary: hourlySalary,
                housingAllowance: housingAllowance,
                marriageAllowance: marriageAllowance,
                childAllowance: childAllowance,
                foodAllowance: foodAllowance,
                workerBonus: workerBonus,
                seniorityBase: seniorityBase,
                insuranceWorker: insuranceWorker,
                insuranceEmployer: insuranceEmployer,
                salaryTax: salaryTax
            };
            
            // افزودن به آرایه پرسنل
            employees.push(newEmployee);
            
            // ذخیره در IndexedDB
            saveEmployee(newEmployee);
            
            // به‌روزرسانی لیست پرسنل
            updateEmployeesList();
            updateMonthlyEmployeeSelect();
            
            // پاک کردن فیلدهای ورودی
            employeeNameInput.value = '';
            employeeNationalIdInput.value = '';
            employeeHireDateInput.value = getTodayPersianDate();
            employeeDailySalaryInput.value = '';
            employeeHourlySalaryInput.value = '';
            employeeHousingAllowanceInput.value = '';
            employeeMarriageAllowanceInput.value = '';
            employeeChildAllowanceInput.value = '';
            employeeFoodAllowanceInput.value = '';
            employeeWorkerBonusInput.value = '';
            employeeSeniorityBaseInput.value = '';
            employeeInsuranceWorkerInput.value = '';
            employeeInsuranceEmployerInput.value = '';
            employeeSalaryTaxInput.value = '';
            
            // نمایش پیام موفقیت
            showNotification('پرسنل جدید با موفقیت افزوده شد!', 'success');
        }
        
        // تابع ایجاد سند حقوق و دستمزد - بهبود یافته
        function generateSalaryDocument() {
            if (employees.length === 0) {
                showNotification('هیچ پرسنلی برای ایجاد سند حقوق وجود ندارد!', 'error');
                return;
            }
            
            const today = getTodayPersianDate();
            const selectedEmployeeId = monthlyEmployeeSelect.value;
            const selectedMonth = salaryMonthSelect.value;
            
            if (!selectedEmployeeId || !selectedMonth) {
                showNotification('لطفاً پرسنل و ماه را انتخاب کنید!', 'error');
                return;
            }
            
            const employee = employees.find(e => e.id == selectedEmployeeId);
            if (!employee) {
                showNotification('پرسنل انتخاب شده معتبر نیست!', 'error');
                return;
            }
            
            // ایجاد معاملات حقوق
            const salaryTransactions = [];
            
            // محاسبه حقوق خالص با استفاده از اطلاعات پایه و اطلاعات ماهانه
            const monthlyData = employeeMonthlyData.find(data => data.employeeId === employee.id && data.month === selectedMonth);
            
            // محاسبه حقوق پایه
            let baseSalary = 0;
            if (monthlyData) {
                baseSalary = (employee.dailySalary || 0) * (monthlyData.workDays || 0) + 
                           (employee.hourlySalary || 0) * (monthlyData.workHours || 0);
            } else {
                baseSalary = (employee.dailySalary || 0) * 22; // فرض: 22 روز کاری
            }
            
            // محاسبه اضافه‌کاری (فرض: هر ساعت اضافه کاری معادل 1.5 برابر حقوق ساعتی)
            const hourlyRate = employee.hourlySalary || 0;
            const overtimeAmount = (monthlyData?.overtimeHours || 0) * hourlyRate * 1.5;
            
            // محاسبه سایر مزایا
            const otherBenefits = monthlyData?.otherBenefits || 0;
            
            // جمع کل حقوق و مزایا
            const totalSalary = baseSalary + 
                              (employee.housingAllowance || 0) + 
                              (employee.marriageAllowance || 0) + 
                              (employee.childAllowance || 0) + 
                              (employee.foodAllowance || 0) + 
                              (employee.workerBonus || 0) + 
                              (employee.seniorityBase || 0) +
                              overtimeAmount +
                              otherBenefits;
            
            // محاسبه بیمه و مالیات
            const insuranceWorkerAmount = totalSalary * (employee.insuranceWorker || 0) / 100;
            const insuranceEmployerAmount = totalSalary * (employee.insuranceEmployer || 0) / 100;
            const taxAmount = employee.salaryTax || 0;
            
            // کسورات
            const deductions = monthlyData?.deductions || 0;
            
            // حقوق خالص
            const netSalary = totalSalary - insuranceWorkerAmount - taxAmount - deductions;
            
            if (totalSalary > 0) {
                // معامله بدهکار: هزینه حقوق
                const expenseTransaction = {
                    id: Date.now(),
                    date: today,
                    accountId: 8, // حساب هزینه
                    accountName: 'هزینه حقوق',
                    debit: totalSalary,
                    credit: 0,
                    description: `حقوق ${employee.name} - ماه ${getMonthName(selectedMonth)}`,
                    isManual: true,
                    isSalary: true
                };
                
                salaryTransactions.push(expenseTransaction);
                
                // معامله بستانکار: حقوق پرداختنی
                const salaryPayableTransaction = {
                    id: Date.now() + 1,
                    date: today,
                    accountId: 3, // حساب های پرداختنی
                    accountName: `حقوق پرداختنی-${employee.name}`,
                    debit: 0,
                    credit: netSalary,
                    description: `حقوق پرداختنی ${employee.name}`,
                    isManual: true,
                    isSalary: true
                };
                
                salaryTransactions.push(salaryPayableTransaction);
                
                // معامله بستانکار: بیمه تامین اجتماعی
                const insuranceTransaction = {
                    id: Date.now() + 2,
                    date: today,
                    accountId: 3, // حساب های پرداختنی
                    accountName: `بیمه تامین اجتماعی-${employee.name}`,
                    debit: 0,
                    credit: insuranceWorkerAmount + insuranceEmployerAmount,
                    description: `بیمه تامین اجتماعی ${employee.name}`,
                    isManual: true,
                    isSalary: true
                };
                
                salaryTransactions.push(insuranceTransaction);
                
                // معامله بستانکار: مالیات حقوق
                const taxTransaction = {
                    id: Date.now() + 3,
                    date: today,
                    accountId: 3, // حساب های پرداختنی
                    accountName: `مالیات حقوق-${employee.name}`,
                    debit: 0,
                    credit: taxAmount,
                    description: `مالیات حقوق ${employee.name}`,
                    isManual: true,
                    isSalary: true
                };
                
                salaryTransactions.push(taxTransaction);
            }
            
            if (salaryTransactions.length === 0) {
                showNotification('هیچ حقوقی برای ایجاد سند وجود ندارد!', 'error');
                return;
            }
            
            // افزودن به آرایه معاملات سند جاری
            currentDocumentTransactions = salaryTransactions;
            
            // ذخیره در IndexedDB
            saveCurrentDocument();
            
            // نمایش پیام موفقیت
            showNotification('سند حقوق با موفقیت ایجاد شد!', 'success');
            
            // تولید خودکار سند حسابداری
            generateAccountingDocument();
        }
        
        // تابع دریافت نام ماه
        function getMonthName(monthNumber) {
            const months = [
                '', 'فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور',
                'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'
            ];
            return months[parseInt(monthNumber)] || '';
        }
        
        // تابع ذخیره دوره مالی
        function saveFiscalPeriod() {
            const startDate = fiscalPeriodStart.value;
            const endDate = fiscalPeriodEnd.value;
            
            if (!startDate || !endDate) {
                showNotification('لطفاً تاریخ شروع و پایان دوره مالی را وارد کنید!', 'error');
                return;
            }
            
            // ذخیره دوره مالی
            fiscalPeriod = {
                startDate: startDate,
                endDate: endDate
            };
            
            // ذخیره در IndexedDB
            saveFiscalPeriodToDB();
            
            // نمایش پیام موفقیت
            showNotification('دوره مالی با موفقیت ذخیره شد!', 'success');
        }
        
        // تابع افزودن طرف حساب
        function addParty() {
            const name = partyNameInput.value.trim();
            const economicCode = partyEconomicCodeInput.value.trim();
            const registrationCode = partyRegistrationCodeInput.value.trim();
            const nationalCode = partyNationalCodeInput.value.trim();
            const phone = partyPhoneInput.value.trim();
            const address = partyAddressInput.value.trim();
            const postalCode = partyPostalCodeInput.value.trim();
            
            if (!name || !economicCode || !phone) {
                showNotification('لطفاً نام، شماره اقتصادی و شماره تماس طرف حساب را وارد کنید!', 'error');
                return;
            }
            
            // تعیین نوع طرف حساب
            const type = document.querySelector('.party-type-selector .type-btn.active').getAttribute('data-type');
            
            // ایجاد طرف حساب جدید
            const newParty = {
                id: Date.now(),
                type: type,
                name: name,
                economicCode: economicCode,
                registrationCode: type === 'legal' ? registrationCode : '',
                nationalCode: type === 'individual' ? nationalCode : '',
                phone: phone,
                address: address,
                postalCode: postalCode
            };
            
            // افزودن به آرایه طرف‌های حساب
            parties.push(newParty);
            
            // ذخیره در IndexedDB
            saveParty(newParty);
            
            // به‌روزرسانی لیست طرف‌های حساب
            updatePartiesList();
            updateInvoicePartySelect();
            updatePartySelect();
            updateSubsidiaryLedgerAccountSelect();
            
            // پاک کردن فیلدهای ورودی
            partyNameInput.value = '';
            partyEconomicCodeInput.value = '';
            partyRegistrationCodeInput.value = '';
            partyNationalCodeInput.value = '';
            partyPhoneInput.value = '';
            partyAddressInput.value = '';
            partyPostalCodeInput.value = '';
            
            // نمایش پیام موفقیت
            showNotification('طرف حساب جدید با موفقیت افزوده شد!', 'success');
        }
        
        // تابع ذخیره اطلاعات شرکت
        function saveCompanyInfo() {
            const name = companyNameInput.value.trim();
            const economicCode = companyEconomicCodeInput.value.trim();
            const registrationCode = companyRegistrationCodeInput.value.trim();
            const nationalCode = companyNationalCodeInput.value.trim();
            const phone = companyPhoneInput.value.trim();
            const address = companyAddressInput.value.trim();
            const postalCode = companyPostalCodeInput.value.trim();
            
            if (!name || !economicCode || !phone || !address) {
                showNotification('لطفاً تمام اطلاعات ضروری شرکت را وارد کنید!', 'error');
                return;
            }
            
            // تعیین نوع شرکت
            const type = document.querySelector('.company-type-selector .type-btn.active').getAttribute('data-type');
            
            // ذخیره اطلاعات شرکت
            companyInfo = {
                type: type,
                name: name,
                economicCode: economicCode,
                registrationCode: type === 'legal' ? registrationCode : '',
                nationalCode: type === 'individual' ? nationalCode : '',
                phone: phone,
                address: address,
                postalCode: postalCode
            };
            
            // ذخیره در IndexedDB
            saveCompanyInfoToDB();
            
            // نمایش پیام موفقیت
            showNotification('اطلاعات شرکت با موفقیت ذخیره شد!', 'success');
        }
        
        // تابع افزودن کالا
        function addProduct() {
            const code = productCodeInput.value.trim();
            const name = productNameInput.value.trim();
            const price = parseAmount(productPriceInput.value) || 0;
            
            if (!code || !name) {
                showNotification('لطفاً کد و نام کالا/خدمات را وارد کنید!', 'error');
                return;
            }
            
            if (price <= 0) {
                showNotification('لطفاً بهای واحد کالا/خدمات را وارد کنید!', 'error');
                return;
            }
            
            // ایجاد کالای جدید
            const newProduct = {
                id: Date.now(),
                code: code,
                name: name,
                price: price
            };
            
            // افزودن به آرایه کالاها
            inventory.push(newProduct);
            
            // ذخیره در IndexedDB
            saveProduct(newProduct);
            
            // به‌روزرسانی لیست کالاها
            updateInventoryList();
            updateInvoiceProductSelect();
            
            // پاک کردن فیلدهای ورودی
            productCodeInput.value = '';
            productNameInput.value = '';
            productPriceInput.value = '';
            
            // نمایش پیام موفقیت
            showNotification('کالا/خدمات جدید با موفقیت افزوده شد!', 'success');
        }
        
        // تابع افزودن ردیف فاکتور
        function addInvoiceItem() {
            const productId = invoiceProductSelect.value;
            const quantity = parseAmount(invoiceQuantityInput.value) || 0;
            
            if (!productId || quantity <= 0) {
                showNotification('لطفاً کالا/خدمات و مقدار را وارد کنید!', 'error');
                return;
            }
            
            const product = inventory.find(p => p.id == productId);
            if (!product) {
                showNotification('کالا/خدمات انتخاب شده معتبر نیست!', 'error');
                return;
            }
            
            const unitPrice = product.price;
            const totalPrice = quantity * unitPrice;
            
            // ایجاد ردیف فاکتور
            const invoiceItem = {
                id: Date.now(),
                productId: productId,
                productCode: product.code,
                productName: product.name,
                quantity: quantity,
                unitPrice: unitPrice,
                totalPrice: totalPrice
            };
            
            // افزودن به آرایه اقلام فاکتور
            invoiceItems.push(invoiceItem);
            
            // به‌روزرسانی نمایش اقلام فاکتور
            updateInvoiceItemsDisplay();
            
            // پاک کردن فیلدهای ورودی
            invoiceProductSelect.value = '';
            invoiceQuantityInput.value = '';
            
            // به‌روزرسانی محاسبات فاکتور
            updateInvoiceTotals();
            
            // تولید پیش‌نمایش فاکتور استاندارد
            generateStandardInvoicePreview();
        }
        
        // تابع به‌روزرسانی نمایش اقلام فاکتور
        function updateInvoiceItemsDisplay() {
            if (invoiceItems.length === 0) {
                invoiceItemsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-receipt"></i>
                        <p>هیچ موردی به فاکتور اضافه نشده است</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            invoiceItems.forEach((item, index) => {
                html += `
                    <div class="invoice-item-display">
                        <div class="invoice-item-info">
                            <div class="invoice-item-name">${item.productName}</div>
                            <div class="invoice-item-details">
                                <span>کد کالا/خدمات: ${item.productCode}</span>
                                <span>مقدار: ${toPersianNumbers(item.quantity)}</span>
                                <span>بهای واحد: ${formatCurrency(item.unitPrice)}</span>
                                <span>بهای کل: ${formatCurrency(item.totalPrice)}</span>
                            </div>
                        </div>
                        <div class="invoice-item-actions">
                            <button class="btn btn-danger btn-sm" onclick="removeInvoiceItem(${index})">
                                <i class="fas fa-trash"></i>
                                حذف
                            </button>
                        </div>
                    </div>
                `;
            });
            
            invoiceItemsContainer.innerHTML = html;
        }
        
        // تابع حذف ردیف فاکتور
        function removeInvoiceItem(index) {
            invoiceItems.splice(index, 1);
            updateInvoiceItemsDisplay();
            updateInvoiceTotals();
            generateStandardInvoicePreview();
        }
        
        // تابع به‌روزرسانی محاسبات فاکتور
        function updateInvoiceTotals() {
            let subtotal = 0;
            
            invoiceItems.forEach(item => {
                subtotal += item.totalPrice;
            });
            
            const discountPercent = parseAmount(invoiceDiscountInput.value) || 0;
            const taxPercent = parseAmount(invoiceTaxInput.value) || 0;
            
            const discountAmount = subtotal * (discountPercent / 100);
            const taxAmount = (subtotal - discountAmount) * (taxPercent / 100);
            const grandTotal = subtotal - discountAmount + taxAmount;
            
            // این اطلاعات فقط در پیش‌نمایش فاکتور نمایش داده می‌شوند
            // و در فرم نمایش داده نمی‌شوند
        }
        
        // تابع تولید پیش‌نمایش فاکتور استاندارد
        function generateStandardInvoicePreview() {
            const date = invoiceDateInput.value;
            const partyId = invoicePartySelect.value;
            
            if (!date || !partyId || invoiceItems.length === 0) {
                invoiceStandardPreview.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-receipt"></i>
                        <p>پس از پر کردن فرم، پیش‌نمایش فاکتور در اینجا نمایش داده می‌شود</p>
                    </div>
                `;
                return;
            }
            
            const party = parties.find(p => p.id == partyId);
            if (!party) {
                showNotification('طرف حساب انتخاب شده معتبر نیست!', 'error');
                return;
            }
            
            // محاسبه مبالغ
            let subtotal = 0;
            invoiceItems.forEach(item => {
                subtotal += item.totalPrice;
            });
            
            const discountPercent = parseAmount(invoiceDiscountInput.value) || 0;
            const taxPercent = parseAmount(invoiceTaxInput.value) || 0;
            
            const discountAmount = subtotal * (discountPercent / 100);
            const taxAmount = (subtotal - discountAmount) * (taxPercent / 100);
            const grandTotal = subtotal - discountAmount + taxAmount;
            
            // دریافت نحوه پرداخت
            const paymentMethod = document.querySelector('input[name="payment-method"]:checked');
            const paymentMethodText = paymentMethod ? (paymentMethod.value === 'cash' ? 'نقدی' : 'غیر نقدی') : '';
            
            // تولید اقلام فاکتور
            let itemsHtml = '';
            invoiceItems.forEach((item, index) => {
                itemsHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.productCode}</td>
                        <td>${item.productName}</td>
                        <td>${toPersianNumbers(item.quantity)}</td>
                        <td>عدد</td>
                        <td>${formatCurrency(item.unitPrice)}</td>
                        <td>${formatCurrency(item.totalPrice)}</td>
                        <td>${formatCurrency(0)}</td>
                        <td>${formatCurrency(item.totalPrice)}</td>
                        <td>${formatCurrency(taxAmount / invoiceItems.length)}</td>
                        <td>${formatCurrency(item.totalPrice + (taxAmount / invoiceItems.length))}</td>
                    </tr>
                `;
            });
            
            // تولید HTML فاکتور استاندارد
            let html = `
                <div class="invoice-standard-preview-content">
                    <div class="invoice-standard-header">
                        <div class="invoice-standard-title">فاکتور فروش/خدمات</div>
                        <div class="invoice-standard-number">شماره فاکتور: ${toPersianNumbers(invoiceCounter)}</div>
                        <div class="invoice-standard-date">تاریخ فاکتور: ${date}</div>
                    </div>
                    
                    <div class="invoice-horizontal-details">
                        <div class="invoice-seller-details">
                            <div class="invoice-standard-section-title">فروشنده</div>
                            <div class="invoice-detail-row">
                                <div class="invoice-detail-label">نام:</div>
                                <div class="invoice-detail-value invoice-small-font">${companyInfo.name || '---'}</div>
                            </div>
                            <div class="invoice-detail-row">
                                <div class="invoice-detail-label">شماره اقتصادی:</div>
                                <div class="invoice-detail-value invoice-small-font">${companyInfo.economicCode || '---'}</div>
                            </div>
                            ${companyInfo.type === 'legal' ? `
                            <div class="invoice-detail-row">
                                <div class="invoice-detail-label">شماره ثبت:</div>
                                <div class="invoice-detail-value invoice-small-font">${companyInfo.registrationCode || '---'}</div>
                            </div>
                            ` : `
                            <div class="invoice-detail-row">
                                <div class="invoice-detail-label">شماره ملی:</div>
                                <div class="invoice-detail-value invoice-small-font">${companyInfo.nationalCode || '---'}</div>
                            </div>
                            `}
                            <div class="invoice-detail-row">
                                <div class="invoice-detail-label">آدرس:</div>
                                <div class="invoice-detail-value invoice-small-font">${companyInfo.address || '---'}</div>
                            </div>
                            <div class="invoice-detail-row">
                                <div class="invoice-detail-label">کد پستی:</div>
                                <div class="invoice-detail-value invoice-small-font">${companyInfo.postalCode || '---'}</div>
                            </div>
                        </div>
                        
                        <div class="invoice-buyer-details">
                            <div class="invoice-standard-section-title">خریدار</div>
                            <div class="invoice-detail-row">
                                <div class="invoice-detail-label">نام:</div>
                                <div class="invoice-detail-value invoice-small-font">${party.name}</div>
                            </div>
                            <div class="invoice-detail-row">
                                <div class="invoice-detail-label">شماره اقتصادی:</div>
                                <div class="invoice-detail-value invoice-small-font">${party.economicCode}</div>
                            </div>
                            ${party.type === 'legal' ? `
                            <div class="invoice-detail-row">
                                <div class="invoice-detail-label">شماره ثبت:</div>
                                <div class="invoice-detail-value invoice-small-font">${party.registrationCode || '---'}</div>
                            </div>
                            ` : `
                            <div class="invoice-detail-row">
                                <div class="invoice-detail-label">شماره ملی:</div>
                                <div class="invoice-detail-value invoice-small-font">${party.nationalCode || '---'}</div>
                            </div>
                            `}
                            <div class="invoice-detail-row">
                                <div class="invoice-detail-label">آدرس:</div>
                                <div class="invoice-detail-value invoice-small-font">${party.address || '---'}</div>
                            </div>
                            <div class="invoice-detail-row">
                                <div class="invoice-detail-label">کد پستی:</div>
                                <div class="invoice-detail-value invoice-small-font">${party.postalCode || '---'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <table class="invoice-standard-table">
                        <thead>
                            <tr>
                                <th>ردیف</th>
                                <th>کد کالا</th>
                                <th>شرح کالا/خدمات</th>
                                <th>مقدار</th>
                                <th>واحد</th>
                                <th>بهای واحد</th>
                                <th>بهای کل</th>
                                <th>مبلغ تخفیف</th>
                                <th>بهای کل پس از تخفیف</th>
                                <th>مالیات و عوارض</th>
                                <th>بهای کل بعلاوه مالیات و عوارض</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>
                    
                    <div class="invoice-summary-section">
                        <div class="invoice-summary-row">
                            <div class="invoice-summary-label invoice-small-font">جمع تمامی ستون ها به عدد:</div>
                            <div class="invoice-summary-value invoice-small-font">${formatCurrency(grandTotal)} ریال</div>
                        </div>
                        <div class="invoice-summary-row">
                            <div class="invoice-summary-label invoice-small-font">جمع تمامی ستون ها به حروف:</div>
                            <div class="invoice-summary-value invoice-small-font">${numberToWords(grandTotal)} ریال</div>
                        </div>
                        <div class="invoice-summary-row">
                            <div class="invoice-summary-label invoice-small-font">نحوه پرداخت:</div>
                            <div class="invoice-summary-value invoice-small-font">
                                <span>نقدی ${paymentMethodText === 'نقدی' ? '☑' : '☐'}</span>
                                <span style="margin-right: 20px;">غیر نقدی ${paymentMethodText === 'غیر نقدی' ? '☑' : '☐'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="invoice-standard-signatures">
                        <div class="invoice-standard-signature">
                            <div>مهر و امضای فروشنده</div>
                            <div class="invoice-standard-signature-line"></div>
                        </div>
                        <div class="invoice-standard-signature">
                            <div>مهر و امضای خریدار</div>
                            <div class="invoice-standard-signature-line"></div>
                        </div>
                    </div>
                </div>
            `;
            
            invoiceStandardPreview.innerHTML = html;
        }
        
        // تابع تبدیل عدد به حروف
        function numberToWords(number) {
            // این یک پیاده‌سازی ساده است
            // برای پیاده‌سازی کامل باید از کتابخانه‌های تخصصی استفاده کرد
            const units = ['', 'یک', 'دو', 'سه', 'چهار', 'پنج', 'شش', 'هفت', 'هشت', 'نه'];
            const teens = ['ده', 'یازده', 'دوازده', 'سیزده', 'چهارده', 'پانزده', 'شانزده', 'هفده', 'هجده', 'نوزده'];
            const tens = ['', '', 'بیست', 'سی', 'چهل', 'پنجاه', 'شصت', 'هفتاد', 'هشتاد', 'نود'];
            const hundreds = ['', 'صد', 'دویست', 'سیصد', 'چهارصد', 'پانصد', 'ششصد', 'هفتصد', 'هشتصد', 'نهصد'];
            
            if (number === 0) return 'صفر';
            
            let words = '';
            
            // میلیارد
            if (number >= 1000000000) {
                words += numberToWords(Math.floor(number / 1000000000)) + ' میلیارد و ';
                number %= 1000000000;
            }
            
            // میلیون
            if (number >= 1000000) {
                words += numberToWords(Math.floor(number / 1000000)) + ' میلیون و ';
                number %= 1000000;
            }
            
            // هزار
            if (number >= 1000) {
                words += numberToWords(Math.floor(number / 1000)) + ' هزار و ';
                number %= 1000;
            }
            
            // صد
            if (number >= 100) {
                words += hundreds[Math.floor(number / 100)] + ' و ';
                number %= 100;
            }
            
            // ده
            if (number >= 20) {
                words += tens[Math.floor(number / 10)] + ' و ';
                number %= 10;
            } else if (number >= 10) {
                words += teens[number - 10] + ' و ';
                number = 0;
            }
            
            // واحد
            if (number > 0) {
                words += units[number] + ' و ';
            }
            
            // حذف " و " اضافی از انتها
            if (words.endsWith(' و ')) {
                words = words.slice(0, -3);
            }
            
            return words || 'صفر';
        }
        
        // تابع ذخیره فاکتور
        function saveInvoice() {
            const date = invoiceDateInput.value;
            const partyId = invoicePartySelect.value;
            
            if (!date || !partyId || invoiceItems.length === 0) {
                showNotification('لطفاً تمام فیلدهای ضروری را پر کنید و حداقل یک ردیف به فاکتور اضافه کنید!', 'error');
                return;
            }
            
            const party = parties.find(p => p.id == partyId);
            if (!party) {
                showNotification('طرف حساب انتخاب شده معتبر نیست!', 'error');
                return;
            }
            
            // دریافت نحوه پرداخت
            const paymentMethod = document.querySelector('input[name="payment-method"]:checked');
            if (!paymentMethod) {
                showNotification('لطفاً نحوه پرداخت را انتخاب کنید!', 'error');
                return;
            }
            
            // محاسبه مبالغ
            let subtotal = 0;
            invoiceItems.forEach(item => {
                subtotal += item.totalPrice;
            });
            
            const discountPercent = parseAmount(invoiceDiscountInput.value) || 0;
            const taxPercent = parseAmount(invoiceTaxInput.value) || 0;
            
            const discountAmount = subtotal * (discountPercent / 100);
            const taxAmount = (subtotal - discountAmount) * (taxPercent / 100);
            const grandTotal = subtotal - discountAmount + taxAmount;
            
            // ایجاد فاکتور جدید
            const newInvoice = {
                id: Date.now(),
                number: invoiceCounter++,
                date: date,
                partyId: partyId,
                partyName: party.name,
                partyType: party.type,
                partyEconomicCode: party.economicCode,
                partyRegistrationCode: party.registrationCode,
                partyNationalCode: party.nationalCode,
                partyPhone: party.phone,
                partyAddress: party.address,
                partyPostalCode: party.postalCode,
                items: [...invoiceItems],
                subtotal: subtotal,
                discountAmount: discountAmount,
                taxAmount: taxAmount,
                grandTotal: grandTotal,
                paymentMethod: paymentMethod.value
            };
            
            // افزودن به آرایه فاکتورها
            savedInvoices.push(newInvoice);
            
            // ذخیره در IndexedDB
            saveInvoiceToDB(newInvoice);
            saveInvoiceCounter();
            
            // به‌روزرسانی لیست فاکتورها
            updateSavedInvoicesList();
            
            // نمایش پیام موفقیت
            showNotification('فاکتور با موفقیت ذخیره شد!', 'success');
            
            // بازنشانی فرم فاکتور
            resetInvoice();
        }
        
        // تابع چاپ فاکتور
        function printInvoice() {
            const invoiceContent = invoiceStandardPreview.innerHTML;
            
            if (invoiceContent.includes('empty-state')) {
                showNotification('هیچ فاکتوری برای چاپ وجود ندارد!', 'error');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html dir="rtl">
                <head>
                    <title>چاپ فاکتور</title>
                    <style>
                        body {
                            font-family: 'Vazirmatn', 'Vazir', Tahoma, sans-serif;
                            direction: rtl;
                            margin: 20px;
                            line-height: 1.6;
                        }
                        .invoice-standard-preview-content {
                            border: 1px solid #000;
                            padding: 20px;
                        }
                        .invoice-standard-header {
                            text-align: center;
                            margin-bottom: 20px;
                            padding-bottom: 15px;
                            border-bottom: 2px solid #000;
                        }
                        .invoice-standard-title {
                            font-size: 1.5rem;
                            font-weight: bold;
                        }
                        .invoice-horizontal-details {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 20px;
                            background: rgba(0,0,0,0.05);
                            border-radius: 10px;
                            padding: 15px;
                            border: 1px solid #000;
                        }
                        .invoice-seller-details, .invoice-buyer-details {
                            flex: 1;
                        }
                        .invoice-seller-details {
                            margin-left: 10px;
                        }
                        .invoice-buyer-details {
                            margin-right: 10px;
                        }
                        .invoice-detail-row {
                            display: flex;
                            margin-bottom: 8px;
                        }
                        .invoice-detail-label {
                            font-weight: 600;
                            width: 120px;
                        }
                        .invoice-detail-value {
                            flex: 1;
                        }
                        .invoice-small-font {
                            font-size: 0.7rem;
                        }
                        .invoice-standard-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 20px 0;
                            font-size: 0.7rem;
                        }
                        .invoice-standard-table th, .invoice-standard-table td {
                            border: 1px solid #000;
                            padding: 6px;
                            text-align: center;
                        }
                        .invoice-standard-table th {
                            background-color: #f0f0f0;
                        }
                        .invoice-summary-section {
                            margin-top: 20px;
                            background: rgba(0,0,0,0.05);
                            border-radius: 10px;
                            padding: 15px;
                            border: 1px solid #000;
                        }
                        .invoice-summary-row {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 10px;
                            padding-bottom: 10px;
                            border-bottom: 1px solid #000;
                        }
                        .invoice-summary-row:last-child {
                            border-bottom: none;
                            margin-bottom: 0;
                            padding-bottom: 0;
                        }
                        .invoice-summary-label {
                            font-weight: 600;
                        }
                        .invoice-summary-value {
                            font-weight: 700;
                        }
                        .invoice-standard-signatures {
                            display: flex;
                            justify-content: space-between;
                            margin-top: 40px;
                        }
                        .invoice-standard-signature-line {
                            border-top: 1px solid #000;
                            margin-top: 40px;
                            padding-top: 5px;
                        }
                        @media print {
                            body { margin: 0; }
                            .invoice-standard-preview-content { border: none; }
                        }
                    </style>
                </head>
                <body>
                    ${invoiceContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        // تابع چاپ فاکتور ذخیره شده
        function printSavedInvoice(invoiceId) {
            const invoice = savedInvoices.find(inv => inv.id === invoiceId);
            
            if (!invoice) {
                showNotification('فاکتور مورد نظر یافت نشد!', 'error');
                return;
            }
            
            // تولید اقلام فاکتور
            let itemsHtml = '';
            invoice.items.forEach((item, index) => {
                itemsHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.productCode}</td>
                        <td>${item.productName}</td>
                        <td>${toPersianNumbers(item.quantity)}</td>
                        <td>عدد</td>
                        <td>${formatCurrency(item.unitPrice)}</td>
                        <td>${formatCurrency(item.totalPrice)}</td>
                        <td>${formatCurrency(0)}</td>
                        <td>${formatCurrency(item.totalPrice)}</td>
                        <td>${formatCurrency(invoice.taxAmount / invoice.items.length)}</td>
                        <td>${formatCurrency(item.totalPrice + (invoice.taxAmount / invoice.items.length))}</td>
                    </tr>
                `;
            });
            
            const paymentMethodText = invoice.paymentMethod === 'cash' ? 'نقدی' : 'غیر نقدی';
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html dir="rtl">
                <head>
                    <title>چاپ فاکتور</title>
                    <style>
                        body {
                            font-family: 'Vazirmatn', 'Vazir', Tahoma, sans-serif;
                            direction: rtl;
                            margin: 20px;
                            line-height: 1.6;
                        }
                        .invoice-standard-preview-content {
                            border: 1px solid #000;
                            padding: 20px;
                        }
                        .invoice-standard-header {
                            text-align: center;
                            margin-bottom: 20px;
                            padding-bottom: 15px;
                            border-bottom: 2px solid #000;
                        }
                        .invoice-standard-title {
                            font-size: 1.5rem;
                            font-weight: bold;
                        }
                        .invoice-horizontal-details {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 20px;
                            background: rgba(0,0,0,0.05);
                            border-radius: 10px;
                            padding: 15px;
                            border: 1px solid #000;
                        }
                        .invoice-seller-details, .invoice-buyer-details {
                            flex: 1;
                        }
                        .invoice-seller-details {
                            margin-left: 10px;
                        }
                        .invoice-buyer-details {
                            margin-right: 10px;
                        }
                        .invoice-detail-row {
                            display: flex;
                            margin-bottom: 8px;
                        }
                        .invoice-detail-label {
                            font-weight: 600;
                            width: 120px;
                        }
                        .invoice-detail-value {
                            flex: 1;
                        }
                        .invoice-small-font {
                            font-size: 0.7rem;
                        }
                        .invoice-standard-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 20px 0;
                            font-size: 0.7rem;
                        }
                        .invoice-standard-table th, .invoice-standard-table td {
                            border: 1px solid #000;
                            padding: 6px;
                            text-align: center;
                        }
                        .invoice-standard-table th {
                            background-color: #f0f0f0;
                        }
                        .invoice-summary-section {
                            margin-top: 20px;
                            background: rgba(0,0,0,0.05);
                            border-radius: 10px;
                            padding: 15px;
                            border: 1px solid #000;
                        }
                        .invoice-summary-row {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 10px;
                            padding-bottom: 10px;
                            border-bottom: 1px solid #000;
                        }
                        .invoice-summary-row:last-child {
                            border-bottom: none;
                            margin-bottom: 0;
                            padding-bottom: 0;
                        }
                        .invoice-summary-label {
                            font-weight: 600;
                        }
                        .invoice-summary-value {
                            font-weight: 700;
                        }
                        .invoice-standard-signatures {
                            display: flex;
                            justify-content: space-between;
                            margin-top: 40px;
                        }
                        .invoice-standard-signature-line {
                            border-top: 1px solid #000;
                            margin-top: 40px;
                            padding-top: 5px;
                        }
                        @media print {
                            body { margin: 0; }
                            .invoice-standard-preview-content { border: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="invoice-standard-preview-content">
                        <div class="invoice-standard-header">
                            <div class="invoice-standard-title">فاکتور فروش/خدمات</div>
                            <div class="invoice-standard-number">شماره فاکتور: ${toPersianNumbers(invoice.number)}</div>
                            <div class="invoice-standard-date">تاریخ فاکتور: ${invoice.date}</div>
                        </div>
                        
                        <div class="invoice-horizontal-details">
                            <div class="invoice-seller-details">
                                <div class="invoice-standard-section-title">فروشنده</div>
                                <div class="invoice-detail-row">
                                    <div class="invoice-detail-label">نام:</div>
                                    <div class="invoice-detail-value invoice-small-font">${companyInfo.name || '---'}</div>
                                </div>
                                <div class="invoice-detail-row">
                                    <div class="invoice-detail-label">شماره اقتصادی:</div>
                                    <div class="invoice-detail-value invoice-small-font">${companyInfo.economicCode || '---'}</div>
                                </div>
                                ${companyInfo.type === 'legal' ? `
                                <div class="invoice-detail-row">
                                    <div class="invoice-detail-label">شماره ثبت:</div>
                                    <div class="invoice-detail-value invoice-small-font">${companyInfo.registrationCode || '---'}</div>
                                </div>
                                ` : `
                                <div class="invoice-detail-row">
                                    <div class="invoice-detail-label">شماره ملی:</div>
                                    <div class="invoice-detail-value invoice-small-font">${companyInfo.nationalCode || '---'}</div>
                                </div>
                                `}
                                <div class="invoice-detail-row">
                                    <div class="invoice-detail-label">آدرس:</div>
                                    <div class="invoice-detail-value invoice-small-font">${companyInfo.address || '---'}</div>
                                </div>
                                <div class="invoice-detail-row">
                                    <div class="invoice-detail-label">کد پستی:</div>
                                    <div class="invoice-detail-value invoice-small-font">${companyInfo.postalCode || '---'}</div>
                                </div>
                            </div>
                            
                            <div class="invoice-buyer-details">
                                <div class="invoice-standard-section-title">خریدار</div>
                                <div class="invoice-detail-row">
                                    <div class="invoice-detail-label">نام:</div>
                                    <div class="invoice-detail-value invoice-small-font">${invoice.partyName}</div>
                                </div>
                                <div class="invoice-detail-row">
                                    <div class="invoice-detail-label">شماره اقتصادی:</div>
                                    <div class="invoice-detail-value invoice-small-font">${invoice.partyEconomicCode}</div>
                                </div>
                                ${invoice.partyType === 'legal' ? `
                                <div class="invoice-detail-row">
                                    <div class="invoice-detail-label">شماره ثبت:</div>
                                    <div class="invoice-detail-value invoice-small-font">${invoice.partyRegistrationCode || '---'}</div>
                                </div>
                                ` : `
                                <div class="invoice-detail-row">
                                    <div class="invoice-detail-label">شماره ملی:</div>
                                    <div class="invoice-detail-value invoice-small-font">${invoice.partyNationalCode || '---'}</div>
                                </div>
                                `}
                                <div class="invoice-detail-row">
                                    <div class="invoice-detail-label">آدرس:</div>
                                    <div class="invoice-detail-value invoice-small-font">${invoice.partyAddress || '---'}</div>
                                </div>
                                <div class="invoice-detail-row">
                                    <div class="invoice-detail-label">کد پستی:</div>
                                    <div class="invoice-detail-value invoice-small-font">${invoice.partyPostalCode || '---'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <table class="invoice-standard-table">
                            <thead>
                                <tr>
                                    <th>ردیف</th>
                                    <th>کد کالا</th>
                                    <th>شرح کالا/خدمات</th>
                                    <th>مقدار</th>
                                    <th>واحد</th>
                                    <th>بهای واحد</th>
                                    <th>بهای کل</th>
                                    <th>مبلغ تخفیف</th>
                                    <th>بهای کل پس از تخفیف</th>
                                    <th>مالیات و عوارض</th>
                                    <th>بهای کل بعلاوه مالیات و عوارض</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHtml}
                            </tbody>
                        </table>
                        
                        <div class="invoice-summary-section">
                            <div class="invoice-summary-row">
                                <div class="invoice-summary-label invoice-small-font">جمع تمامی ستون ها به عدد:</div>
                                <div class="invoice-summary-value invoice-small-font">${formatCurrency(invoice.grandTotal)} ریال</div>
                            </div>
                            <div class="invoice-summary-row">
                                <div class="invoice-summary-label invoice-small-font">جمع تمامی ستون ها به حروف:</div>
                                <div class="invoice-summary-value invoice-small-font">${numberToWords(invoice.grandTotal)} ریال</div>
                            </div>
                            <div class="invoice-summary-row">
                                <div class="invoice-summary-label invoice-small-font">نحوه پرداخت:</div>
                                <div class="invoice-summary-value invoice-small-font">
                                    <span>نقدی ${paymentMethodText === 'نقدی' ? '☑' : '☐'}</span>
                                    <span style="margin-right: 20px;">غیر نقدی ${paymentMethodText === 'غیر نقدی' ? '☑' : '☐'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="invoice-standard-signatures">
                            <div class="invoice-standard-signature">
                                <div>مهر و امضای فروشنده</div>
                                <div class="invoice-standard-signature-line"></div>
                            </div>
                            <div class="invoice-standard-signature">
                                <div>مهر و امضای خریدار</div>
                                <div class="invoice-standard-signature-line"></div>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        // تابع بازگشت فاکتور
        function resetInvoice() {
            invoiceDateInput.value = getTodayPersianDate();
            invoicePartySelect.value = '';
            invoiceProductSelect.value = '';
            invoiceQuantityInput.value = '';
            invoiceDiscountInput.value = '';
            invoiceTaxInput.value = '9';
            invoiceItems = [];
            updateInvoiceItemsDisplay();
            updateInvoiceTotals();
            invoiceStandardPreview.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-receipt"></i>
                    <p>پس از پر کردن فرم، پیش‌نمایش فاکتور در اینجا نمایش داده می‌شود</p>
                </div>
            `;
        }
    </script>
</body>
</html>
