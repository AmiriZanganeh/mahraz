<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مهراز</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2c5aa0; --primary-light: #4a76c4; --primary-dark: #1a3d7a;
            --secondary: #6c757d; --light: #f8f9fa; --dark: #212529; --border: #dee2e6;
            --card-bg: #FFFFFF; --sidebar-bg: #343a40; --header-bg: #FFFFFF;
            --success: #28a745; --danger: #dc3545; --warning: #ffc107; --info: #17a2b8;
            --sidebar-width: 250px; --border-radius: 8px; --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --transition: all 0.2s ease;
            --level1: #000000; --level2: #4a76c4; --level3: #2ecc71; --level4: #e74c3c;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Vazirmatn', sans-serif; }
        body { background-color: #f5f5f5; color: var(--dark); line-height: 1.6; min-height: 100vh; }
        
        /* صفحه ورود */
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-card { background: var(--card-bg); border-radius: var(--border-radius); padding: 40px 30px; width: 100%; max-width: 400px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .brand { text-align: center; margin-bottom: 30px; }
        .brand-icon { width: 70px; height: 70px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; color: white; font-size: 1.8rem; }
        .brand-name { font-size: 1.8rem; font-weight: 700; color: var(--primary); margin-bottom: 5px; }
        .brand-tagline { color: var(--secondary); font-size: 0.9rem; }
        .input-group { margin-bottom: 20px; }
        .input-label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--dark); }
        .input-field { width: 100%; padding: 12px 15px; background: var(--light); border: 1px solid var(--border); border-radius: var(--border-radius); font-size: 1rem; color: var(--dark); }
        .input-field:focus { outline: none; border-color: var(--primary); background: white; }
        .input-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--secondary); }
        .input-with-icon { position: relative; }
        .input-with-icon .input-field { padding-left: 45px; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 20px; border: none; border-radius: var(--border-radius); font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: var(--transition); text-decoration: none; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); box-shadow: 0 4px 12px rgba(44, 90, 160, 0.3); }
        .btn-success { background-color: var(--success); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-warning { background-color: var(--warning); color: #212529; }
        .btn-info { background-color: var(--info); color: white; }
        .btn-outline { background-color: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background-color: var(--primary); color: white; }
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; }
        .btn-lg { padding: 16px 28px; font-size: 1.1rem; }
        .btn-block { width: 100%; }
        .btn-icon { width: 40px; height: 40px; padding: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .login-btn { width: 100%; background: var(--primary); color: white; border: none; padding: 12px; border-radius: var(--border-radius); cursor: pointer; font-size: 1rem; font-weight: 600; margin-top: 10px; transition: var(--transition); }
        .login-btn:hover { background: var(--primary-dark); box-shadow: 0 4px 12px rgba(44, 90, 160, 0.3); }
        .error-message { color: var(--danger); text-align: center; margin-top: 15px; font-size: 0.9rem; display: none; background: rgba(220, 53, 69, 0.05); padding: 10px; border-radius: var(--border-radius); border-right: 3px solid var(--danger); }
        
        /* صفحه اصلی */
        #main-app { display: none; }
        .app-layout { display: flex; min-height: 100vh; }
        
        /* نوار کناری */
        .sidebar { width: var(--sidebar-width); background: var(--sidebar-bg); color: white; padding: 0; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .app-logo { display: flex; align-items: center; gap: 10px; }
        .app-logo-icon { width: 40px; height: 40px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; }
        .app-logo-text { font-size: 1.1rem; font-weight: 700; color: white; }
        .sidebar-nav { flex: 1; padding: 20px 0; }
        .nav-item { padding: 12px 20px; display: flex; align-items: center; gap: 12px; cursor: pointer; color: rgba(255, 255, 255, 0.8); font-size: 0.95rem; margin: 2px 0; transition: var(--transition); }
        .nav-item.active { background: rgba(255, 255, 255, 0.1); color: white; border-right: 3px solid var(--primary); }
        .nav-item:hover:not(.active) { background: rgba(255, 255, 255, 0.05); color: white; }
        .nav-item i { width: 20px; text-align: center; font-size: 1.1rem; }
        
        /* محتوای اصلی */
        .main-content { flex: 1; padding: 0; overflow-y: auto; background: var(--light); }
        .content-header { background: var(--header-bg); padding: 20px 30px; border-bottom: 1px solid var(--border); }
        .page-title { font-size: 1.3rem; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; font-weight: 700; color: var(--dark); }
        .page-description { font-size: 0.85rem; color: var(--secondary); }
        .content-body { padding: 20px 30px; display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (max-width: 1200px) { .content-body { grid-template-columns: 1fr; } }
        .card { background: var(--card-bg); border-radius: var(--border-radius); padding: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .card-title { font-size: 1.1rem; color: var(--dark); display: flex; align-items: center; gap: 8px; font-weight: 600; }
        .card-title i { color: var(--primary); }
        select, textarea, input { width: 100%; padding: 10px 12px; background: var(--light); border: 1px solid var(--border); border-radius: var(--border-radius); font-size: 0.95rem; color: var(--dark); }
        select:focus, textarea:focus, input:focus { outline: none; border-color: var(--primary); background: white; }
        textarea { min-height: 80px; resize: vertical; }
        .empty-state { text-align: center; padding: 20px; color: var(--secondary); }
        .empty-state i { font-size: 2rem; margin-bottom: 10px; color: #adb5bd; }
        .empty-state p { font-size: 0.85rem; }
        .hidden { display: none; }
        
        /* استایل مبلغ */
        .amount-input-container { position: relative; }
        .amount-input { padding-left: 35px !important; }
        .currency-symbol { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--secondary); font-weight: 600; }
        
        /* استایل‌های جدید برای فرم‌ها */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--dark); font-size: 0.85rem; }
        .form-control { width: 100%; padding: 10px 12px; background: var(--light); border: 1px solid var(--border); border-radius: var(--border-radius); font-size: 0.95rem; color: var(--dark); }
        .form-control:focus { outline: none; border-color: var(--primary); background: white; }
        
        /* استایل‌های جدید برای بخش آمار */
        .account-stat { background: white; border-radius: var(--border-radius); padding: 12px; text-align: center; border: 1px solid var(--border); }
        .account-stat-value { font-size: 1.2rem; font-weight: 700; margin: 5px 0; color: var(--dark); }
        .account-stat-label { color: var(--secondary); font-weight: 600; font-size: 0.8rem; }
        .account-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 15px; }
        
        /* استایل‌های جدید برای پشتیبان‌گیری */
        .backup-actions { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        
        /* استایل‌های جدید برای دکمه‌های ساده */
        .simple-btn { background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: var(--border-radius); cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: var(--transition); }
        .simple-btn:hover { background: var(--primary-dark); }
        .simple-btn-danger { background: var(--danger); }
        .simple-btn-danger:hover { background: #c82333; }
        .simple-btn-success { background: var(--success); }
        .simple-btn-success:hover { background: #218838; }
        .simple-btn-warning { background: var(--warning); color: #212529; }
        .simple-btn-warning:hover { background: #e0a800; }
        .simple-btn-info { background: var(--info); }
        .simple-btn-info:hover { background: #138496; }
        
        /* استایل‌های جدید برای واحد اندازه‌گیری */
        .unit-input-container { display: flex; gap: 10px; }
        .unit-input-container .form-control { flex: 1; }
        
        /* ریسپانسیو */
        @media (max-width: 768px) {
            .app-layout { flex-direction: column; }
            .sidebar { width: 100%; height: auto; }
            .sidebar-header { padding: 15px; }
            .app-logo-text { font-size: 1rem; }
            .sidebar-nav { display: flex; justify-content: space-around; padding: 10px 0; overflow-x: auto; }
            .nav-item { flex-direction: column; padding: 8px 10px; margin: 0 2px; text-align: center; min-width: 60px; gap: 5px; }
            .nav-item-text { font-size: 0.7rem; }
            .nav-item i { font-size: 1rem; margin-bottom: 0; }
            .main-content { padding: 0; }
            .content-header { padding: 15px; }
            .content-body { padding: 15px; grid-template-columns: 1fr; }
            .backup-actions { flex-direction: column; }
            .backup-actions .btn { width: 100%; }
            .form-type-selector { flex-direction: column; }
            .form-grid-row { grid-template-columns: 1fr !important; }
        }

        /* نمایش متن در حالت بزرگتر */
        @media (min-width: 769px) { .nav-item-text { display: block; } }

        /* اسکرول بار سفارشی */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #F1F1F1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-dark); }
        
        .footer { text-align: center; padding: 15px; background: var(--sidebar-bg); color: white; margin-top: 20px; font-size: 0.8rem; }
        .footer a { color: var(--primary-light); text-decoration: none; font-weight: 600; }
        .footer a:hover { text-decoration: underline; }
        
        .section-divider { height: 1px; background: var(--border); margin: 25px 0; position: relative; }
        .section-divider::after { content: ""; position: absolute; top: -8px; left: 50%; transform: translateX(-50%); width: 16px; height: 16px; background: var(--primary); border-radius: 50%; }
        .section-title { font-size: 1.1rem; font-weight: 700; color: var(--primary); margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid var(--primary-light); display: flex; align-items: center; gap: 8px; }
        .section-title i { color: var(--primary); }
        
        .form-group { margin-bottom: 15px; }
        .form-group:last-child { margin-bottom: 0; }
        .form-section { margin-bottom: 20px; }
        .form-section:last-child { margin-bottom: 0; }
        .actions { display: flex; gap: 10px; margin-top: 15px; }
        .actions .btn { flex: 1; }

        /* استایل‌های جدید برای فرم اطلاعات شرکت و طرف حساب */
        .company-type-selector, .party-type-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .type-btn { flex: 1; padding: 10px 15px; background: var(--light); border: 1px solid var(--border); border-radius: var(--border-radius); cursor: pointer; font-size: 0.9rem; font-weight: 600; text-align: center; transition: var(--transition); }
        .type-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .type-btn:hover:not(.active) { background: rgba(44, 90, 160, 0.1); border-color: var(--primary); }
        .form-grid-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-grid-row .form-group { margin-bottom: 0; }
        
        /* استایل‌های جدید برای چک‌باکس */
        .checkbox-container { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .checkbox-container input[type="checkbox"] { width: auto; margin: 0; }
        
        /* استایل‌های جدید برای بخش فاکتور */
        .invoice-section { margin-top: 20px; }
        .invoice-section .form-group { margin-bottom: 15px; }
        .invoice-section .invoice-item-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .invoice-section .invoice-item-row .form-group { margin-bottom: 0; }

        /* استایل‌های جدید برای بخش انبار */
        .inventory-update-notice { background: rgba(255, 193, 7, 0.1); border: 1px solid var(--warning); border-radius: var(--border-radius); padding: 15px; margin-top: 20px; text-align: center; color: var(--dark); font-weight: 600; }
        .inventory-update-notice i { color: var(--warning); margin-bottom: 10px; font-size: 1.5rem; }

        /* استایل‌های جدید برای دکمه‌های فاکتور */
        .invoice-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: center; }
        .invoice-actions .btn { flex: 1; max-width: 200px; }
        
        /* استایل‌های جدید برای لیست‌ها */
        .parties-list, .inventory-list, .accounts-list, .documents-list, .invoices-list { max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--border-radius); padding: 10px; background: var(--light); }
        .party-item, .inventory-item, .account-item, .document-item, .invoice-item { padding: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; border-radius: 4px; margin-bottom: 5px; background: white; }
        .party-item:hover, .inventory-item:hover, .account-item:hover, .document-item:hover, .invoice-item:hover { background: rgba(44, 90, 160, 0.05); }
        .party-item:last-child, .inventory-item:last-child, .account-item:last-child, .document-item:last-child, .invoice-item:last-child { border-bottom: none; margin-bottom: 0; }
        .party-info, .inventory-info, .account-info, .document-info, .invoice-info { flex: 1; }
        .party-title, .inventory-title, .account-title, .document-title, .invoice-title { font-weight: 600; font-size: 0.85rem; color: var(--dark); margin-bottom: 4px; }
        .party-meta, .inventory-meta, .account-meta, .document-meta, .invoice-meta { display: flex; gap: 10px; font-size: 0.75rem; color: var(--secondary); }
        .party-actions, .inventory-actions, .account-actions, .document-actions, .invoice-actions-list { display: flex; gap: 5px; }
        
        /* استایل‌های جدید برای کدینگ حسابداری درختی */
        .accounting-tree { border: 1px solid var(--border); border-radius: var(--border-radius); padding: 15px; background: white; }
        .tree-node { margin-bottom: 10px; }
        .tree-node-header { display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: var(--border-radius); cursor: pointer; }
        .tree-node-header:hover { background: rgba(44, 90, 160, 0.1); }
        .tree-node-content { margin-right: 20px; margin-top: 5px; display: none; }
        .tree-node-content.active { display: block; }
        .tree-node-icon { transition: var(--transition); }
        .tree-node-icon.rotated { transform: rotate(90deg); }
        .account-code { font-weight: 600; min-width: 60px; }
        .account-name { flex: 1; }
        
        /* استایل‌های جدید برای سطح‌بندی کدینگ */
        .level-1 .account-code, .level-1 .account-name { color: var(--level1); font-weight: 800; }
        .level-2 .account-code, .level-2 .account-name { color: var(--level2); font-weight: 700; }
        .level-3 .account-code, .level-3 .account-name { color: var(--level3); font-weight: 600; }
        .level-4 .account-code, .level-4 .account-name { color: var(--level4); font-weight: 500; }
        
        /* استایل‌های جدید برای فاکتور */
        .invoice-items-container { margin-top: 15px; border: 1px solid var(--border); border-radius: var(--border-radius); padding: 10px; background: var(--light); max-height: 200px; overflow-y: auto; }
        .invoice-item-display { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid var(--border); margin-bottom: 5px; background: white; border-radius: 4px; }
        .invoice-item-display:last-child { border-bottom: none; margin-bottom: 0; }
        .invoice-item-info { flex: 1; }
        .invoice-item-name { font-weight: 600; font-size: 0.85rem; color: var(--dark); }
        .invoice-item-details { display: flex; gap: 10px; font-size: 0.75rem; color: var(--secondary); margin-top: 3px; }
        .invoice-item-actions { display: flex; gap: 5px; }
        .invoice-preview { background: white; border-radius: var(--border-radius); padding: 15px; border: 1px solid var(--border); margin-top: 15px; }
        .invoice-header { display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .invoice-company-info { text-align: right; }
        .invoice-title { text-align: center; font-size: 1.2rem; font-weight: 700; margin-bottom: 15px; }
        .invoice-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .invoice-table th { background: var(--primary); color: white; padding: 8px; text-align: center; border: 1px solid var(--border); }
        .invoice-table td { padding: 6px; border: 1px solid var(--border); text-align: center; }
        .invoice-total { text-align: left; font-weight: 700; font-size: 1rem; margin-top: 15px; }
        .invoice-footer { display: flex; justify-content: space-between; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border); }
        .invoice-signature { display: flex; justify-content: space-between; margin-top: 30px; }
        
        /* استایل‌های جدید برای فاکتور متصل */
        .invoice-connected-preview { background: white; border-radius: var(--border-radius); padding: 20px; border: 1px solid var(--border); margin-top: 15px; }
        .invoice-connected-container { border: 1px solid var(--border); border-radius: var(--border-radius); margin-bottom: 20px; }
        .invoice-connected-header { text-align: center; padding: 15px; border-bottom: 1px solid var(--border); }
        .invoice-connected-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 5px; }
        .invoice-connected-number { font-size: 1rem; color: var(--secondary); }
        .invoice-connected-details { display: flex; justify-content: space-between; margin-bottom: 0; }
        .invoice-connected-seller, .invoice-connected-buyer { flex: 1; padding: 15px; }
        .invoice-connected-seller { margin-left: 0; border-bottom: none; border-radius: 0 0 0 0; }
        .invoice-connected-buyer { margin-right: 0; border-bottom: none; border-radius: 0 0 0 0; }
        .invoice-connected-section-title { font-weight: 700; margin-bottom: 10px; color: var(--primary); border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        .invoice-connected-info-row { display: flex; margin-bottom: 5px; }
        .invoice-connected-info-label { font-weight: 600; width: 120px; font-size: 0.7rem; }
        .invoice-connected-info-value { flex: 1; font-size: 0.7rem; }
        .invoice-connected-table { width: 100%; border-collapse: collapse; margin-top: 0; font-size: 0.75rem; }
        .invoice-connected-table th { background: var(--primary); color: white; padding: 8px; text-align: center; border: 1px solid var(--border); }
        .invoice-connected-table td { padding: 6px; border: 1px solid var(--border); text-align: center; }
        .invoice-connected-summary { margin-top: 0; background: rgba(44, 90, 160, 0.05); border-radius: 0 0 var(--border-radius) var(--border-radius); padding: 15px; border: 1px solid var(--border); border-top: none; }
        .invoice-connected-summary-row { display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .invoice-connected-summary-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .invoice-connected-summary-label { font-weight: 600; }
        .invoice-connected-summary-value { font-weight: 700; }
        .invoice-connected-signatures { display: flex; justify-content: space-between; margin-top: 30px; }
        .invoice-connected-signature { text-align: center; width: 45%; }
        .invoice-connected-signature-line { border-top: 1px solid var(--border); margin-top: 40px; padding-top: 5px; }
        .invoice-summary-small-font { font-size: 0.65rem !important; }
        
        /* استایل‌های جدید برای فاکتور با فونت‌های کوچکتر */
        .invoice-small-font { font-size: 0.7rem; }
        .invoice-payment-options { display: flex; gap: 20px; margin-top: 10px; }
        .invoice-payment-option { display: flex; align-items: center; gap: 5px; }
        .invoice-payment-option input { width: auto; }
        .invoice-payment-checkbox { width: 16px; height: 16px; margin-left: 5px; }
        
        /* استایل‌های جدید برای سیستم ویرایش */
        .edit-form-container { background: rgba(44, 90, 160, 0.05); border-radius: var(--border-radius); padding: 15px; margin-top: 15px; border: 1px solid var(--primary-light); }
        .edit-form-title { font-weight: 700; color: var(--primary); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .edit-form-actions { display: flex; gap: 10px; margin-top: 15px; }
        
        /* استایل‌های جدید برای تب ثبت سند حسابداری */
        .accounting-entry-container { display: flex; flex-direction: column; gap: 15px; }
        .accounting-entry-header { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; }
        .accounting-entry-header .form-group { margin-bottom: 0; flex: 1; min-width: 200px; }
        .entry-details-container { margin-top: 15px; border: 1px solid var(--border); border-radius: var(--border-radius); padding: 10px; background: var(--light); }
        .entry-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .entry-table th { background: var(--primary); color: white; padding: 10px; text-align: center; border: 1px solid var(--border); }
        .entry-table td { padding: 8px; border: 1px solid var(--border); text-align: center; }
        .entry-row-actions { display: flex; gap: 5px; justify-content: center; }
        .entry-totals { margin-top: 15px; display: flex; justify-content: space-between; font-weight: 700; padding: 10px; background: rgba(44, 90, 160, 0.05); border-radius: var(--border-radius); }
        
        /* استایل‌های جدید برای تب اسناد */
        .document-details { background: white; border-radius: var(--border-radius); padding: 15px; border: 1px solid var(--border); margin-top: 15px; }
        .document-details-header { display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .document-details-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .document-details-table th { background: rgba(44, 90, 160, 0.1); color: var(--primary); padding: 8px; text-align: center; border: 1px solid var(--border); }
        .document-details-table td { padding: 6px; border: 1px solid var(--border); text-align: center; }
        
        /* استایل‌های جدید برای دکمه افزودن کالا */
        .add-product-button-container { margin-top: 20px; margin-bottom: 20px; }
        
        /* استایل‌های جدید برای نوع شخص */
        .person-type-container { margin-bottom: 15px; }
        .person-type-label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--dark); font-size: 0.85rem; }
        .person-type-select { width: 100%; padding: 10px 12px; background: var(--light); border: 1px solid var(--border); border-radius: var(--border-radius); font-size: 0.95rem; color: var(--dark); }
        
        /* استایل‌های جدید برای فاصله بین فرم و لیست */
        .form-list-divider { margin: 25px 0; }
        
        /* استایل‌های جدید برای تب اسناد و فاکتورها */
        .documents-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .document-tab { padding: 8px 16px; background: var(--light); border: 1px solid var(--border); border-radius: var(--border-radius); cursor: pointer; font-weight: 600; }
        .document-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* استایل‌های جدید برای پیش‌نمایش فاکتور بدون مشخصات */
        .invoice-preview-simple { background: white; border-radius: var(--border-radius); padding: 15px; border: 1px solid var(--border); margin-top: 15px; }
    </style>
</head>
<body>
    <!-- صفحه ورود -->
    <div class="auth-container" id="login-page">
        <div class="login-card">
            <div class="brand">
                <div class="brand-icon"><i class="fas fa-calculator"></i></div>
                <h1 class="brand-name">مَهراز سیستم</h1>
                <p class="brand-tagline">مَهراز، راز موفقیت مالی تو</p>
            </div>
            <form class="login-form" id="login-form">
                <div class="input-group">
                    <label for="password" class="input-label">رمز عبور</label>
                    <div class="input-with-icon">
                        <i class="fas fa-lock input-icon"></i>
                        <input type="password" id="password" class="input-field" placeholder="رمز عبور خود را وارد کنید" required>
                    </div>
                </div>
                <button type="submit" class="login-btn"><i class="fas fa-sign-in-alt"></i> ورود به سیستم</button>
                <div class="error-message" id="error-message"><i class="fas fa-exclamation-circle"></i> رمز عبور اشتباه است!</div>
            </form>
        </div>
    </div>

    <!-- صفحه اصلی سیستم -->
    <div id="main-app">
        <div class="app-layout">
            <!-- نوار کناری -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="app-logo">
                        <div class="app-logo-icon"><i class="fas fa-calculator"></i></div>
                        <div class="app-logo-text">مَهراز</div>
                    </div>
                </div>
                <div class="sidebar-nav">
                    <div class="nav-item active" data-tab="dashboard"><i class="fas fa-user"></i><span class="nav-item-text">داشبورد</span></div>
                    <div class="nav-item" data-tab="parties"><i class="fas fa-users"></i><span class="nav-item-text">اشخاص</span></div>
                    <div class="nav-item" data-tab="products"><i class="fas fa-cubes"></i><span class="nav-item-text">کالا/خدمات</span></div>
                    <div class="nav-item" data-tab="accounts"><i class="fas fa-table"></i><span class="nav-item-text">جداول حساب</span></div>
                    <div class="nav-item" data-tab="invoice"><i class="fas fa-receipt"></i><span class="nav-item-text">فاکتور</span></div>
                    <div class="nav-item" data-tab="register"><i class="fas fa-file-invoice"></i><span class="nav-item-text">ثبت سند</span></div>
                    <div class="nav-item" data-tab="documents"><i class="fas fa-archive"></i><span class="nav-item-text">اسناد</span></div>
                </div>
            </div>
            
            <!-- محتوای اصلی -->
            <div class="main-content">
                <div class="content-header">
                    <h1 class="page-title" id="page-title"><i class="fas fa-user"></i> داشبورد مدیریتی</h1>
                    <p class="page-description" id="page-description">نمایش کلی وضعیت مالی و مدیریت سیستم</p>
                </div>
                
                <div class="content-body">
                    <!-- تب داشبورد -->
                    <div id="dashboard-tab" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-building"></i> اطلاعات شخص حقیقی/حقوقی</h2>
                            </div>
                            <div class="company-info-section">
                                <div class="form-grid-row">
                                    <div class="form-group">
                                        <label class="form-label">نوع شخص</label>
                                        <select id="company-type" class="form-control">
                                            <option value="legal">حقوقی</option>
                                            <option value="individual">حقیقی</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">نام شرکت/شخص</label>
                                        <input type="text" id="company-name" class="form-control" placeholder="نام شرکت/شخص">
                                    </div>
                                </div>
                                <div class="form-grid-row">
                                    <div class="form-group">
                                        <label class="form-label">کد اقتصادی</label>
                                        <input type="text" id="company-economic-code" class="form-control" placeholder="کد اقتصادی">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">شناسه ملی</label>
                                        <input type="text" id="company-national-id" class="form-control" placeholder="شناسه ملی">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">شماره ثبت</label>
                                        <input type="text" id="company-registration-number" class="form-control" placeholder="شماره ثبت">
                                    </div>
                                </div>
                                <div class="form-grid-row">
                                    <div class="form-group">
                                        <label class="form-label">تلفن</label>
                                        <input type="text" id="company-phone" class="form-control" placeholder="تلفن">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">شماره تماس</label>
                                        <input type="text" id="company-mobile" class="form-control" placeholder="شماره تماس">
                                    </div>
                                </div>
                                <div class="form-grid-row">
                                    <div class="form-group">
                                        <label class="form-label">کد پستی</label>
                                        <input type="text" id="company-postal-code" class="form-control" placeholder="کد پستی">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">آدرس</label>
                                        <textarea id="company-address" class="form-control" rows="2" placeholder="آدرس"></textarea>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <button type="button" id="save-company-info" class="simple-btn simple-btn-success"><i class="fas fa-save"></i> ذخیره اطلاعات</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-calendar-alt"></i> مدیریت دوره مالی</h2>
                            </div>
                            <div class="fiscal-period-section">
                                <div class="fiscal-period-form">
                                    <div class="form-grid-row">
                                        <div class="form-group">
                                            <label for="fiscal-period-start" class="form-label">تاریخ شروع دوره مالی</label>
                                            <input type="text" id="fiscal-period-start" class="form-control" placeholder="مثال: ۱۴۰۴/۸/۱۵">
                                        </div>
                                        <div class="form-group">
                                            <label for="fiscal-period-end" class="form-label">تاریخ پایان دوره مالی</label>
                                            <input type="text" id="fiscal-period-end" class="form-control" placeholder="مثال: ۱۴۰۴/۸/۱۵">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <button type="button" id="save-fiscal-period" class="simple-btn simple-btn-success"><i class="fas fa-save"></i> ذخیره دوره مالی</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-database"></i> پشتیبان‌گیری و بازیابی داده‌ها</h2>
                            </div>
                            <div class="backup-section">
                                <div class="backup-actions">
                                    <button type="button" id="export-data" class="simple-btn simple-btn-info"><i class="fas fa-download"></i> Export JSON</button>
                                    <button type="button" id="import-data" class="simple-btn simple-btn-warning"><i class="fas fa-upload"></i> Import JSON</button>
                                    <button type="button" id="reset-data" class="simple-btn simple-btn-danger"><i class="fas fa-trash"></i> بازنشانی داده‌ها</button>
                                </div>
                                <input type="file" id="import-file" accept=".json" style="display: none;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- تب اشخاص -->
                    <div id="parties-tab" class="tab-content hidden">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-users"></i> مدیریت اشخاص</h2>
                            </div>
                            <div class="parties-section">
                                <div class="form-grid-row">
                                    <div class="form-group">
                                        <label class="form-label">نوع شخص</label>
                                        <select id="party-type" class="form-control">
                                            <option value="legal">حقوقی</option>
                                            <option value="individual">حقیقی</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">نام طرف حساب</label>
                                        <input type="text" id="party-name" class="form-control" placeholder="نام طرف حساب">
                                    </div>
                                </div>
                                <div class="form-grid-row">
                                    <div class="form-group">
                                        <label class="form-label">کد اقتصادی</label>
                                        <input type="text" id="party-economic-code" class="form-control" placeholder="کد اقتصادی">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">شناسه ملی</label>
                                        <input type="text" id="party-national-id" class="form-control" placeholder="شناسه ملی">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">شماره ثبت</label>
                                        <input type="text" id="party-registration-number" class="form-control" placeholder="شماره ثبت">
                                    </div>
                                </div>
                                <div class="form-grid-row">
                                    <div class="form-group">
                                        <label class="form-label">تلفن</label>
                                        <input type="text" id="party-phone" class="form-control" placeholder="تلفن">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">شماره تماس</label>
                                        <input type="text" id="party-mobile" class="form-control" placeholder="شماره تماس">
                                    </div>
                                </div>
                                <div class="form-grid-row">
                                    <div class="form-group">
                                        <label class="form-label">کد پستی</label>
                                        <input type="text" id="party-postal-code" class="form-control" placeholder="کد پستی">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">آدرس</label>
                                        <textarea id="party-address" class="form-control" rows="2" placeholder="آدرس"></textarea>
                                    </div>
                                </div>
                                <div class="form-group add-party-button">
                                    <button type="button" id="add-party" class="simple-btn simple-btn-success"><i class="fas fa-plus"></i> افزودن شخص</button>
                                </div>
                                
                                <!-- فرم ویرایش شخص -->
                                <div id="edit-party-form" class="edit-form-container hidden">
                                    <div class="edit-form-title"><i class="fas fa-edit"></i> ویرایش شخص</div>
                                    <div class="form-grid-row">
                                        <div class="form-group">
                                            <label class="form-label">نوع شخص</label>
                                            <select id="edit-party-type" class="form-control">
                                                <option value="legal">حقوقی</option>
                                                <option value="individual">حقیقی</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">نام طرف حساب</label>
                                            <input type="text" id="edit-party-name" class="form-control" placeholder="نام طرف حساب">
                                        </div>
                                    </div>
                                    <div class="form-grid-row">
                                        <div class="form-group">
                                            <label class="form-label">کد اقتصادی</label>
                                            <input type="text" id="edit-party-economic-code" class="form-control" placeholder="کد اقتصادی">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">شناسه ملی</label>
                                            <input type="text" id="edit-party-national-id" class="form-control" placeholder="شناسه ملی">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">شماره ثبت</label>
                                            <input type="text" id="edit-party-registration-number" class="form-control" placeholder="شماره ثبت">
                                        </div>
                                    </div>
                                    <div class="form-grid-row">
                                        <div class="form-group">
                                            <label class="form-label">تلفن</label>
                                            <input type="text" id="edit-party-phone" class="form-control" placeholder="تلفن">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">شماره تماس</label>
                                            <input type="text" id="edit-party-mobile" class="form-control" placeholder="شماره تماس">
                                        </div>
                                    </div>
                                    <div class="form-grid-row">
                                        <div class="form-group">
                                            <label class="form-label">کد پستی</label>
                                            <input type="text" id="edit-party-postal-code" class="form-control" placeholder="کد پستی">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">آدرس</label>
                                            <textarea id="edit-party-address" class="form-control" rows="2" placeholder="آدرس"></textarea>
                                        </div>
                                    </div>
                                    <div class="edit-form-actions">
                                        <button type="button" id="update-party" class="simple-btn simple-btn-success"><i class="fas fa-save"></i> به‌روزرسانی</button>
                                        <button type="button" id="cancel-edit-party" class="simple-btn simple-btn-warning"><i class="fas fa-times"></i> انصراف</button>
                                    </div>
                                </div>
                                
                                <div class="form-list-divider"></div>
                                
                                <div class="parties-list" id="parties-list">
                                    <div class="empty-state"><i class="fas fa-users"></i><p>هیچ شخصی ثبت نشده است</p></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- تب کالا/خدمات -->
                    <div id="products-tab" class="tab-content hidden">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-cubes"></i> مدیریت کالا/خدمات</h2>
                            </div>
                            <div class="inventory-section">
                                <div class="form-grid-row">
                                    <div class="form-group">
                                        <label class="form-label">کد کالا/خدمات</label>
                                        <input type="text" id="product-code" class="form-control" placeholder="کد کالا/خدمات">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">شرح کالا/خدمات</label>
                                        <input type="text" id="product-name" class="form-control" placeholder="شرح کالا/خدمات">
                                    </div>
                                </div>
                                <div class="form-grid-row">
                                    <div class="form-group">
                                        <label class="form-label">بهای واحد</label>
                                        <div class="amount-input-container">
                                            <span class="currency-symbol">﷼</span>
                                            <input type="text" id="product-price" class="form-control amount-input" placeholder="0">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">واحد اندازه‌گیری</label>
                                        <input type="text" id="product-unit" class="form-control" placeholder="مثال: عدد، کیلوگرم، متر">
                                    </div>
                                </div>
                                <div class="add-product-button-container">
                                    <button type="button" id="add-product" class="simple-btn simple-btn-success"><i class="fas fa-plus"></i> افزودن کالا/خدمات</button>
                                </div>
                                
                                <!-- فرم ویرایش کالا -->
                                <div id="edit-product-form" class="edit-form-container hidden">
                                    <div class="edit-form-title"><i class="fas fa-edit"></i> ویرایش کالا/خدمات</div>
                                    <div class="form-grid-row">
                                        <div class="form-group">
                                            <label class="form-label">کد کالا/خدمات</label>
                                            <input type="text" id="edit-product-code" class="form-control" placeholder="کد کالا/خدمات">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">شرح کالا/خدمات</label>
                                            <input type="text" id="edit-product-name" class="form-control" placeholder="شرح کالا/خدمات">
                                        </div>
                                    </div>
                                    <div class="form-grid-row">
                                        <div class="form-group">
                                            <label class="form-label">بهای واحد</label>
                                            <div class="amount-input-container">
                                                <span class="currency-symbol">﷼</span>
                                                <input type="text" id="edit-product-price" class="form-control amount-input" placeholder="0">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">واحد اندازه‌گیری</label>
                                            <input type="text" id="edit-product-unit" class="form-control" placeholder="مثال: عدد، کیلوگرم، متر">
                                        </div>
                                    </div>
                                    <div class="edit-form-actions">
                                        <button type="button" id="update-product" class="simple-btn simple-btn-success"><i class="fas fa-save"></i> به‌روزرسانی</button>
                                        <button type="button" id="cancel-edit-product" class="simple-btn simple-btn-warning"><i class="fas fa-times"></i> انصراف</button>
                                    </div>
                                </div>
                                
                                <div class="inventory-list" id="inventory-list">
                                    <div class="empty-state"><i class="fas fa-cubes"></i><p>هیچ کالا/خدماتی ثبت نشده است</p></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- تب جداول حساب -->
                    <div id="accounts-tab" class="tab-content hidden">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-table"></i> کدینگ حسابداری درختی</h2>
                            </div>
                            <div class="accounting-tree" id="accounting-tree">
                                <!-- ساختار درختی کدینگ حسابداری در اینجا قرار می‌گیرد -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- تب فاکتور -->
                    <div id="invoice-tab" class="tab-content hidden">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-receipt"></i> فاکتور فروش/خدمات</h2>
                            </div>
                            <div class="invoice-section">
                                <div class="form-grid-row">
                                    <div class="form-group">
                                        <label class="form-label">تاریخ فاکتور</label>
                                        <input type="text" id="invoice-date" class="form-control" placeholder="مثال: ۱۴۰۴/۸/۱۵">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">خریدار</label>
                                        <select id="invoice-party" class="form-control">
                                            <option value="">انتخاب کنید</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="invoice-items">
                                    <h4>موارد فاکتور</h4>
                                    <div class="form-grid-row">
                                        <div class="form-group">
                                            <label class="form-label">کد کالا/خدمات</label>
                                            <select class="form-control invoice-product">
                                                <option value="">انتخاب کنید</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">مقدار</label>
                                            <input type="text" class="form-control invoice-quantity" placeholder="0">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">تخفیف (درصد)</label>
                                            <input type="text" class="form-control invoice-item-discount" placeholder="0">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">مالیات (درصد)</label>
                                            <input type="text" class="form-control invoice-item-tax" placeholder="9">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">نحوه پرداخت</label>
                                        <div class="invoice-payment-options">
                                            <div class="invoice-payment-option">
                                                <input type="radio" id="payment-cash" name="payment-method" value="cash" class="invoice-payment-checkbox">
                                                <label for="payment-cash">نقدی</label>
                                            </div>
                                            <div class="invoice-payment-option">
                                                <input type="radio" id="payment-non-cash" name="payment-method" value="non-cash" class="invoice-payment-checkbox">
                                                <label for="payment-non-cash">غیر نقدی</label>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" id="add-invoice-item" class="simple-btn simple-btn-success"><i class="fas fa-plus"></i> افزودن ردیف فاکتور</button>
                                </div>
                                <div class="invoice-items-container" id="invoice-items-container">
                                    <div class="empty-state"><i class="fas fa-receipt"></i><p>هیچ موردی به فاکتور اضافه نشده است</p></div>
                                </div>
                                <div class="invoice-connected-preview" id="invoice-connected-preview">
                                    <div class="empty-state"><i class="fas fa-receipt"></i><p>پس از پر کردن فرم، پیش‌نمایش فاکتور در اینجا نمایش داده می‌شود</p></div>
                                </div>
                                <div class="invoice-actions">
                                    <button id="save-invoice" class="simple-btn simple-btn-success"><i class="fas fa-save"></i> ذخیره فاکتور</button>
                                    <button id="print-invoice" class="simple-btn simple-btn-info"><i class="fas fa-print"></i> چاپ فاکتور</button>
                                    <button id="reset-invoice" class="simple-btn simple-btn-warning"><i class="fas fa-undo"></i> بازگشت</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- تب ثبت سند حسابداری -->
                    <div id="register-tab" class="tab-content hidden">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-file-invoice"></i> ثبت سند حسابداری</h2>
                            </div>
                            <div class="accounting-entry-container">
                                <div class="accounting-entry-header">
                                    <div class="form-group">
                                        <label for="entry-date" class="form-label">تاریخ سند</label>
                                        <input type="text" id="entry-date" class="form-control" placeholder="مثال: ۱۴۰۴/۸/۱۵">
                                    </div>
                                    <div class="form-group">
                                        <label for="entry-description" class="form-label">شرح سند</label>
                                        <input type="text" id="entry-description" class="form-control" placeholder="شرح سند حسابداری">
                                    </div>
                                    <button type="button" id="add-entry-row" class="simple-btn simple-btn-success"><i class="fas fa-plus"></i> افزودن ردیف</button>
                                </div>
                                
                                <div class="entry-details-container">
                                    <table class="entry-table" id="entry-table">
                                        <thead>
                                            <tr>
                                                <th>ردیف</th>
                                                <th>حساب معین</th>
                                                <th>تفصیل</th>
                                                <th>شرح</th>
                                                <th>بدهکار</th>
                                                <th>بستانکار</th>
                                                <th>عملیات</th>
                                            </tr>
                                        </thead>
                                        <tbody id="entry-table-body">
                                            <!-- ردیف‌های سند در اینجا اضافه می‌شوند -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="entry-totals" id="entry-totals">
                                    <div>جمع بدهکار: <span id="total-debit">0</span> ریال</div>
                                    <div>جمع بستانکار: <span id="total-credit">0</span> ریال</div>
                                </div>
                                
                                <div class="actions">
                                    <button id="save-entry" class="simple-btn simple-btn-success"><i class="fas fa-save"></i> ثبت سند</button>
                                    <button id="reset-entry" class="simple-btn simple-btn-warning"><i class="fas fa-undo"></i> بازگشت</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- تب اسناد -->
                    <div id="documents-tab" class="tab-content hidden">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-archive"></i> مدیریت اسناد و فاکتورها</h2>
                            </div>
                            
                            <div class="documents-tabs">
                                <div class="document-tab active" data-type="documents">اسناد حسابداری</div>
                                <div class="document-tab" data-type="invoices">فاکتورها</div>
                            </div>
                            
                            <!-- لیست اسناد حسابداری -->
                            <div id="documents-list-container">
                                <div class="documents-list" id="documents-list">
                                    <div class="empty-state"><i class="fas fa-file-alt"></i><p>هیچ سندی ثبت نشده است</p></div>
                                </div>
                                
                                <!-- نمایش جزئیات سند -->
                                <div id="document-details" class="document-details hidden">
                                    <div class="document-details-header">
                                        <h3>مشاهده سند شماره <span id="document-number"></span></h3>
                                        <div class="document-actions">
                                            <button id="close-document" class="simple-btn simple-btn-warning"><i class="fas fa-times"></i> بستن</button>
                                        </div>
                                    </div>
                                    <div class="document-info">
                                        <p><strong>تاریخ:</strong> <span id="document-date"></span></p>
                                        <p><strong>شرح:</strong> <span id="document-description"></span></p>
                                    </div>
                                    <table class="document-details-table" id="document-details-table">
                                        <thead>
                                            <tr>
                                                <th>ردیف</th>
                                                <th>کد حساب</th>
                                                <th>نام حساب</th>
                                                <th>تفصیل</th>
                                                <th>شرح</th>
                                                <th>بدهکار</th>
                                                <th>بستانکار</th>
                                            </tr>
                                        </thead>
                                        <tbody id="document-details-body">
                                            <!-- جزئیات سند در اینجا نمایش داده می‌شود -->
                                        </tbody>
                                    </table>
                                    <div class="entry-totals" id="document-totals">
                                        <div>جمع بدهکار: <span id="document-total-debit">0</span> ریال</div>
                                        <div>جمع بستانکار: <span id="document-total-credit">0</span> ریال</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- لیست فاکتورها -->
                            <div id="invoices-list-container" class="hidden">
                                <div class="invoices-list" id="invoices-list">
                                    <div class="empty-state"><i class="fas fa-receipt"></i><p>هیچ فاکتوری ثبت نشده است</p></div>
                                </div>
                                
                                <!-- نمایش جزئیات فاکتور -->
                                <div id="invoice-details" class="document-details hidden">
                                    <div class="document-details-header">
                                        <h3>مشاهده فاکتور شماره <span id="invoice-view-number"></span></h3>
                                        <div class="document-actions">
                                            <button id="print-invoice-details" class="simple-btn simple-btn-info"><i class="fas fa-print"></i> چاپ فاکتور</button>
                                            <button id="delete-invoice-details" class="simple-btn simple-btn-danger"><i class="fas fa-trash"></i> حذف</button>
                                            <button id="close-invoice" class="simple-btn simple-btn-warning"><i class="fas fa-times"></i> بستن</button>
                                        </div>
                                    </div>
                                    <div id="invoice-details-content">
                                        <!-- محتوای فاکتور در اینجا نمایش داده می‌شود -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer">طراحی شده توسط <a href="https://amirizanganeh.github.io/accountant/" target="_blank">مهدی امیری</a></div>
    </div>

    <script>
        // اطلاعات ورود
        const VALID_PASSWORD = "1";
        
        // نام و نسخه پایگاه داده
        const DB_NAME = 'MahrazSystem';
        const DB_VERSION = 18; // افزایش نسخه برای تغییرات جدید
        
        // نام جداول
        const STORE_NAMES = {
            ACCOUNTS: 'accounts', PARTIES: 'parties', INVENTORY: 'inventory', INVOICES: 'invoices', 
            INVOICE_COUNTER: 'invoice_counter', FISCAL_PERIOD: 'fiscal_period', SETTINGS: 'settings',
            COMPANY_INFO: 'company_info', DOCUMENTS: 'documents', DOCUMENT_COUNTER: 'document_counter'
        };
        
        // آرایه برای ذخیره حساب‌ها
        let accounts = [];
        
        // آرایه برای ذخیره طرف‌های حساب
        let parties = [];
        
        // آرایه برای ذخیره کالاها
        let inventory = [];
        
        // آرایه برای ذخیره فاکتورها
        let savedInvoices = [];
        let invoiceCounter = 1;
        
        // آرایه برای ذخیره اسناد حسابداری
        let savedDocuments = [];
        let documentCounter = 1;
        
        // اطلاعات شرکت
        let companyInfo = { type: 'legal', name: '', economicCode: '', nationalId: '', registrationNumber: '', phone: '', mobile: '', address: '', postalCode: '' };
        
        // اطلاعات دوره مالی
        let fiscalPeriod = { startDate: '', endDate: '' };
        
        // تنظیمات سیستم
        let settings = { vatPercentage: 9 };
        
        // آرایه برای ذخیره اقلام فاکتور
        let invoiceItems = [];
        
        // آرایه برای ذخیره ردیف‌های سند حسابداری
        let documentEntries = [];
        
        // متغیر پایگاه داده
        let db;
        
        // متغیرهای ویرایش
        let editingPartyId = null;
        let editingProductId = null;
        let editingDocumentId = null;
        let viewingInvoiceId = null;
        let currentDocumentType = 'documents'; // 'documents' یا 'invoices'
        
        // عناصر DOM
        const loginPage = document.getElementById('login-page');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const errorMessage = document.getElementById('error-message');
        const pageTitle = document.getElementById('page-title');
        const pageDescription = document.getElementById('page-description');
        
        const navItems = document.querySelectorAll('.nav-item');
        const tabContents = document.querySelectorAll('.tab-content');
        const exportDataBtn = document.getElementById('export-data');
        const importDataBtn = document.getElementById('import-data');
        const resetDataBtn = document.getElementById('reset-data');
        const importFileInput = document.getElementById('import-file');
        const fiscalPeriodStart = document.getElementById('fiscal-period-start');
        const fiscalPeriodEnd = document.getElementById('fiscal-period-end');
        const saveFiscalPeriodBtn = document.getElementById('save-fiscal-period');
        
        // عناصر جدید
        const addPartyBtn = document.getElementById('add-party');
        const partyNameInput = document.getElementById('party-name');
        const partyEconomicCodeInput = document.getElementById('party-economic-code');
        const partyNationalIdInput = document.getElementById('party-national-id');
        const partyRegistrationNumberInput = document.getElementById('party-registration-number');
        const partyPhoneInput = document.getElementById('party-phone');
        const partyMobileInput = document.getElementById('party-mobile');
        const partyAddressInput = document.getElementById('party-address');
        const partyPostalCodeInput = document.getElementById('party-postal-code');
        const partyTypeSelect = document.getElementById('party-type');
        const partiesList = document.getElementById('parties-list');
        const companyNameInput = document.getElementById('company-name');
        const companyEconomicCodeInput = document.getElementById('company-economic-code');
        const companyNationalIdInput = document.getElementById('company-national-id');
        const companyRegistrationNumberInput = document.getElementById('company-registration-number');
        const companyPhoneInput = document.getElementById('company-phone');
        const companyMobileInput = document.getElementById('company-mobile');
        const companyAddressInput = document.getElementById('company-address');
        const companyPostalCodeInput = document.getElementById('company-postal-code');
        const companyTypeSelect = document.getElementById('company-type');
        const saveCompanyInfoBtn = document.getElementById('save-company-info');
        const addProductBtn = document.getElementById('add-product');
        const productCodeInput = document.getElementById('product-code');
        const productNameInput = document.getElementById('product-name');
        const productPriceInput = document.getElementById('product-price');
        const productUnitInput = document.getElementById('product-unit');
        const inventoryList = document.getElementById('inventory-list');
        const invoiceDateInput = document.getElementById('invoice-date');
        const invoicePartySelect = document.getElementById('invoice-party');
        const invoiceProductSelect = document.querySelector('.invoice-product');
        const invoiceQuantityInput = document.querySelector('.invoice-quantity');
        const invoiceItemDiscountInput = document.querySelector('.invoice-item-discount');
        const invoiceItemTaxInput = document.querySelector('.invoice-item-tax');
        const addInvoiceItemBtn = document.getElementById('add-invoice-item');
        const invoiceConnectedPreview = document.getElementById('invoice-connected-preview');
        const printInvoiceBtn = document.getElementById('print-invoice');
        const resetInvoiceBtn = document.getElementById('reset-invoice');
        const saveInvoiceBtn = document.getElementById('save-invoice');
        
        // عناصر جدید برای تب ثبت
        const entryDateInput = document.getElementById('entry-date');
        const entryDescriptionInput = document.getElementById('entry-description');
        const addEntryRowBtn = document.getElementById('add-entry-row');
        const entryTableBody = document.getElementById('entry-table-body');
        const totalDebitSpan = document.getElementById('total-debit');
        const totalCreditSpan = document.getElementById('total-credit');
        const saveEntryBtn = document.getElementById('save-entry');
        const resetEntryBtn = document.getElementById('reset-entry');
        
        // عناصر جدید برای تب اسناد
        const documentsList = document.getElementById('documents-list');
        const documentDetails = document.getElementById('document-details');
        const documentNumberSpan = document.getElementById('document-number');
        const documentDateSpan = document.getElementById('document-date');
        const documentDescriptionSpan = document.getElementById('document-description');
        const documentDetailsBody = document.getElementById('document-details-body');
        const documentTotalDebitSpan = document.getElementById('document-total-debit');
        const documentTotalCreditSpan = document.getElementById('document-total-credit');
        const closeDocumentBtn = document.getElementById('close-document');
        
        // عناصر جدید برای تب اسناد - بخش فاکتورها
        const documentTabs = document.querySelectorAll('.document-tab');
        const documentsListContainer = document.getElementById('documents-list-container');
        const invoicesListContainer = document.getElementById('invoices-list-container');
        const invoicesList = document.getElementById('invoices-list');
        const invoiceDetails = document.getElementById('invoice-details');
        const invoiceViewNumberSpan = document.getElementById('invoice-view-number');
        const invoiceDetailsContent = document.getElementById('invoice-details-content');
        const printInvoiceDetailsBtn = document.getElementById('print-invoice-details');
        const deleteInvoiceDetailsBtn = document.getElementById('delete-invoice-details');
        const closeInvoiceBtn = document.getElementById('close-invoice');
        
        // عناصر جدید برای بخش فاکتور
        const invoiceItemsContainer = document.getElementById('invoice-items-container');
        
        // عناصر جدید برای فرم‌های ویرایش
        const editPartyForm = document.getElementById('edit-party-form');
        const editPartyNameInput = document.getElementById('edit-party-name');
        const editPartyEconomicCodeInput = document.getElementById('edit-party-economic-code');
        const editPartyNationalIdInput = document.getElementById('edit-party-national-id');
        const editPartyRegistrationNumberInput = document.getElementById('edit-party-registration-number');
        const editPartyPhoneInput = document.getElementById('edit-party-phone');
        const editPartyMobileInput = document.getElementById('edit-party-mobile');
        const editPartyAddressInput = document.getElementById('edit-party-address');
        const editPartyPostalCodeInput = document.getElementById('edit-party-postal-code');
        const editPartyTypeSelect = document.getElementById('edit-party-type');
        const updatePartyBtn = document.getElementById('update-party');
        const cancelEditPartyBtn = document.getElementById('cancel-edit-party');
        
        const editProductForm = document.getElementById('edit-product-form');
        const editProductCodeInput = document.getElementById('edit-product-code');
        const editProductNameInput = document.getElementById('edit-product-name');
        const editProductPriceInput = document.getElementById('edit-product-price');
        const editProductUnitInput = document.getElementById('edit-product-unit');
        const updateProductBtn = document.getElementById('update-product');
        const cancelEditProductBtn = document.getElementById('cancel-edit-product');
        
        // مدیریت ورود به سیستم
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const password = document.getElementById('password').value;
            if (password === VALID_PASSWORD) {
                loginPage.style.display = 'none';
                mainApp.style.display = 'block';
                initializeApp();
            } else {
                errorMessage.style.display = 'block';
            }
        });
        
        // مدیریت پشتیبان‌گیری و بازیابی
        exportDataBtn.addEventListener('click', exportData);
        importDataBtn.addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', importData);
        resetDataBtn.addEventListener('click', resetData);
        
        // مدیریت دوره مالی
        saveFiscalPeriodBtn.addEventListener('click', saveFiscalPeriod);
        
        // مدیریت کلیک روی آیتم‌های ناوبری
        navItems.forEach(navItem => {
            navItem.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                navItems.forEach(item => item.classList.remove('active'));
                tabContents.forEach(content => content.classList.add('hidden'));
                this.classList.add('active');
                document.getElementById(`${tabId}-tab`).classList.remove('hidden');
                updatePageTitle(tabId);
                if (tabId === 'parties') {
                    updatePartiesList();
                }
                if (tabId === 'products') {
                    updateInventoryList();
                }
                if (tabId === 'accounts') {
                    updateAccountingTree();
                }
                if (tabId === 'invoice') {
                    updateInventoryList();
                    updateInvoicePartySelect();
                    updateInvoiceProductSelect();
                }
                if (tabId === 'register') {
                    updateSubsidiaryAccounts();
                    resetEntryForm();
                }
                if (tabId === 'documents') {
                    updateDocumentsList();
                    updateInvoicesList();
                }
            });
        });
        
        // مدیریت تب‌های اسناد و فاکتورها
        documentTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                documentTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentDocumentType = this.getAttribute('data-type');
                
                if (currentDocumentType === 'documents') {
                    documentsListContainer.classList.remove('hidden');
                    invoicesListContainer.classList.add('hidden');
                } else {
                    documentsListContainer.classList.add('hidden');
                    invoicesListContainer.classList.remove('hidden');
                }
            });
        });
        
        // مدیریت افزودن طرف حساب
        addPartyBtn.addEventListener('click', addParty);
        
        // مدیریت ذخیره اطلاعات شرکت
        saveCompanyInfoBtn.addEventListener('click', saveCompanyInfo);
        
        // مدیریت افزودن کالا
        addProductBtn.addEventListener('click', addProduct);
        
        // مدیریت افزودن ردیف فاکتور
        addInvoiceItemBtn.addEventListener('click', addInvoiceItem);
        
        // مدیریت ذخیره فاکتور
        saveInvoiceBtn.addEventListener('click', saveInvoice);
        
        // مدیریت چاپ فاکتور
        printInvoiceBtn.addEventListener('click', printInvoice);
        
        // مدیریت بازگشت فاکتور
        resetInvoiceBtn.addEventListener('click', resetInvoice);
        
        // مدیریت ویرایش شخص
        updatePartyBtn.addEventListener('click', updateParty);
        cancelEditPartyBtn.addEventListener('click', cancelEditParty);
        
        // مدیریت ویرایش کالا
        updateProductBtn.addEventListener('click', updateProduct);
        cancelEditProductBtn.addEventListener('click', cancelEditProduct);
        
        // مدیریت تب ثبت
        addEntryRowBtn.addEventListener('click', addEntryRow);
        saveEntryBtn.addEventListener('click', saveDocument);
        resetEntryBtn.addEventListener('click', resetEntryForm);
        
        // مدیریت تب اسناد
        closeDocumentBtn.addEventListener('click', closeDocumentDetails);
        
        // مدیریت تب اسناد - بخش فاکتورها
        printInvoiceDetailsBtn.addEventListener('click', function() {
            if (viewingInvoiceId) printInvoiceFromList(viewingInvoiceId);
        });
        deleteInvoiceDetailsBtn.addEventListener('click', function() {
            if (viewingInvoiceId) deleteInvoiceFromList(viewingInvoiceId);
        });
        closeInvoiceBtn.addEventListener('click', closeInvoiceDetails);
        
        // مقداردهی اولیه برنامه پس از ورود
        function initializeApp() {
            openDatabase().then(() => {
                return Promise.all([
                    loadAccounts(), loadParties(), loadInventory(), loadInvoices(), loadInvoiceCounter(),
                    loadFiscalPeriod(), loadSettings(), loadCompanyInfo(), loadDocuments(), loadDocumentCounter()
                ]);
            }).then(() => {
                const today = getTodayPersianDate();
                document.getElementById('invoice-date').value = today;
                document.getElementById('entry-date').value = today;
                
                updatePartiesList();
                updateCompanyInfo();
                updateInventoryList();
                updateInvoicePartySelect();
                updateInvoiceProductSelect();
                updateAccountingTree();
                updateSubsidiaryAccounts();
                
            }).catch(error => {
                console.error('خطا در مقداردهی اولیه برنامه:', error);
                showNotification('خطا در بارگذاری داده‌ها!', 'error');
            });
        }
        
        // توابع IndexedDB
        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(new Error('خطا در باز کردن پایگاه داده'));
                request.onsuccess = (event) => { db = event.target.result; resolve(); };
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAMES.ACCOUNTS)) {
                        const accountsStore = db.createObjectStore(STORE_NAMES.ACCOUNTS, { keyPath: 'id' });
                        accountsStore.createIndex('name', 'name', { unique: false });
                        accountsStore.createIndex('group', 'group', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORE_NAMES.PARTIES)) db.createObjectStore(STORE_NAMES.PARTIES, { keyPath: 'id' });
                    if (!db.objectStoreNames.contains(STORE_NAMES.INVENTORY)) db.createObjectStore(STORE_NAMES.INVENTORY, { keyPath: 'id' });
                    if (!db.objectStoreNames.contains(STORE_NAMES.INVOICES)) {
                        const invoicesStore = db.createObjectStore(STORE_NAMES.INVOICES, { keyPath: 'id' });
                        invoicesStore.createIndex('number', 'number', { unique: true });
                    }
                    if (!db.objectStoreNames.contains(STORE_NAMES.INVOICE_COUNTER)) db.createObjectStore(STORE_NAMES.INVOICE_COUNTER, { keyPath: 'id' });
                    if (!db.objectStoreNames.contains(STORE_NAMES.FISCAL_PERIOD)) db.createObjectStore(STORE_NAMES.FISCAL_PERIOD, { keyPath: 'id' });
                    if (!db.objectStoreNames.contains(STORE_NAMES.SETTINGS)) db.createObjectStore(STORE_NAMES.SETTINGS, { keyPath: 'id' });
                    if (!db.objectStoreNames.contains(STORE_NAMES.COMPANY_INFO)) db.createObjectStore(STORE_NAMES.COMPANY_INFO, { keyPath: 'id' });
                    if (!db.objectStoreNames.contains(STORE_NAMES.DOCUMENTS)) {
                        const documentsStore = db.createObjectStore(STORE_NAMES.DOCUMENTS, { keyPath: 'id' });
                        documentsStore.createIndex('number', 'number', { unique: true });
                    }
                    if (!db.objectStoreNames.contains(STORE_NAMES.DOCUMENT_COUNTER)) db.createObjectStore(STORE_NAMES.DOCUMENT_COUNTER, { keyPath: 'id' });
                };
            });
        }
        
        // بارگذاری حساب‌ها از IndexedDB
        function loadAccounts() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.ACCOUNTS], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.ACCOUNTS);
                const request = store.getAll();
                request.onsuccess = () => {
                    accounts = request.result;
                    if (accounts.length === 0) {
                        createStandardAccountingStructure();
                    }
                    resolve();
                };
                request.onerror = () => reject(new Error('خطا در بارگذاری حساب‌ها'));
            });
        }
        
        // بارگذاری طرف‌های حساب از IndexedDB
        function loadParties() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.PARTIES], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.PARTIES);
                const request = store.getAll();
                request.onsuccess = () => { parties = request.result; resolve(); };
                request.onerror = () => reject(new Error('خطا در بارگذاری طرف‌های حساب'));
            });
        }
        
        // بارگذاری کالاها از IndexedDB
        function loadInventory() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.INVENTORY], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.INVENTORY);
                const request = store.getAll();
                request.onsuccess = () => { inventory = request.result; resolve(); };
                request.onerror = () => reject(new Error('خطا در بارگذاری کالاها'));
            });
        }
        
        // بارگذاری فاکتورها از IndexedDB
        function loadInvoices() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.INVOICES], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.INVOICES);
                const request = store.getAll();
                request.onsuccess = () => { savedInvoices = request.result; resolve(); };
                request.onerror = () => reject(new Error('خطا در بارگذاری فاکتورها'));
            });
        }
        
        // بارگذاری شمارنده فاکتورها از IndexedDB
        function loadInvoiceCounter() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.INVOICE_COUNTER], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.INVOICE_COUNTER);
                const request = store.get(1);
                request.onsuccess = () => {
                    if (request.result) invoiceCounter = request.result.value;
                    else { invoiceCounter = 1; saveInvoiceCounter(); }
                    resolve();
                };
                request.onerror = () => reject(new Error('خطا در بارگذاری شمارنده فاکتورها'));
            });
        }
        
        // بارگذاری دوره مالی از IndexedDB
        function loadFiscalPeriod() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.FISCAL_PERIOD], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.FISCAL_PERIOD);
                const request = store.get(1);
                request.onsuccess = () => {
                    if (request.result) {
                        fiscalPeriod = request.result;
                        fiscalPeriodStart.value = fiscalPeriod.startDate || '';
                        fiscalPeriodEnd.value = fiscalPeriod.endDate || '';
                    }
                    resolve();
                };
                request.onerror = () => reject(new Error('خطا در بارگذاری دوره مالی'));
            });
        }
        
        // بارگذاری تنظیمات از IndexedDB
        function loadSettings() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.SETTINGS], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.SETTINGS);
                const request = store.get(1);
                request.onsuccess = () => {
                    if (request.result) settings = request.result;
                    resolve();
                };
                request.onerror = () => reject(new Error('خطا در بارگذاری تنظیمات'));
            });
        }
        
        // بارگذاری اطلاعات شرکت از IndexedDB
        function loadCompanyInfo() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.COMPANY_INFO], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.COMPANY_INFO);
                const request = store.get(1);
                request.onsuccess = () => {
                    if (request.result) companyInfo = request.result;
                    resolve();
                };
                request.onerror = () => reject(new Error('خطا در بارگذاری اطلاعات شرکت'));
            });
        }
        
        // بارگذاری اسناد از IndexedDB
        function loadDocuments() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.DOCUMENTS], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.DOCUMENTS);
                const request = store.getAll();
                request.onsuccess = () => { savedDocuments = request.result; resolve(); };
                request.onerror = () => reject(new Error('خطا در بارگذاری اسناد'));
            });
        }
        
        // بارگذاری شمارنده اسناد از IndexedDB
        function loadDocumentCounter() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.DOCUMENT_COUNTER], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.DOCUMENT_COUNTER);
                const request = store.get(1);
                request.onsuccess = () => {
                    if (request.result) documentCounter = request.result.value;
                    else { documentCounter = 1; saveDocumentCounter(); }
                    resolve();
                };
                request.onerror = () => reject(new Error('خطا در بارگذاری شمارنده اسناد'));
            });
        }
        
        // ذخیره طرف حساب در IndexedDB
        function saveParty(party) {
            const transaction = db.transaction([STORE_NAMES.PARTIES], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.PARTIES);
            store.put(party);
        }
        
        // ذخیره کالا در IndexedDB
        function saveProduct(product) {
            const transaction = db.transaction([STORE_NAMES.INVENTORY], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.INVENTORY);
            store.put(product);
        }
        
        // ذخیره فاکتور در IndexedDB
        function saveInvoiceToDB(invoice) {
            const transaction = db.transaction([STORE_NAMES.INVOICES], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.INVOICES);
            store.put(invoice);
        }
        
        // ذخیره شمارنده فاکتورها در IndexedDB
        function saveInvoiceCounter() {
            const transaction = db.transaction([STORE_NAMES.INVOICE_COUNTER], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.INVOICE_COUNTER);
            store.put({ id: 1, value: invoiceCounter });
        }
        
        // ذخیره دوره مالی در IndexedDB
        function saveFiscalPeriodToDB() {
            const transaction = db.transaction([STORE_NAMES.FISCAL_PERIOD], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.FISCAL_PERIOD);
            store.put({ id: 1, ...fiscalPeriod });
        }
        
        // ذخیره تنظیمات در IndexedDB
        function saveSettingsToDB() {
            const transaction = db.transaction([STORE_NAMES.SETTINGS], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.SETTINGS);
            store.put({ id: 1, ...settings });
        }
        
        // ذخیره اطلاعات شرکت در IndexedDB
        function saveCompanyInfoToDB() {
            const transaction = db.transaction([STORE_NAMES.COMPANY_INFO], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.COMPANY_INFO);
            store.put({ id: 1, ...companyInfo });
        }
        
        // ذخیره سند در IndexedDB
        function saveDocumentToDB(document) {
            const transaction = db.transaction([STORE_NAMES.DOCUMENTS], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.DOCUMENTS);
            store.put(document);
        }
        
        // ذخیره شمارنده اسناد در IndexedDB
        function saveDocumentCounter() {
            const transaction = db.transaction([STORE_NAMES.DOCUMENT_COUNTER], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.DOCUMENT_COUNTER);
            store.put({ id: 1, value: documentCounter });
        }
        
        // ذخیره حساب در IndexedDB
        function saveAccount(account) {
            const transaction = db.transaction([STORE_NAMES.ACCOUNTS], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.ACCOUNTS);
            store.put(account);
        }
        
        // حذف طرف حساب از IndexedDB
        function deletePartyFromDB(partyId) {
            const transaction = db.transaction([STORE_NAMES.PARTIES], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.PARTIES);
            store.delete(partyId);
        }
        
        // حذف کالا از IndexedDB
        function deleteProductFromDB(productId) {
            const transaction = db.transaction([STORE_NAMES.INVENTORY], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.INVENTORY);
            store.delete(productId);
        }
        
        // حذف فاکتور از IndexedDB
        function deleteInvoiceFromDB(invoiceId) {
            const transaction = db.transaction([STORE_NAMES.INVOICES], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.INVOICES);
            store.delete(invoiceId);
        }
        
        // حذف سند از IndexedDB
        function deleteDocumentFromDB(documentId) {
            const transaction = db.transaction([STORE_NAMES.DOCUMENTS], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.DOCUMENTS);
            store.delete(documentId);
        }
        
        // تابع تبدیل مبلغ به عدد
        function parseAmount(amountText) {
            let cleaned = amountText.replace(/[^\d.,]/g, '');
            cleaned = cleaned.replace(/,/g, '');
            return parseFloat(cleaned) || 0;
        }
        
        // تابع دریافت تاریخ امروز به صورت شمسی
        function getTodayPersianDate() {
            const today = new Date();
            return today.toLocaleDateString('fa-IR');
        }
        
        // تابع تبدیل اعداد به فارسی
        function toPersianNumbers(number) {
            const persianDigits = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            return number.toString().replace(/\d/g, digit => persianDigits[parseInt(digit)]);
        }
        
        // تابع به‌روزرسانی عنوان صفحه
        function updatePageTitle(tabId) {
            const titles = {
                'dashboard': { title: 'داشبورد مدیریتی', description: 'نمایش کلی وضعیت مالی و مدیریت سیستم' },
                'parties': { title: 'مدیریت اشخاص', description: 'در این بخش می‌توانید اشخاص و مشتریان خود را مدیریت کنید' },
                'products': { title: 'مدیریت کالا/خدمات', description: 'در این بخش می‌توانید کالاها و خدمات خود را مدیریت کنید' },
                'accounts': { title: 'جداول حساب', description: 'در این بخش می‌توانید ساختار حساب‌های مالی خود را مشاهده کنید' },
                'invoice': { title: 'فاکتور فروش/خدمات', description: 'در این بخش می‌توانید فاکتور صادر کنید' },
                'register': { title: 'ثبت سند حسابداری', description: 'در این بخش می‌توانید اسناد حسابداری ثبت کنید' },
                'documents': { title: 'مدیریت اسناد و فاکتورها', description: 'در این بخش می‌توانید اسناد و فاکتورهای ثبت شده را مشاهده و مدیریت کنید' }
            };
            
            const titleInfo = titles[tabId];
            pageTitle.innerHTML = `<i class="fas fa-${getTabIcon(tabId)}"></i> ${titleInfo.title}`;
            pageDescription.textContent = titleInfo.description;
        }
        
        // تابع دریافت آیکون مربوط به تب
        function getTabIcon(tabId) {
            const icons = {
                'dashboard': 'user', 'parties': 'users', 'products': 'cubes', 
                'accounts': 'table', 'invoice': 'receipt', 'register': 'file-invoice', 'documents': 'archive'
            };
            return icons[tabId];
        }
        
        // تابع فرمت ارز به فارسی
        function formatCurrency(amount) {
            const formatted = amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return toPersianNumbers(formatted);
        }
        
        // تابع نمایش نوتیفیکیشن
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.style.cssText = `position: fixed; top: 30px; left: 30px; right: 30px; background: ${type === 'success' ? 'var(--success)' : 'var(--danger)'}; color: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 1000; display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 1rem;`;
            notification.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i> ${message}`;
            document.body.appendChild(notification);
            setTimeout(() => { document.body.removeChild(notification); }, 3000);
        }
        
        // تابع به‌روزرسانی لیست طرف‌های حساب
        function updatePartiesList() {
            if (parties.length === 0) {
                partiesList.innerHTML = `<div class="empty-state"><i class="fas fa-users"></i><p>هیچ شخصی ثبت نشده است</p></div>`;
                return;
            }
            
            let html = '';
            parties.forEach(party => {
                html += `<div class="party-item" data-id="${party.id}">
                    <div class="party-info">
                        <div class="party-title">${party.name} (${party.type === 'legal' ? 'حقوقی' : 'حقیقی'})</div>
                        <div class="party-meta">
                            <div class="party-meta-item"><i class="fas fa-hashtag"></i><span>کد اقتصادی: ${party.economicCode || '---'}</span></div>
                            <div class="party-meta-item"><i class="fas fa-id-card"></i><span>شناسه ملی: ${party.nationalId || '---'}</span></div>
                            <div class="party-meta-item"><i class="fas fa-phone"></i><span>تلفن: ${party.phone || '---'}</span></div>
                            <div class="party-meta-item"><i class="fas fa-mobile-alt"></i><span>شماره تماس: ${party.mobile || '---'}</span></div>
                        </div>
                    </div>
                    <div class="party-actions">
                        <button class="simple-btn simple-btn-info" onclick="editParty(${party.id})"><i class="fas fa-edit"></i> ویرایش</button>
                        <button class="simple-btn simple-btn-danger" onclick="deleteParty(${party.id})"><i class="fas fa-trash"></i> حذف</button>
                    </div>
                </div>`;
            });
            partiesList.innerHTML = html;
        }
        
        // تابع به‌روزرسانی اطلاعات شرکت
        function updateCompanyInfo() {
            companyTypeSelect.value = companyInfo.type || 'legal';
            companyNameInput.value = companyInfo.name || '';
            companyEconomicCodeInput.value = companyInfo.economicCode || '';
            companyNationalIdInput.value = companyInfo.nationalId || '';
            companyRegistrationNumberInput.value = companyInfo.registrationNumber || '';
            companyPhoneInput.value = companyInfo.phone || '';
            companyMobileInput.value = companyInfo.mobile || '';
            companyPostalCodeInput.value = companyInfo.postalCode || '';
            companyAddressInput.value = companyInfo.address || '';
        }
        
        // تابع به‌روزرسانی لیست کالاها
        function updateInventoryList() {
            if (inventory.length === 0) {
                inventoryList.innerHTML = `<div class="empty-state"><i class="fas fa-cubes"></i><p>هیچ کالا/خدماتی ثبت نشده است</p></div>`;
                return;
            }
            
            let html = '';
            inventory.forEach(product => {
                html += `<div class="inventory-item">
                    <div class="inventory-info">
                        <div class="inventory-title">${product.name}</div>
                        <div class="inventory-meta">
                            <div class="inventory-meta-item"><i class="fas fa-barcode"></i><span>کد: ${product.code || '---'}</span></div>
                            <div class="inventory-meta-item"><i class="fas fa-money-bill-wave"></i><span>بهای واحد: ${formatCurrency(product.price)}</span></div>
                            <div class="inventory-meta-item"><i class="fas fa-ruler"></i><span>واحد: ${product.unit || 'عدد'}</span></div>
                        </div>
                    </div>
                    <div class="inventory-actions">
                        <button class="simple-btn simple-btn-info" onclick="editProduct(${product.id})"><i class="fas fa-edit"></i> ویرایش</button>
                        <button class="simple-btn simple-btn-danger" onclick="deleteProduct(${product.id})"><i class="fas fa-trash"></i> حذف</button>
                    </div>
                </div>`;
            });
            inventoryList.innerHTML = html;
        }
        
        // تابع به‌روزرسانی dropdown طرف‌های حساب در فاکتور
        function updateInvoicePartySelect() {
            let html = '<option value="">انتخاب کنید</option>';
            parties.forEach(party => html += `<option value="${party.id}">${party.name} (${party.type === 'legal' ? 'حقوقی' : 'حقیقی'})</option>`);
            invoicePartySelect.innerHTML = html;
        }
        
        // تابع به‌روزرسانی dropdown کالاها در فاکتور
        function updateInvoiceProductSelect() {
            let html = '<option value="">انتخاب کنید</option>';
            inventory.forEach(product => {
                html += `<option value="${product.id}" data-code="${product.code}" data-name="${product.name}" data-price="${product.price}" data-unit="${product.unit || 'عدد'}">${product.code || '---'} - ${product.name}</option>`;
            });
            invoiceProductSelect.innerHTML = html;
        }
        
        // تابع به‌روزرسانی dropdown حساب‌های معین در تب ثبت
        function updateSubsidiaryAccounts() {
            // این تابع در هنگام افزودن ردیف سند فراخوانی می‌شود
        }
        
        // تابع افزودن طرف حساب
        function addParty() {
            const name = partyNameInput.value.trim();
            const economicCode = partyEconomicCodeInput.value.trim();
            const nationalId = partyNationalIdInput.value.trim();
            const registrationNumber = partyRegistrationNumberInput.value.trim();
            const phone = partyPhoneInput.value.trim();
            const mobile = partyMobileInput.value.trim();
            const postalCode = partyPostalCodeInput.value.trim();
            const address = partyAddressInput.value.trim();
            const type = partyTypeSelect.value;
            
            if (!name) {
                showNotification('لطفاً نام شخص/شرکت را وارد کنید!', 'error');
                return;
            }
            
            const newParty = {
                id: Date.now(), 
                type: type, 
                name: name, 
                economicCode: economicCode,
                nationalId: nationalId,
                registrationNumber: registrationNumber,
                phone: phone, 
                mobile: mobile,
                postalCode: postalCode,
                address: address
            };
            
            parties.push(newParty);
            saveParty(newParty);
            updatePartiesList();
            updateInvoicePartySelect();
            partyNameInput.value = '';
            partyEconomicCodeInput.value = '';
            partyNationalIdInput.value = '';
            partyRegistrationNumberInput.value = '';
            partyPhoneInput.value = '';
            partyMobileInput.value = '';
            partyPostalCodeInput.value = '';
            partyAddressInput.value = '';
            partyTypeSelect.value = 'legal';
            showNotification('شخص جدید با موفقیت افزوده شد!', 'success');
        }
        
        // تابع ویرایش طرف حساب
        function editParty(partyId) {
            const party = parties.find(p => p.id === partyId);
            if (!party) {
                showNotification('شخص مورد نظر یافت نشد!', 'error');
                return;
            }
            
            // نمایش فرم ویرایش
            editPartyTypeSelect.value = party.type;
            editPartyNameInput.value = party.name;
            editPartyEconomicCodeInput.value = party.economicCode || '';
            editPartyNationalIdInput.value = party.nationalId || '';
            editPartyRegistrationNumberInput.value = party.registrationNumber || '';
            editPartyPhoneInput.value = party.phone || '';
            editPartyMobileInput.value = party.mobile || '';
            editPartyPostalCodeInput.value = party.postalCode || '';
            editPartyAddressInput.value = party.address || '';
            
            // تنظیم ID ویرایش
            editingPartyId = partyId;
            
            // نمایش فرم ویرایش
            editPartyForm.classList.remove('hidden');
            
            showNotification('اطلاعات شخص برای ویرایش بارگذاری شد!', 'info');
        }
        
        // تابع به‌روزرسانی طرف حساب
        function updateParty() {
            if (!editingPartyId) return;
            
            const name = editPartyNameInput.value.trim();
            const economicCode = editPartyEconomicCodeInput.value.trim();
            const nationalId = editPartyNationalIdInput.value.trim();
            const registrationNumber = editPartyRegistrationNumberInput.value.trim();
            const phone = editPartyPhoneInput.value.trim();
            const mobile = editPartyMobileInput.value.trim();
            const postalCode = editPartyPostalCodeInput.value.trim();
            const address = editPartyAddressInput.value.trim();
            const type = editPartyTypeSelect.value;
            
            if (!name) {
                showNotification('لطفاً نام شخص/شرکت را وارد کنید!', 'error');
                return;
            }
            
            const updatedParty = {
                id: editingPartyId, 
                type: type, 
                name: name, 
                economicCode: economicCode,
                nationalId: nationalId,
                registrationNumber: registrationNumber,
                phone: phone, 
                mobile: mobile,
                postalCode: postalCode,
                address: address
            };
            
            const index = parties.findIndex(p => p.id === editingPartyId);
            if (index !== -1) {
                parties[index] = updatedParty;
                saveParty(updatedParty);
                updatePartiesList();
                updateInvoicePartySelect();
                
                // پنهان کردن فرم ویرایش
                editPartyForm.classList.add('hidden');
                editingPartyId = null;
                
                showNotification('اطلاعات شخص با موفقیت به‌روزرسانی شد!', 'success');
            }
        }
        
        // تابع انصراف از ویرایش شخص
        function cancelEditParty() {
            editPartyForm.classList.add('hidden');
            editingPartyId = null;
            showNotification('ویرایش لغو شد!', 'info');
        }
        
        // تابع حذف طرف حساب
        function deleteParty(partyId) {
            if (confirm('آیا از حذف این شخص اطمینان دارید؟')) {
                parties = parties.filter(party => party.id !== partyId);
                deletePartyFromDB(partyId);
                updatePartiesList();
                updateInvoicePartySelect();
                showNotification('شخص با موفقیت حذف شد!', 'success');
            }
        }
        
        // تابع ذخیره اطلاعات شرکت
        function saveCompanyInfo() {
            const name = companyNameInput.value.trim();
            const economicCode = companyEconomicCodeInput.value.trim();
            const nationalId = companyNationalIdInput.value.trim();
            const registrationNumber = companyRegistrationNumberInput.value.trim();
            const phone = companyPhoneInput.value.trim();
            const mobile = companyMobileInput.value.trim();
            const postalCode = companyPostalCodeInput.value.trim();
            const address = companyAddressInput.value.trim();
            const type = companyTypeSelect.value;
            
            companyInfo = {
                type: type, 
                name: name, 
                economicCode: economicCode,
                nationalId: nationalId,
                registrationNumber: registrationNumber,
                phone: phone, 
                mobile: mobile,
                postalCode: postalCode,
                address: address
            };
            
            saveCompanyInfoToDB();
            showNotification('اطلاعات شرکت با موفقیت ذخیره شد!', 'success');
        }
        
        // تابع افزودن کالا
        function addProduct() {
            const code = productCodeInput.value.trim();
            const name = productNameInput.value.trim();
            const price = parseAmount(productPriceInput.value) || 0;
            const unit = productUnitInput.value.trim() || 'عدد';
            
            if (!name) {
                showNotification('لطفاً شرح کالا/خدمات را وارد کنید!', 'error');
                return;
            }
            
            if (price <= 0) {
                showNotification('لطفاً بهای واحد کالا/خدمات را وارد کنید!', 'error');
                return;
            }
            
            const newProduct = { id: Date.now(), code: code, name: name, price: price, unit: unit };
            inventory.push(newProduct);
            saveProduct(newProduct);
            updateInventoryList();
            updateInvoiceProductSelect();
            productCodeInput.value = '';
            productNameInput.value = '';
            productPriceInput.value = '';
            productUnitInput.value = '';
            showNotification('کالا/خدمات جدید با موفقیت افزوده شد!', 'success');
        }
        
        // تابع ویرایش کالا
        function editProduct(productId) {
            const product = inventory.find(p => p.id === productId);
            if (!product) {
                showNotification('کالا/خدمات مورد نظر یافت نشد!', 'error');
                return;
            }
            
            // نمایش فرم ویرایش
            editProductCodeInput.value = product.code || '';
            editProductNameInput.value = product.name;
            editProductPriceInput.value = product.price;
            editProductUnitInput.value = product.unit || '';
            
            // تنظیم ID ویرایش
            editingProductId = productId;
            
            // نمایش فرم ویرایش
            editProductForm.classList.remove('hidden');
            
            showNotification('اطلاعات کالا/خدمات برای ویرایش بارگذاری شد!', 'info');
        }
        
        // تابع به‌روزرسانی کالا
        function updateProduct() {
            if (!editingProductId) return;
            
            const code = editProductCodeInput.value.trim();
            const name = editProductNameInput.value.trim();
            const price = parseAmount(editProductPriceInput.value) || 0;
            const unit = editProductUnitInput.value.trim() || 'عدد';
            
            if (!name) {
                showNotification('لطفاً شرح کالا/خدمات را وارد کنید!', 'error');
                return;
            }
            
            if (price <= 0) {
                showNotification('لطفاً بهای واحد کالا/خدمات را وارد کنید!', 'error');
                return;
            }
            
            const updatedProduct = { id: editingProductId, code: code, name: name, price: price, unit: unit };
            
            const index = inventory.findIndex(p => p.id === editingProductId);
            if (index !== -1) {
                inventory[index] = updatedProduct;
                saveProduct(updatedProduct);
                updateInventoryList();
                updateInvoiceProductSelect();
                
                // پنهان کردن فرم ویرایش
                editProductForm.classList.add('hidden');
                editingProductId = null;
                
                showNotification('اطلاعات کالا/خدمات با موفقیت به‌روزرسانی شد!', 'success');
            }
        }
        
        // تابع انصراف از ویرایش کالا
        function cancelEditProduct() {
            editProductForm.classList.add('hidden');
            editingProductId = null;
            showNotification('ویرایش لغو شد!', 'info');
        }
        
        // تابع حذف کالا
        function deleteProduct(productId) {
            if (confirm('آیا از حذف این کالا/خدمات اطمینان دارید؟')) {
                inventory = inventory.filter(product => product.id !== productId);
                deleteProductFromDB(productId);
                updateInventoryList();
                updateInvoiceProductSelect();
                showNotification('کالا/خدمات با موفقیت حذف شد!', 'success');
            }
        }
        
        // تابع افزودن ردیف فاکتور
        function addInvoiceItem() {
            const productId = invoiceProductSelect.value;
            const quantity = parseAmount(invoiceQuantityInput.value) || 0;
            const discountPercent = parseAmount(invoiceItemDiscountInput.value) || 0;
            const taxPercent = parseAmount(invoiceItemTaxInput.value) || 0;
            
            if (!productId || quantity <= 0) {
                showNotification('لطفاً کالا/خدمات و مقدار را وارد کنید!', 'error');
                return;
            }
            
            const product = inventory.find(p => p.id == productId);
            if (!product) {
                showNotification('کالا/خدمات انتخاب شده معتبر نیست!', 'error');
                return;
            }
            
            const unitPrice = product.price;
            const totalPrice = quantity * unitPrice;
            const discountAmount = totalPrice * (discountPercent / 100);
            const taxAmount = (totalPrice - discountAmount) * (taxPercent / 100);
            const finalPrice = totalPrice - discountAmount + taxAmount;
            
            const invoiceItem = {
                id: Date.now(), productId: productId, productCode: product.code,
                productName: product.name, quantity: quantity, unitPrice: unitPrice, 
                totalPrice: totalPrice, discountPercent: discountPercent, discountAmount: discountAmount,
                taxPercent: taxPercent, taxAmount: taxAmount, finalPrice: finalPrice, unit: product.unit || 'عدد'
            };
            
            invoiceItems.push(invoiceItem);
            updateInvoiceItemsDisplay();
            invoiceProductSelect.value = '';
            invoiceQuantityInput.value = '';
            invoiceItemDiscountInput.value = '';
            invoiceItemTaxInput.value = '';
            generateConnectedInvoicePreview();
        }
        
        // تابع به‌روزرسانی نمایش اقلام فاکتور
        function updateInvoiceItemsDisplay() {
            if (invoiceItems.length === 0) {
                invoiceItemsContainer.innerHTML = `<div class="empty-state"><i class="fas fa-receipt"></i><p>هیچ موردی به فاکتور اضافه نشده است</p></div>`;
                return;
            }
            
            let html = '';
            invoiceItems.forEach((item, index) => {
                html += `<div class="invoice-item-display"><div class="invoice-item-info"><div class="invoice-item-name">${item.productName}</div><div class="invoice-item-details"><span>کد کالا/خدمات: ${item.productCode || '---'}</span><span>مقدار: ${toPersianNumbers(item.quantity)}</span><span>بهای واحد: ${formatCurrency(item.unitPrice)}</span><span>بهای کل: ${formatCurrency(item.totalPrice)}</span><span>تخفیف: ${toPersianNumbers(item.discountPercent)}%</span><span>مالیات: ${toPersianNumbers(item.taxPercent)}%</span><span>قیمت نهایی: ${formatCurrency(item.finalPrice)}</span></div></div><div class="invoice-item-actions"><button class="simple-btn simple-btn-danger" onclick="removeInvoiceItem(${index})"><i class="fas fa-trash"></i> حذف</button></div></div>`;
            });
            invoiceItemsContainer.innerHTML = html;
        }
        
        // تابع حذف ردیف فاکتور
        function removeInvoiceItem(index) {
            invoiceItems.splice(index, 1);
            updateInvoiceItemsDisplay();
            generateConnectedInvoicePreview();
        }
        
        // تابع تولید پیش‌نمایش فاکتور متصل
        function generateConnectedInvoicePreview() {
            const date = invoiceDateInput.value;
            const partyId = invoicePartySelect.value;
            
            if (!date || !partyId || invoiceItems.length === 0) {
                invoiceConnectedPreview.innerHTML = `<div class="empty-state"><i class="fas fa-receipt"></i><p>پس از پر کردن فرم، پیش‌نمایش فاکتور در اینجا نمایش داده می‌شود</p></div>`;
                return;
            }
            
            const party = parties.find(p => p.id == partyId);
            if (!party) {
                showNotification('طرف حساب انتخاب شده معتبر نیست!', 'error');
                return;
            }
            
            let subtotal = 0;
            let totalDiscount = 0;
            let totalTax = 0;
            let grandTotal = 0;
            
            invoiceItems.forEach(item => {
                subtotal += item.totalPrice;
                totalDiscount += item.discountAmount;
                totalTax += item.taxAmount;
                grandTotal += item.finalPrice;
            });
            
            const paymentMethod = document.querySelector('input[name="payment-method"]:checked');
            const paymentMethodText = paymentMethod ? (paymentMethod.value === 'cash' ? 'نقدی' : 'غیر نقدی') : '';
            
            let itemsHtml = '';
            invoiceItems.forEach((item, index) => {
                itemsHtml += `<tr><td>${index + 1}</td><td>${item.productCode || '---'}</td><td>${item.productName}</td><td>${toPersianNumbers(item.quantity)}</td><td>${item.unit}</td><td>${formatCurrency(item.unitPrice)}</td><td>${formatCurrency(item.totalPrice)}</td><td>${formatCurrency(item.discountAmount)}</td><td>${formatCurrency(item.totalPrice - item.discountAmount)}</td><td>${formatCurrency(item.taxAmount)}</td><td>${formatCurrency(item.finalPrice)}</td></tr>`;
            });
            
            // اضافه کردن مشخصات فروشنده و خریدار (بدون کادر)
            let sellerDetails = '';
            let buyerDetails = '';
            
            if (companyInfo.name) {
                sellerDetails = `
                    <div class="invoice-connected-info-row"><div class="invoice-connected-info-label">نام:</div><div class="invoice-connected-info-value">${companyInfo.name}</div></div>
                    ${companyInfo.economicCode ? `<div class="invoice-connected-info-row"><div class="invoice-connected-info-label">کد اقتصادی:</div><div class="invoice-connected-info-value">${companyInfo.economicCode}</div></div>` : ''}
                    ${companyInfo.nationalId ? `<div class="invoice-connected-info-row"><div class="invoice-connected-info-label">شناسه ملی:</div><div class="invoice-connected-info-value">${companyInfo.nationalId}</div></div>` : ''}
                    ${companyInfo.registrationNumber ? `<div class="invoice-connected-info-row"><div class="invoice-connected-info-label">شماره ثبت:</div><div class="invoice-connected-info-value">${companyInfo.registrationNumber}</div></div>` : ''}
                    ${companyInfo.phone ? `<div class="invoice-connected-info-row"><div class="invoice-connected-info-label">تلفن:</div><div class="invoice-connected-info-value">${companyInfo.phone}</div></div>` : ''}
                `;
            }
            
            if (party) {
                buyerDetails = `
                    <div class="invoice-connected-info-row"><div class="invoice-connected-info-label">نام:</div><div class="invoice-connected-info-value">${party.name}</div></div>
                    ${party.economicCode ? `<div class="invoice-connected-info-row"><div class="invoice-connected-info-label">کد اقتصادی:</div><div class="invoice-connected-info-value">${party.economicCode}</div></div>` : ''}
                    ${party.nationalId ? `<div class="invoice-connected-info-row"><div class="invoice-connected-info-label">شناسه ملی:</div><div class="invoice-connected-info-value">${party.nationalId}</div></div>` : ''}
                    ${party.registrationNumber ? `<div class="invoice-connected-info-row"><div class="invoice-connected-info-label">شماره ثبت:</div><div class="invoice-connected-info-value">${party.registrationNumber}</div></div>` : ''}
                    ${party.phone ? `<div class="invoice-connected-info-row"><div class="invoice-connected-info-label">تلفن:</div><div class="invoice-connected-info-value">${party.phone}</div></div>` : ''}
                `;
            }
            
            let html = `
                <div class="invoice-connected-container">
                    <div class="invoice-connected-header">
                        <div class="invoice-connected-title">فاکتور فروش/خدمات</div>
                        <div class="invoice-connected-number">شماره فاکتور: ${toPersianNumbers(invoiceCounter)}</div>
                        <div class="invoice-connected-date">تاریخ: ${date}</div>
                    </div>
                    <div class="invoice-connected-details">
                        <div class="invoice-connected-seller">
                            <div class="invoice-connected-section-title">فروشنده</div>
                            ${sellerDetails}
                        </div>
                        <div class="invoice-connected-buyer">
                            <div class="invoice-connected-section-title">خریدار</div>
                            ${buyerDetails}
                        </div>
                    </div>
                    <table class="invoice-connected-table">
                        <thead>
                            <tr>
                                <th>ردیف</th>
                                <th>کد کالا</th>
                                <th>شرح کالا/خدمات</th>
                                <th>مقدار</th>
                                <th>واحد</th>
                                <th>بهای واحد</th>
                                <th>بهای کل</th>
                                <th>مبلغ تخفیف</th>
                                <th>بهای کل پس از تخفیف</th>
                                <th>مالیات و عوارض</th>
                                <th>بهای کل بعلاوه مالیات و عوارض</th>
                            </tr>
                        </thead>
                        <tbody>${itemsHtml}</tbody>
                    </table>
                    <div class="invoice-connected-summary">
                        <div class="invoice-connected-summary-row">
                            <div class="invoice-connected-summary-label invoice-summary-small-font">جمع تمامی ستون ها به عدد:</div>
                            <div class="invoice-connected-summary-value invoice-summary-small-font">${formatCurrency(grandTotal)} ریال</div>
                        </div>
                        <div class="invoice-connected-summary-row">
                            <div class="invoice-connected-summary-label invoice-summary-small-font">جمع تمامی ستون ها به حروف:</div>
                            <div class="invoice-connected-summary-value invoice-summary-small-font">${numberToWords(grandTotal)} ریال</div>
                        </div>
                        <div class="invoice-connected-summary-row">
                            <div class="invoice-connected-summary-label invoice-summary-small-font">نحوه پرداخت:</div>
                            <div class="invoice-connected-summary-value invoice-summary-small-font">
                                <span>نقدی ${paymentMethodText === 'نقدی' ? '☑' : '☐'}</span>
                                <span style="margin-right: 20px;">غیر نقدی ${paymentMethodText === 'غیر نقدی' ? '☑' : '☐'}</span>
                            </div>
                        </div>
                    </div>
                    <div class="invoice-connected-signatures">
                        <div class="invoice-connected-signature">
                            <div>مهر و امضای فروشنده</div>
                            <div class="invoice-connected-signature-line"></div>
                        </div>
                        <div class="invoice-connected-signature">
                            <div>مهر و امضای خریدار</div>
                            <div class="invoice-connected-signature-line"></div>
                        </div>
                    </div>
                </div>
            `;
            invoiceConnectedPreview.innerHTML = html;
        }
        
        // تابع تبدیل عدد به حروف
        function numberToWords(number) {
            const units = ['', 'یک', 'دو', 'سه', 'چهار', 'پنج', 'شش', 'هفت', 'هشت', 'نه'];
            const teens = ['ده', 'یازده', 'دوازده', 'سیزده', 'چهارده', 'پانزده', 'شانزده', 'هفده', 'هجده', 'نوزده'];
            const tens = ['', '', 'بیست', 'سی', 'چهل', 'پنجاه', 'شصت', 'هفتاد', 'هشتاد', 'نود'];
            const hundreds = ['', 'صد', 'دویست', 'سیصد', 'چهارصد', 'پانصد', 'ششصد', 'هفتصد', 'هشتصد', 'نهصد'];
            
            if (number === 0) return 'صفر';
            let words = '';
            
            if (number >= 1000000000) {
                words += numberToWords(Math.floor(number / 1000000000)) + ' میلیارد و ';
                number %= 1000000000;
            }
            
            if (number >= 1000000) {
                words += numberToWords(Math.floor(number / 1000000)) + ' میلیون و ';
                number %= 1000000;
            }
            
            if (number >= 1000) {
                words += numberToWords(Math.floor(number / 1000)) + ' هزار و ';
                number %= 1000;
            }
            
            if (number >= 100) {
                words += hundreds[Math.floor(number / 100)] + ' و ';
                number %= 100;
            }
            
            if (number >= 20) {
                words += tens[Math.floor(number / 10)] + ' و ';
                number %= 10;
            } else if (number >= 10) {
                words += teens[number - 10] + ' و ';
                number = 0;
            }
            
            if (number > 0) words += units[number] + ' و ';
            if (words.endsWith(' و ')) words = words.slice(0, -3);
            return words || 'صفر';
        }
        
        // تابع ذخیره فاکتور
        function saveInvoice() {
            const date = invoiceDateInput.value;
            const partyId = invoicePartySelect.value;
            
            if (!date || !partyId || invoiceItems.length === 0) {
                showNotification('لطفاً تمام فیلدهای ضروری را پر کنید و حداقل یک ردیف به فاکتور اضافه کنید!', 'error');
                return;
            }
            
            const party = parties.find(p => p.id == partyId);
            if (!party) {
                showNotification('طرف حساب انتخاب شده معتبر نیست!', 'error');
                return;
            }
            
            const paymentMethod = document.querySelector('input[name="payment-method"]:checked');
            if (!paymentMethod) {
                showNotification('لطفاً نحوه پرداخت را انتخاب کنید!', 'error');
                return;
            }
            
            let subtotal = 0;
            let totalDiscount = 0;
            let totalTax = 0;
            let grandTotal = 0;
            
            invoiceItems.forEach(item => {
                subtotal += item.totalPrice;
                totalDiscount += item.discountAmount;
                totalTax += item.taxAmount;
                grandTotal += item.finalPrice;
            });
            
            const newInvoice = {
                id: Date.now(), number: invoiceCounter++, date: date, partyId: partyId, partyName: party.name,
                partyType: party.type, partyEconomicCode: party.economicCode, partyNationalId: party.nationalId,
                partyRegistrationNumber: party.registrationNumber,
                partyPhone: party.phone, partyMobile: party.mobile, partyAddress: party.address,
                partyPostalCode: party.postalCode, items: [...invoiceItems], subtotal: subtotal,
                totalDiscount: totalDiscount, totalTax: totalTax, grandTotal: grandTotal, paymentMethod: paymentMethod.value
            };
            
            savedInvoices.push(newInvoice);
            saveInvoiceToDB(newInvoice);
            saveInvoiceCounter();
            showNotification('فاکتور با موفقیت ذخیره شد!', 'success');
            resetInvoice();
            updateInvoicesList();
        }
        
        // تابع چاپ فاکتور
        function printInvoice() {
            const invoiceContent = invoiceConnectedPreview.innerHTML;
            if (invoiceContent.includes('empty-state')) {
                showNotification('هیچ فاکتوری برای چاپ وجود ندارد!', 'error');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`<!DOCTYPE html><html dir="rtl"><head><title>چاپ فاکتور</title><style>body{font-family:'Vazirmatn','Vazir',Tahoma,sans-serif;direction:rtl;margin:20px;line-height:1.6}.invoice-connected-container{border:1px solid #000;padding:20px}.invoice-connected-header{text-align:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #000}.invoice-connected-title{font-size:1.5rem;font-weight:bold}.invoice-connected-table{width:100%;border-collapse:collapse;margin:0;font-size:0.7rem}.invoice-connected-table th,.invoice-connected-table td{border:1px solid #000;padding:6px;text-align:center}.invoice-connected-table th{background-color:#f0f0f0}.invoice-connected-summary{margin-top:0;background:rgba(0,0,0,0.05);border-radius:0 0 10px 10px;padding:15px;border:1px solid #000;border-top:none}.invoice-connected-summary-row{display:flex;justify-content:space-between;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid #000}.invoice-connected-summary-row:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}.invoice-connected-summary-label{font-weight:600;font-size:0.65rem}.invoice-connected-summary-value{font-weight:700;font-size:0.65rem}.invoice-connected-signatures{display:flex;justify-content:space-between;margin-top:40px}.invoice-connected-signature-line{border-top:1px solid #000;margin-top:40px;padding-top:5px}.invoice-connected-details{display:flex;justify-content:space-between;margin-bottom:0}.invoice-connected-seller,.invoice-connected-buyer{flex:1;padding:15px}.invoice-connected-seller{margin-left:0;border-bottom:none;border-radius:0 0 0 0}.invoice-connected-buyer{margin-right:0;border-bottom:none;border-radius:0 0 0 0}.invoice-connected-info-row{display:flex;margin-bottom:5px}.invoice-connected-info-label{font-weight:600;width:120px;font-size:0.7rem}.invoice-connected-info-value{flex:1;font-size:0.7rem}@media print{body{margin:0}.invoice-connected-container{border:none}}</style></head><body>${invoiceContent}</body></html>`);
            printWindow.document.close();
            printWindow.print();
        }
        
        // تابع بازگشت فاکتور
        function resetInvoice() {
            invoiceDateInput.value = getTodayPersianDate();
            invoicePartySelect.value = '';
            invoiceProductSelect.value = '';
            invoiceQuantityInput.value = '';
            invoiceItemDiscountInput.value = '';
            invoiceItemTaxInput.value = '';
            invoiceItems = [];
            updateInvoiceItemsDisplay();
            invoiceConnectedPreview.innerHTML = `<div class="empty-state"><i class="fas fa-receipt"></i><p>پس از پر کردن فرم، پیش‌نمایش فاکتور در اینجا نمایش داده می‌شود</p></div>`;
        }
        
        // تابع افزودن ردیف به سند حسابداری
        function addEntryRow() {
            const rowId = Date.now();
            const subsidiaries = accounts.filter(account => account.level === 'subsidiary');
            
            let subsidiaryOptions = '<option value="">انتخاب کنید</option>';
            subsidiaries.forEach(subsidiary => {
                subsidiaryOptions += `<option value="${subsidiary.id}">${subsidiary.code} - ${subsidiary.name}</option>`;
            });
            
            const rowHtml = `
                <tr id="entry-row-${rowId}">
                    <td>${documentEntries.length + 1}</td>
                    <td>
                        <select class="form-control entry-subsidiary" onchange="updateEntryRowDetails(${rowId})">
                            ${subsidiaryOptions}
                        </select>
                    </td>
                    <td>
                        <select class="form-control entry-detail" id="entry-detail-${rowId}">
                            <option value="">انتخاب کنید</option>
                        </select>
                    </td>
                    <td><input type="text" class="form-control entry-description" placeholder="شرح"></td>
                    <td><input type="text" class="form-control entry-debit" placeholder="0" oninput="calculateEntryTotals()"></td>
                    <td><input type="text" class="form-control entry-credit" placeholder="0" oninput="calculateEntryTotals()"></td>
                    <td class="entry-row-actions">
                        <button class="simple-btn simple-btn-danger" onclick="removeEntryRow(${rowId})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
            
            entryTableBody.innerHTML += rowHtml;
            documentEntries.push({
                id: rowId,
                subsidiaryId: null,
                detailId: null,
                description: '',
                debit: 0,
                credit: 0
            });
        }
        
        // تابع به‌روزرسانی جزئیات ردیف سند
        function updateEntryRowDetails(rowId) {
            const rowIndex = documentEntries.findIndex(entry => entry.id === rowId);
            if (rowIndex === -1) return;
            
            const select = document.querySelector(`#entry-row-${rowId} .entry-subsidiary`);
            const subsidiaryId = select.value;
            const subsidiary = accounts.find(acc => acc.id == subsidiaryId);
            
            if (!subsidiary) return;
            
            // به‌روزرسانی اطلاعات ردیف
            documentEntries[rowIndex].subsidiaryId = subsidiaryId;
            
            // پیدا کردن تفضیل‌های مربوط به این معین
            const details = accounts.filter(account => account.parentId == subsidiaryId && account.level === 'detail');
            
            const detailSelect = document.querySelector(`#entry-detail-${rowId}`);
            let detailOptions = '<option value="">انتخاب کنید</option>';
            details.forEach(detail => {
                detailOptions += `<option value="${detail.id}">${detail.code} - ${detail.name}</option>`;
            });
            
            detailSelect.innerHTML = detailOptions;
        }
        
        // تابع حذف ردیف سند
        function removeEntryRow(rowId) {
            const rowIndex = documentEntries.findIndex(entry => entry.id === rowId);
            if (rowIndex !== -1) {
                documentEntries.splice(rowIndex, 1);
                document.querySelector(`#entry-row-${rowId}`).remove();
                updateEntryRowNumbers();
                calculateEntryTotals();
            }
        }
        
        // تابع به‌روزرسانی شماره ردیف‌ها
        function updateEntryRowNumbers() {
            const rows = entryTableBody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                row.querySelector('td:first-child').textContent = index + 1;
            });
        }
        
        // تابع محاسبه جمع سند
        function calculateEntryTotals() {
            let totalDebit = 0;
            let totalCredit = 0;
            
            // به‌روزرسانی مقادیر در آرایه documentEntries
            documentEntries.forEach((entry, index) => {
                const debitInput = document.querySelector(`#entry-row-${entry.id} .entry-debit`);
                const creditInput = document.querySelector(`#entry-row-${entry.id} .entry-credit`);
                const descriptionInput = document.querySelector(`#entry-row-${entry.id} .entry-description`);
                const subsidiarySelect = document.querySelector(`#entry-row-${entry.id} .entry-subsidiary`);
                const detailSelect = document.querySelector(`#entry-detail-${entry.id}`);
                
                if (debitInput) {
                    entry.debit = parseAmount(debitInput.value);
                    totalDebit += entry.debit;
                }
                if (creditInput) {
                    entry.credit = parseAmount(creditInput.value);
                    totalCredit += entry.credit;
                }
                if (descriptionInput) {
                    entry.description = descriptionInput.value;
                }
                if (subsidiarySelect) {
                    entry.subsidiaryId = subsidiarySelect.value;
                }
                if (detailSelect) {
                    entry.detailId = detailSelect.value;
                }
            });
            
            totalDebitSpan.textContent = formatCurrency(totalDebit);
            totalCreditSpan.textContent = formatCurrency(totalCredit);
            
            // بررسی تراز بودن سند
            if (Math.abs(totalDebit - totalCredit) < 0.01) { // مقایسه با دقت 0.01
                saveEntryBtn.disabled = false;
            } else {
                saveEntryBtn.disabled = true;
            }
        }
        
        // تابع ذخیره سند حسابداری
        function saveDocument() {
            const date = entryDateInput.value;
            const description = entryDescriptionInput.value;
            
            if (!date) {
                showNotification('لطفاً تاریخ سند را وارد کنید!', 'error');
                return;
            }
            
            if (documentEntries.length === 0) {
                showNotification('لطفاً حداقل یک ردیف به سند اضافه کنید!', 'error');
                return;
            }
            
            // محاسبه جمع‌ها برای اطمینان از تراز بودن
            let totalDebit = 0;
            let totalCredit = 0;
            
            documentEntries.forEach(entry => {
                totalDebit += entry.debit;
                totalCredit += entry.credit;
            });
            
            if (Math.abs(totalDebit - totalCredit) > 0.01) {
                showNotification('سند تراز نیست! لطفاً جمع بدهکار و بستانکار را برابر کنید.', 'error');
                return;
            }
            
            const newDocument = {
                id: Date.now(),
                number: documentCounter++,
                date: date,
                description: description,
                entries: [...documentEntries],
                totalDebit: totalDebit,
                totalCredit: totalCredit
            };
            
            savedDocuments.push(newDocument);
            saveDocumentToDB(newDocument);
            saveDocumentCounter();
            showNotification(`سند شماره ${toPersianNumbers(newDocument.number)} با موفقیت ثبت شد!`, 'success');
            resetEntryForm();
            updateDocumentsList();
        }
        
        // تابع بازنشانی فرم ثبت سند
        function resetEntryForm() {
            entryDateInput.value = getTodayPersianDate();
            entryDescriptionInput.value = '';
            documentEntries = [];
            entryTableBody.innerHTML = '';
            totalDebitSpan.textContent = '0';
            totalCreditSpan.textContent = '0';
            saveEntryBtn.disabled = true;
        }
        
        // تابع به‌روزرسانی لیست اسناد
        function updateDocumentsList() {
            if (savedDocuments.length === 0) {
                documentsList.innerHTML = `<div class="empty-state"><i class="fas fa-file-alt"></i><p>هیچ سندی ثبت نشده است</p></div>`;
                return;
            }
            
            let html = '';
            savedDocuments.forEach(doc => {
                html += `<div class="document-item" data-id="${doc.id}">
                    <div class="document-info">
                        <div class="document-title">سند شماره ${toPersianNumbers(doc.number)} - ${doc.description || 'بدون شرح'}</div>
                        <div class="document-meta">
                            <div class="document-meta-item"><i class="fas fa-calendar"></i><span>تاریخ: ${doc.date}</span></div>
                            <div class="document-meta-item"><i class="fas fa-money-bill-wave"></i><span>مبلغ کل: ${formatCurrency(doc.totalDebit)} ریال</span></div>
                            <div class="document-meta-item"><i class="fas fa-list-ol"></i><span>تعداد ردیف: ${toPersianNumbers(doc.entries.length)}</span></div>
                        </div>
                    </div>
                    <div class="document-actions">
                        <button class="simple-btn simple-btn-info" onclick="viewDocument(${doc.id})"><i class="fas fa-eye"></i> مشاهده</button>
                        <button class="simple-btn simple-btn-danger" onclick="deleteDocument(${doc.id})"><i class="fas fa-trash"></i> حذف</button>
                    </div>
                </div>`;
            });
            documentsList.innerHTML = html;
        }
        
        // تابع به‌روزرسانی لیست فاکتورها
        function updateInvoicesList() {
            if (savedInvoices.length === 0) {
                invoicesList.innerHTML = `<div class="empty-state"><i class="fas fa-receipt"></i><p>هیچ فاکتوری ثبت نشده است</p></div>`;
                return;
            }
            
            let html = '';
            savedInvoices.forEach(invoice => {
                let totalAmount = 0;
                invoice.items.forEach(item => {
                    totalAmount += item.finalPrice;
                });
                
                html += `<div class="invoice-item" data-id="${invoice.id}">
                    <div class="invoice-info">
                        <div class="invoice-title">فاکتور شماره ${toPersianNumbers(invoice.number)} - ${invoice.partyName}</div>
                        <div class="invoice-meta">
                            <div class="invoice-meta-item"><i class="fas fa-calendar"></i><span>تاریخ: ${invoice.date}</span></div>
                            <div class="invoice-meta-item"><i class="fas fa-money-bill-wave"></i><span>مبلغ کل: ${formatCurrency(totalAmount)} ریال</span></div>
                            <div class="invoice-meta-item"><i class="fas fa-list-ol"></i><span>تعداد آیتم: ${toPersianNumbers(invoice.items.length)}</span></div>
                        </div>
                    </div>
                    <div class="invoice-actions-list">
                        <button class="simple-btn simple-btn-info" onclick="viewInvoice(${invoice.id})"><i class="fas fa-eye"></i> مشاهده</button>
                        <button class="simple-btn simple-btn-danger" onclick="deleteInvoiceFromList(${invoice.id})"><i class="fas fa-trash"></i> حذف</button>
                    </div>
                </div>`;
            });
            invoicesList.innerHTML = html;
        }
        
        // تابع مشاهده سند
        function viewDocument(documentId) {
            const doc = savedDocuments.find(d => d.id === documentId);
            if (!doc) {
                showNotification('سند مورد نظر یافت نشد!', 'error');
                return;
            }
            
            editingDocumentId = documentId;
            
            documentNumberSpan.textContent = toPersianNumbers(doc.number);
            documentDateSpan.textContent = doc.date;
            documentDescriptionSpan.textContent = doc.description || 'بدون شرح';
            
            // نمایش جزئیات سند
            let detailsHtml = '';
            doc.entries.forEach((entry, index) => {
                const subsidiary = accounts.find(acc => acc.id == entry.subsidiaryId);
                const detail = accounts.find(acc => acc.id == entry.detailId);
                
                detailsHtml += `<tr>
                    <td>${index + 1}</td>
                    <td>${subsidiary ? subsidiary.code : '---'}</td>
                    <td>${subsidiary ? subsidiary.name : '---'}</td>
                    <td>${detail ? detail.name : '---'}</td>
                    <td>${entry.description || '---'}</td>
                    <td>${formatCurrency(entry.debit)}</td>
                    <td>${formatCurrency(entry.credit)}</td>
                </tr>`;
            });
            
            documentDetailsBody.innerHTML = detailsHtml;
            documentTotalDebitSpan.textContent = formatCurrency(doc.totalDebit);
            documentTotalCreditSpan.textContent = formatCurrency(doc.totalCredit);
            
            // نمایش بخش جزئیات
            documentsList.classList.add('hidden');
            documentDetails.classList.remove('hidden');
        }
        
        // تابع مشاهده فاکتور
        function viewInvoice(invoiceId) {
            const invoice = savedInvoices.find(i => i.id == invoiceId);
            if (!invoice) {
                showNotification('فاکتور مورد نظر یافت نشد!', 'error');
                return;
            }
            
            viewingInvoiceId = invoiceId;
            
            invoiceViewNumberSpan.textContent = toPersianNumbers(invoice.number);
            
            // تولید محتوای فاکتور برای نمایش
            let itemsHtml = '';
            let totalAmount = 0;
            
            invoice.items.forEach((item, index) => {
                itemsHtml += `<tr>
                    <td>${index + 1}</td>
                    <td>${item.productCode || '---'}</td>
                    <td>${item.productName}</td>
                    <td>${toPersianNumbers(item.quantity)}</td>
                    <td>${item.unit}</td>
                    <td>${formatCurrency(item.unitPrice)}</td>
                    <td>${formatCurrency(item.totalPrice)}</td>
                    <td>${formatCurrency(item.discountAmount)}</td>
                    <td>${formatCurrency(item.totalPrice - item.discountAmount)}</td>
                    <td>${formatCurrency(item.taxAmount)}</td>
                    <td>${formatCurrency(item.finalPrice)}</td>
                </tr>`;
                totalAmount += item.finalPrice;
            });
            
            const paymentMethodText = invoice.paymentMethod === 'cash' ? 'نقدی' : 'غیر نقدی';
            
            const invoiceHtml = `
                <div class="invoice-info">
                    <p><strong>تاریخ:</strong> ${invoice.date}</p>
                    <p><strong>خریدار:</strong> ${invoice.partyName} (${invoice.partyType === 'legal' ? 'حقوقی' : 'حقیقی'})</p>
                    <p><strong>نحوه پرداخت:</strong> ${paymentMethodText}</p>
                </div>
                <table class="document-details-table">
                    <thead>
                        <tr>
                            <th>ردیف</th>
                            <th>کد کالا</th>
                            <th>شرح کالا/خدمات</th>
                            <th>مقدار</th>
                            <th>واحد</th>
                            <th>بهای واحد</th>
                            <th>بهای کل</th>
                            <th>مبلغ تخفیف</th>
                            <th>بهای کل پس از تخفیف</th>
                            <th>مالیات و عوارض</th>
                            <th>بهای کل بعلاوه مالیات و عوارض</th>
                        </tr>
                    </thead>
                    <tbody>${itemsHtml}</tbody>
                </table>
                <div class="entry-totals">
                    <div>جمع کل فاکتور: <strong>${formatCurrency(totalAmount)} ریال</strong></div>
                </div>
            `;
            
            invoiceDetailsContent.innerHTML = invoiceHtml;
            
            // نمایش بخش جزئیات فاکتور
            invoicesList.classList.add('hidden');
            invoiceDetails.classList.remove('hidden');
        }
        
        // تابع حذف سند
        function deleteDocument(documentId) {
            if (confirm('آیا از حذف این سند اطمینان دارید؟')) {
                savedDocuments = savedDocuments.filter(doc => doc.id !== documentId);
                deleteDocumentFromDB(documentId);
                updateDocumentsList();
                if (editingDocumentId === documentId) {
                    closeDocumentDetails();
                }
                showNotification('سند با موفقیت حذف شد!', 'success');
            }
        }
        
        // تابع حذف فاکتور از لیست
        function deleteInvoiceFromList(invoiceId) {
            if (confirm('آیا از حذف این فاکتور اطمینان دارید؟')) {
                savedInvoices = savedInvoices.filter(inv => inv.id !== invoiceId);
                deleteInvoiceFromDB(invoiceId);
                updateInvoicesList();
                if (viewingInvoiceId === invoiceId) {
                    closeInvoiceDetails();
                }
                showNotification('فاکتور با موفقیت حذف شد!', 'success');
            }
        }
        
        // تابع چاپ فاکتور از لیست
        function printInvoiceFromList(invoiceId) {
            const invoice = savedInvoices.find(i => i.id == invoiceId);
            if (!invoice) {
                showNotification('فاکتور مورد نظر یافت نشد!', 'error');
                return;
            }
            
            let itemsHtml = '';
            invoice.items.forEach((item, index) => {
                itemsHtml += `<tr>
                    <td>${index + 1}</td>
                    <td>${item.productCode || '---'}</td>
                    <td>${item.productName}</td>
                    <td>${toPersianNumbers(item.quantity)}</td>
                    <td>${item.unit}</td>
                    <td>${formatCurrency(item.unitPrice)}</td>
                    <td>${formatCurrency(item.totalPrice)}</td>
                    <td>${formatCurrency(item.discountAmount)}</td>
                    <td>${formatCurrency(item.totalPrice - item.discountAmount)}</td>
                    <td>${formatCurrency(item.taxAmount)}</td>
                    <td>${formatCurrency(item.finalPrice)}</td>
                </tr>`;
            });
            
            const paymentMethodText = invoice.paymentMethod === 'cash' ? 'نقدی' : 'غیر نقدی';
            let totalAmount = 0;
            invoice.items.forEach(item => totalAmount += item.finalPrice);
            
            const printContent = `
                <div class="invoice-connected-container">
                    <div class="invoice-connected-header">
                        <div class="invoice-connected-title">فاکتور فروش/خدمات</div>
                        <div class="invoice-connected-number">شماره فاکتور: ${toPersianNumbers(invoice.number)}</div>
                        <div class="invoice-connected-date">تاریخ: ${invoice.date}</div>
                    </div>
                    <div class="invoice-connected-details">
                        <div class="invoice-connected-seller">
                            <div class="invoice-connected-section-title">فروشنده</div>
                            <div class="invoice-connected-info-row"><div class="invoice-connected-info-label">نام:</div><div class="invoice-connected-info-value">${companyInfo.name || '---'}</div></div>
                            ${companyInfo.economicCode ? `<div class="invoice-connected-info-row"><div class="invoice-connected-info-label">کد اقتصادی:</div><div class="invoice-connected-info-value">${companyInfo.economicCode}</div></div>` : ''}
                            ${companyInfo.phone ? `<div class="invoice-connected-info-row"><div class="invoice-connected-info-label">تلفن:</div><div class="invoice-connected-info-value">${companyInfo.phone}</div></div>` : ''}
                        </div>
                        <div class="invoice-connected-buyer">
                            <div class="invoice-connected-section-title">خریدار</div>
                            <div class="invoice-connected-info-row"><div class="invoice-connected-info-label">نام:</div><div class="invoice-connected-info-value">${invoice.partyName}</div></div>
                            ${invoice.partyEconomicCode ? `<div class="invoice-connected-info-row"><div class="invoice-connected-info-label">کد اقتصادی:</div><div class="invoice-connected-info-value">${invoice.partyEconomicCode}</div></div>` : ''}
                            ${invoice.partyPhone ? `<div class="invoice-connected-info-row"><div class="invoice-connected-info-label">تلفن:</div><div class="invoice-connected-info-value">${invoice.partyPhone}</div></div>` : ''}
                        </div>
                    </div>
                    <table class="invoice-connected-table">
                        <thead>
                            <tr>
                                <th>ردیف</th>
                                <th>کد کالا</th>
                                <th>شرح کالا/خدمات</th>
                                <th>مقدار</th>
                                <th>واحد</th>
                                <th>بهای واحد</th>
                                <th>بهای کل</th>
                                <th>مبلغ تخفیف</th>
                                <th>بهای کل پس از تخفیف</th>
                                <th>مالیات و عوارض</th>
                                <th>بهای کل بعلاوه مالیات و عوارض</th>
                            </tr>
                        </thead>
                        <tbody>${itemsHtml}</tbody>
                    </table>
                    <div class="invoice-connected-summary">
                        <div class="invoice-connected-summary-row">
                            <div class="invoice-connected-summary-label invoice-summary-small-font">جمع تمامی ستون ها به عدد:</div>
                            <div class="invoice-connected-summary-value invoice-summary-small-font">${formatCurrency(totalAmount)} ریال</div>
                        </div>
                        <div class="invoice-connected-summary-row">
                            <div class="invoice-connected-summary-label invoice-summary-small-font">جمع تمامی ستون ها به حروف:</div>
                            <div class="invoice-connected-summary-value invoice-summary-small-font">${numberToWords(totalAmount)} ریال</div>
                        </div>
                        <div class="invoice-connected-summary-row">
                            <div class="invoice-connected-summary-label invoice-summary-small-font">نحوه پرداخت:</div>
                            <div class="invoice-connected-summary-value invoice-summary-small-font">
                                <span>نقدی ${paymentMethodText === 'نقدی' ? '☑' : '☐'}</span>
                                <span style="margin-right: 20px;">غیر نقدی ${paymentMethodText === 'غیر نقدی' ? '☑' : '☐'}</span>
                            </div>
                        </div>
                    </div>
                    <div class="invoice-connected-signatures">
                        <div class="invoice-connected-signature">
                            <div>مهر و امضای فروشنده</div>
                            <div class="invoice-connected-signature-line"></div>
                        </div>
                        <div class="invoice-connected-signature">
                            <div>مهر و امضای خریدار</div>
                            <div class="invoice-connected-signature-line"></div>
                        </div>
                    </div>
                </div>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`<!DOCTYPE html><html dir="rtl"><head><title>چاپ فاکتور شماره ${toPersianNumbers(invoice.number)}</title><style>body{font-family:'Vazirmatn','Vazir',Tahoma,sans-serif;direction:rtl;margin:20px;line-height:1.6}.invoice-connected-container{border:1px solid #000;padding:20px}.invoice-connected-header{text-align:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #000}.invoice-connected-title{font-size:1.5rem;font-weight:bold}.invoice-connected-table{width:100%;border-collapse:collapse;margin:0;font-size:0.7rem}.invoice-connected-table th,.invoice-connected-table td{border:1px solid #000;padding:6px;text-align:center}.invoice-connected-table th{background-color:#f0f0f0}.invoice-connected-summary{margin-top:0;background:rgba(0,0,0,0.05);border-radius:0 0 10px 10px;padding:15px;border:1px solid #000;border-top:none}.invoice-connected-summary-row{display:flex;justify-content:space-between;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid #000}.invoice-connected-summary-row:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}.invoice-connected-summary-label{font-weight:600;font-size:0.65rem}.invoice-connected-summary-value{font-weight:700;font-size:0.65rem}.invoice-connected-signatures{display:flex;justify-content:space-between;margin-top:40px}.invoice-connected-signature-line{border-top:1px solid #000;margin-top:40px;padding-top:5px}.invoice-connected-details{display:flex;justify-content:space-between;margin-bottom:0}.invoice-connected-seller,.invoice-connected-buyer{flex:1;padding:15px}.invoice-connected-seller{margin-left:0;border-bottom:none;border-radius:0 0 0 0}.invoice-connected-buyer{margin-right:0;border-bottom:none;border-radius:0 0 0 0}.invoice-connected-info-row{display:flex;margin-bottom:5px}.invoice-connected-info-label{font-weight:600;width:120px;font-size:0.7rem}.invoice-connected-info-value{flex:1;font-size:0.7rem}@media print{body{margin:0}.invoice-connected-container{border:none}}</style></head><body>${printContent}</body></html>`);
            printWindow.document.close();
            printWindow.print();
        }
        
        // تابع بستن جزئیات سند
        function closeDocumentDetails() {
            documentDetails.classList.add('hidden');
            documentsList.classList.remove('hidden');
            editingDocumentId = null;
        }
        
        // تابع بستن جزئیات فاکتور
        function closeInvoiceDetails() {
            invoiceDetails.classList.add('hidden');
            invoicesList.classList.remove('hidden');
            viewingInvoiceId = null;
        }
        
        // تابع صادر کردن داده‌ها به JSON
        function exportData() {
            const data = { 
                accounts, parties, inventory, invoices: savedInvoices, invoiceCounter, 
                documents: savedDocuments, documentCounter,
                fiscalPeriod, settings, companyInfo 
            };
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `MahrazSystem-backup-${dateStr}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showNotification('داده‌ها با موفقیت صادر شدند!', 'success');
        }
        
        // تابع وارد کردن داده‌ها از JSON
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (confirm('آیا از وارد کردن داده‌های جدید اطمینان دارید؟ داده‌های فعلی جایگزین خواهند شد.')) {
                        accounts = data.accounts || [];
                        parties = data.parties || [];
                        inventory = data.inventory || [];
                        savedInvoices = data.invoices || [];
                        invoiceCounter = data.invoiceCounter || 1;
                        savedDocuments = data.documents || [];
                        documentCounter = data.documentCounter || 1;
                        fiscalPeriod = data.fiscalPeriod || { startDate: '', endDate: '' };
                        settings = data.settings || { vatPercentage: 9 };
                        companyInfo = data.companyInfo || { type: 'legal', name: '', economicCode: '', nationalId: '', registrationNumber: '', phone: '', mobile: '', address: '', postalCode: '' };
                        
                        const promises = [];
                        promises.push(clearStore(STORE_NAMES.ACCOUNTS));
                        promises.push(clearStore(STORE_NAMES.PARTIES));
                        promises.push(clearStore(STORE_NAMES.INVENTORY));
                        promises.push(clearStore(STORE_NAMES.INVOICES));
                        promises.push(clearStore(STORE_NAMES.INVOICE_COUNTER));
                        promises.push(clearStore(STORE_NAMES.DOCUMENTS));
                        promises.push(clearStore(STORE_NAMES.DOCUMENT_COUNTER));
                        promises.push(clearStore(STORE_NAMES.FISCAL_PERIOD));
                        promises.push(clearStore(STORE_NAMES.SETTINGS));
                        promises.push(clearStore(STORE_NAMES.COMPANY_INFO));
                        
                        Promise.all(promises).then(() => {
                            const savePromises = [];
                            accounts.forEach(account => savePromises.push(saveAccount(account)));
                            parties.forEach(party => savePromises.push(saveParty(party)));
                            inventory.forEach(product => savePromises.push(saveProduct(product)));
                            savedInvoices.forEach(invoice => savePromises.push(saveInvoiceToDB(invoice)));
                            savePromises.push(saveInvoiceCounter());
                            savedDocuments.forEach(doc => savePromises.push(saveDocumentToDB(doc)));
                            savePromises.push(saveDocumentCounter());
                            savePromises.push(saveFiscalPeriodToDB());
                            savePromises.push(saveSettingsToDB());
                            savePromises.push(saveCompanyInfoToDB());
                            
                            Promise.all(savePromises).then(() => {
                                updatePartiesList();
                                updateCompanyInfo();
                                updateInventoryList();
                                updateInvoicePartySelect();
                                updateInvoiceProductSelect();
                                updateAccountingTree();
                                updateDocumentsList();
                                updateInvoicesList();
                                fiscalPeriodStart.value = fiscalPeriod.startDate || '';
                                fiscalPeriodEnd.value = fiscalPeriod.endDate || '';
                                showNotification('داده‌ها با موفقیت وارد شدند!', 'success');
                            });
                        });
                    }
                } catch (error) {
                    console.error('خطا در وارد کردن داده‌ها:', error);
                    showNotification('خطا در وارد کردن فایل! لطفاً از صحت فایل اطمینان حاصل کنید.', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        // تابع پاک کردن یک store از IndexedDB
        function clearStore(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = () => reject(new Error(`خطا در پاک کردن ${storeName}`));
            });
        }
        
        // تابع بازنشانی داده‌ها
        function resetData() {
            if (confirm('آیا از بازنشانی تمام داده‌ها اطمینان دارید؟ این عمل غیرقابل بازگشت است!')) {
                accounts = [];
                parties = [];
                inventory = [];
                savedInvoices = [];
                invoiceCounter = 1;
                savedDocuments = [];
                documentCounter = 1;
                fiscalPeriod = { startDate: '', endDate: '' };
                settings = { vatPercentage: 9 };
                companyInfo = { type: 'legal', name: '', economicCode: '', nationalId: '', registrationNumber: '', phone: '', mobile: '', address: '', postalCode: '' };
                
                const promises = [
                    clearStore(STORE_NAMES.ACCOUNTS), clearStore(STORE_NAMES.PARTIES), clearStore(STORE_NAMES.INVENTORY),
                    clearStore(STORE_NAMES.INVOICES), clearStore(STORE_NAMES.INVOICE_COUNTER), clearStore(STORE_NAMES.DOCUMENTS),
                    clearStore(STORE_NAMES.DOCUMENT_COUNTER), clearStore(STORE_NAMES.FISCAL_PERIOD),
                    clearStore(STORE_NAMES.SETTINGS), clearStore(STORE_NAMES.COMPANY_INFO)
                ];
                
                Promise.all(promises).then(() => {
                    createStandardAccountingStructure().then(() => {
                        updatePartiesList();
                        updateCompanyInfo();
                        updateInventoryList();
                        updateInvoicePartySelect();
                        updateInvoiceProductSelect();
                        updateAccountingTree();
                        updateDocumentsList();
                        updateInvoicesList();
                        fiscalPeriodStart.value = '';
                        fiscalPeriodEnd.value = '';
                        showNotification('تمامی داده‌ها با موفقیت بازنشانی شدند!', 'success');
                    });
                });
            }
        }
        
        // تابع ذخیره دوره مالی
        function saveFiscalPeriod() {
            const startDate = fiscalPeriodStart.value;
            const endDate = fiscalPeriodEnd.value;
            
            if (!startDate || !endDate) {
                showNotification('لطفاً تاریخ شروع و پایان دوره مالی را وارد کنید!', 'error');
                return;
            }
            
            fiscalPeriod = { startDate: startDate, endDate: endDate };
            saveFiscalPeriodToDB();
            showNotification('دوره مالی با موفقیت ذخیره شد!', 'success');
        }
        
        // تابع ایجاد ساختار استاندارد حسابداری ایران
        function createStandardAccountingStructure() {
            return new Promise((resolve, reject) => {
                // ساختار استاندارد حسابداری ایران با نام‌های سطح‌بندی شده
                const standardAccounts = [
                    // سطح ۱: گروه دارایی‌ها
                    { id: 1, code: '1', name: 'دارایی‌ها', level: 'group', parentId: null },
                    
                    // سطح ۲: کل دارایی‌های جاری
                    { id: 2, code: '11', name: 'دارایی‌های جاری', level: 'class', parentId: 1 },
                    
                    // سطح ۳: معین موجودی نقد و بانک
                    { id: 3, code: '111', name: 'موجودی نقد و بانک', level: 'subsidiary', parentId: 2 },
                    
                    // سطح ۴: تفضیل موجودی نقد و بانک
                    { id: 4, code: '1111', name: 'تنخواه گردان', level: 'detail', parentId: 3 },
                    { id: 5, code: '1112', name: 'صندوق', level: 'detail', parentId: 3 },
                    { id: 6, code: '1113', name: 'بانک', level: 'detail', parentId: 3 },
                    
                    // سطح ۳: معین حساب های دریافتنی
                    { id: 7, code: '112', name: 'حساب های دریافتنی', level: 'subsidiary', parentId: 2 },
                    
                    // سطح ۴: تفضیل حساب های دریافتنی
                    { id: 8, code: '1121', name: 'حساب های دریافتنی', level: 'detail', parentId: 7 },
                    { id: 9, code: '1122', name: 'اسناد دریافتنی', level: 'detail', parentId: 7 },
                    
                    // سطح ۲: کل دارایی‌های غیر جاری
                    { id: 10, code: '12', name: 'دارایی‌های غیر جاری', level: 'class', parentId: 1 },
                    
                    // سطح ۳: معین دارایی های ثابت
                    { id: 11, code: '121', name: 'دارایی های ثابت', level: 'subsidiary', parentId: 10 },
                    
                    // سطح ۴: تفضیل دارایی های ثابت
                    { id: 12, code: '1211', name: 'زمین', level: 'detail', parentId: 11 },
                    { id: 13, code: '1212', name: 'ساختمان', level: 'detail', parentId: 11 },
                    { id: 14, code: '1213', name: 'وسائط نقلیه', level: 'detail', parentId: 11 },
                    
                    // سطح ۱: گروه بدهی‌ها
                    { id: 15, code: '2', name: 'بدهی‌ها', level: 'group', parentId: null },
                    
                    // سطح ۲: کل بدهی‌های جاری
                    { id: 16, code: '21', name: 'بدهی‌های جاری', level: 'class', parentId: 15 },
                    
                    // سطح ۳: معین حساب ها و اسناد پرداختنی
                    { id: 17, code: '211', name: 'حساب ها و اسناد پرداختنی', level: 'subsidiary', parentId: 16 },
                    
                    // سطح ۴: تفضیل حساب ها و اسناد پرداختنی
                    { id: 18, code: '2111', name: 'حساب های پرداختنی', level: 'detail', parentId: 17 },
                    { id: 19, code: '2112', name: 'اسناد پرداختنی', level: 'detail', parentId: 17 },
                    
                    // سطح ۱: گروه حقوق صاحبان سهام
                    { id: 20, code: '3', name: 'حقوق صاحبان سهام', level: 'group', parentId: null },
                    
                    // سطح ۳: معین سرمایه اولیه
                    { id: 21, code: '31', name: 'سرمایه اولیه', level: 'subsidiary', parentId: 20 },
                    
                    // سطح ۱: گروه بهای تمام شده کالای فروخته شده
                    { id: 22, code: '4', name: 'بهای تمام شده کالای فروخته شده', level: 'group', parentId: null },
                    
                    // سطح ۳: معین بهای تمام شده کالای فروخته شده
                    { id: 23, code: '41', name: 'بهای تمام شده کالای فروخته شده', level: 'subsidiary', parentId: 22 },
                    
                    // سطح ۱: گروه فروش
                    { id: 24, code: '5', name: 'فروش', level: 'group', parentId: null },
                    
                    // سطح ۳: معین فروش کالا
                    { id: 25, code: '51', name: 'فروش کالا', level: 'subsidiary', parentId: 24 },
                    
                    // سطح ۱: گروه درآمد
                    { id: 26, code: '6', name: 'درآمد', level: 'group', parentId: null },
                    
                    // سطح ۲: کل درآمد های عملیاتی
                    { id: 27, code: '61', name: 'درآمد های عملیاتی', level: 'class', parentId: 26 },
                    
                    // سطح ۳: معین درآمد حاصل از فروش خدمات
                    { id: 28, code: '611', name: 'درآمد حاصل از فروش خدمات', level: 'subsidiary', parentId: 27 },
                    
                    // سطح ۱: گروه هزینه ها
                    { id: 29, code: '7', name: 'هزینه ها', level: 'group', parentId: null },
                    
                    // سطح ۲: کل هزینه های پرسنلی
                    { id: 30, code: '71', name: 'هزینه های پرسنلی', level: 'class', parentId: 29 },
                    
                    // سطح ۳: معین هزینه حقوق و دستمزد
                    { id: 31, code: '711', name: 'هزینه حقوق و دستمزد', level: 'subsidiary', parentId: 30 },
                    
                    // سطح ۴: تفضیل هزینه حقوق و دستمزد
                    { id: 32, code: '7111', name: 'حقوق پایه', level: 'detail', parentId: 31 },
                    { id: 33, code: '7112', name: 'اضافه کار', level: 'detail', parentId: 31 },
                    
                    // سطح ۲: کل هزینه های عملیاتی
                    { id: 34, code: '72', name: 'هزینه های عملیاتی', level: 'class', parentId: 29 },
                    
                    // سطح ۳: معین هزینه های عمومی
                    { id: 35, code: '721', name: 'هزینه های عمومی', level: 'subsidiary', parentId: 34 },
                    
                    // سطح ۴: تفضیل هزینه های عمومی
                    { id: 36, code: '7211', name: 'هزینه آب و برق و گاز و تلفن', level: 'detail', parentId: 35 },
                    { id: 37, code: '7212', name: 'هزینه پذیرایی و آبدارخانه', level: 'detail', parentId: 35 }
                ];
                
                accounts = standardAccounts;
                
                const transaction = db.transaction([STORE_NAMES.ACCOUNTS], 'readwrite');
                const store = transaction.objectStore(STORE_NAMES.ACCOUNTS);
                
                standardAccounts.forEach(account => {
                    store.put(account);
                });
                
                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject(new Error('خطا در ایجاد ساختار استاندارد حسابداری'));
            });
        }
        
        // تابع به‌روزرسانی درخت حسابداری
        function updateAccountingTree() {
            const accountingTree = document.getElementById('accounting-tree');
            
            if (accounts.length === 0) {
                accountingTree.innerHTML = `<div class="empty-state"><i class="fas fa-sitemap"></i><p>هیچ حسابی برای نمایش وجود ندارد</p></div>`;
                return;
            }
            
            let html = '';
            
            // سطح ۱: گروه‌ها
            const groups = accounts.filter(account => account.level === 'group');
            
            groups.forEach(group => {
                // سطح ۲: کلاس‌های این گروه
                const classes = accounts.filter(account => account.parentId === group.id);
                
                html += `<div class="tree-node level-1">
                    <div class="tree-node-header" onclick="toggleTreeNode(this)">
                        <i class="fas fa-chevron-right tree-node-icon"></i>
                        <span class="account-code">${group.code}</span>
                        <span class="account-name">${group.name} (سطح ۱)</span>
                    </div>
                    <div class="tree-node-content">`;
                
                classes.forEach(cls => {
                    // سطح ۳: معین‌های این کلاس
                    const subsidiaries = accounts.filter(account => account.parentId === cls.id);
                    
                    html += `<div class="tree-node level-2">
                        <div class="tree-node-header" onclick="toggleTreeNode(this)">
                            <i class="fas fa-chevron-right tree-node-icon"></i>
                            <span class="account-code">${cls.code}</span>
                            <span class="account-name">${cls.name} (سطح ۲)</span>
                        </div>
                        <div class="tree-node-content">`;
                    
                    subsidiaries.forEach(subsidiary => {
                        // سطح ۴: تفضیل‌های این معین
                        const details = accounts.filter(account => account.parentId === subsidiary.id);
                        
                        html += `<div class="tree-node level-3">
                            <div class="tree-node-header" onclick="toggleTreeNode(this)">
                                <i class="fas fa-chevron-right tree-node-icon"></i>
                                <span class="account-code">${subsidiary.code}</span>
                                <span class="account-name">${subsidiary.name} (سطح ۳)</span>
                            </div>
                            <div class="tree-node-content">`;
                        
                        details.forEach(detail => {
                            html += `<div class="tree-node level-4">
                                <div class="tree-node-header">
                                    <span class="account-code">${detail.code}</span>
                                    <span class="account-name">${detail.name} (سطح ۴)</span>
                                </div>
                            </div>`;
                        });
                        
                        html += `</div></div>`;
                    });
                    
                    html += `</div></div>`;
                });
                
                html += `</div></div>`;
            });
            
            accountingTree.innerHTML = html;
        }
        
        // تابع باز و بسته کردن گره‌های درخت
        function toggleTreeNode(element) {
            const content = element.nextElementSibling;
            const icon = element.querySelector('.tree-node-icon');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                icon.classList.remove('rotated');
            } else {
                content.classList.add('active');
                icon.classList.add('rotated');
            }
        }
    </script>
</body>
</html>
